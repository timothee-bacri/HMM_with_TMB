<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Confidence intervals | Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Confidence intervals | Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Confidence intervals | Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Timothée Bacri timothee.bacri@uib.no" />
<meta name="author" content="Jan Bulla jan.bulla@uib.no" />
<meta name="author" content="Geir Berentsen geir.berentsen@nhh.no" />


<meta name="date" content="2021-05-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="using-tmb.html"/>
<link rel="next" href="references.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Summary</a></li>
<li class="chapter" data-level="1" data-path="state-inf.html"><a href="state-inf.html"><i class="fa fa-check"></i><b>1</b> State inference</a>
<ul>
<li class="chapter" data-level="1.1" data-path="state-inf.html"><a href="state-inf.html#prepare-the-model"><i class="fa fa-check"></i><b>1.1</b> Prepare the model</a></li>
<li class="chapter" data-level="1.2" data-path="state-inf.html"><a href="state-inf.html#setup"><i class="fa fa-check"></i><b>1.2</b> Setup</a></li>
<li class="chapter" data-level="1.3" data-path="state-inf.html"><a href="state-inf.html#log-forward"><i class="fa fa-check"></i><b>1.3</b> Log-forward probabilities</a></li>
<li class="chapter" data-level="1.4" data-path="state-inf.html"><a href="state-inf.html#log-backward"><i class="fa fa-check"></i><b>1.4</b> Log-backward probabilities</a></li>
<li class="chapter" data-level="1.5" data-path="state-inf.html"><a href="state-inf.html#local-decoding"><i class="fa fa-check"></i><b>1.5</b> Smoothing probabilities and local decoding</a></li>
<li class="chapter" data-level="1.6" data-path="state-inf.html"><a href="state-inf.html#forecast"><i class="fa fa-check"></i><b>1.6</b> Forecast, h-step-ahead-probabilities</a></li>
<li class="chapter" data-level="1.7" data-path="state-inf.html"><a href="state-inf.html#global-decoding"><i class="fa fa-check"></i><b>1.7</b> Global decoding using the Viterbi algorithm</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><i class="fa fa-check"></i><b>2</b> Principles of using <tt>TMB</tt> for Maximum Likelihood Estimation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#setting-up-tmb"><i class="fa fa-check"></i><b>2.1</b> Setting up <tt>TMB</tt></a></li>
<li class="chapter" data-level="2.2" data-path="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#getting-started-with-a-linear-regression"><i class="fa fa-check"></i><b>2.2</b> Getting started with a linear regression</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="methods.html"><a href="methods.html"><i class="fa fa-check"></i><b>3</b> Methods</a></li>
<li class="chapter" data-level="4" data-path="using-tmb.html"><a href="using-tmb.html"><i class="fa fa-check"></i><b>4</b> Using TMB</a>
<ul>
<li class="chapter" data-level="4.1" data-path="using-tmb.html"><a href="using-tmb.html#likelihood-function"><i class="fa fa-check"></i><b>4.1</b> Likelihood function</a></li>
<li class="chapter" data-level="4.2" data-path="using-tmb.html"><a href="using-tmb.html#preparing-data-and-functions"><i class="fa fa-check"></i><b>4.2</b> Preparing data and functions</a></li>
<li class="chapter" data-level="4.3" data-path="using-tmb.html"><a href="using-tmb.html#modeling"><i class="fa fa-check"></i><b>4.3</b> Modeling</a></li>
<li class="chapter" data-level="4.4" data-path="using-tmb.html"><a href="using-tmb.html#nested-models"><i class="fa fa-check"></i><b>4.4</b> Nested models</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="confidence-intervals.html"><a href="confidence-intervals.html"><i class="fa fa-check"></i><b>5</b> Confidence intervals</a>
<ul>
<li class="chapter" data-level="5.1" data-path="confidence-intervals.html"><a href="confidence-intervals.html#generating-data"><i class="fa fa-check"></i><b>5.1</b> Generating data</a></li>
<li class="chapter" data-level="5.2" data-path="confidence-intervals.html"><a href="confidence-intervals.html#relabeling-hmm-states"><i class="fa fa-check"></i><b>5.2</b> Relabeling HMM states</a></li>
<li class="chapter" data-level="5.3" data-path="confidence-intervals.html"><a href="confidence-intervals.html#bootstrap-code"><i class="fa fa-check"></i><b>5.3</b> Bootstrap code</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="chapter" data-level="6" data-path="main-github-page.html"><a href="main-github-page.html"><i class="fa fa-check"></i><b>6</b> Main GitHub page</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="confidence-intervals" class="section level1" number="5">
<h1><span class="header-section-number">Chapter 5</span> Confidence intervals</h1>
<p>From the parameters’ ML estimates, we generate new data and re-estimate the parameters  times.
From that list of new estimates we can get the 2.5th and 97.5th percentiles and get 95% confidence intervals for the parameters.\</p>
<p>We show below how we get confidence intervals using bootstrap, based on the 2 state Poisson HMM estimates from above.</p>
<div id="generating-data" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Generating data</h2>
<p>First, we need a function to generate random data from a HMM.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="confidence-intervals.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a random sample from a HMM</span></span>
<span id="cb1-2"><a href="confidence-intervals.html#cb1-2" aria-hidden="true" tabindex="-1"></a>pois.HMM.generate_sample  <span class="ot">&lt;-</span> <span class="cf">function</span>(ns, mod) {</span>
<span id="cb1-3"><a href="confidence-intervals.html#cb1-3" aria-hidden="true" tabindex="-1"></a>  mvect <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m</span>
<span id="cb1-4"><a href="confidence-intervals.html#cb1-4" aria-hidden="true" tabindex="-1"></a>  state <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ns)</span>
<span id="cb1-5"><a href="confidence-intervals.html#cb1-5" aria-hidden="true" tabindex="-1"></a>  state[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">sample</span>(mvect, <span class="dv">1</span>, <span class="at">prob =</span> mod<span class="sc">$</span>delta)</span>
<span id="cb1-6"><a href="confidence-intervals.html#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>ns) {</span>
<span id="cb1-7"><a href="confidence-intervals.html#cb1-7" aria-hidden="true" tabindex="-1"></a>    state[i] <span class="ot">&lt;-</span> <span class="fu">sample</span>(mvect, <span class="dv">1</span>, <span class="at">prob =</span> mod<span class="sc">$</span>gamma[state[i <span class="sc">-</span> <span class="dv">1</span>], ])</span>
<span id="cb1-8"><a href="confidence-intervals.html#cb1-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-9"><a href="confidence-intervals.html#cb1-9" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rpois</span>(ns, <span class="at">lambda =</span> mod<span class="sc">$</span>lambda[state])</span>
<span id="cb1-10"><a href="confidence-intervals.html#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">data =</span> x, <span class="at">state =</span> state))</span>
<span id="cb1-11"><a href="confidence-intervals.html#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>In practice, it happens that HMMs cannot be estimated on generated samples. To deal with this issue, we can generate a new sample as long as HMMs cannot be estimated on it with the help of this more robust function which can easily be adapted to different needs.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="confidence-intervals.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a random sample from a HMM</span></span>
<span id="cb2-2"><a href="confidence-intervals.html#cb2-2" aria-hidden="true" tabindex="-1"></a>pois.HMM.generate_estimable_sample <span class="ot">&lt;-</span> <span class="cf">function</span>(ns, mod, testing_params, <span class="at">params_names =</span> PARAMS_NAMES, <span class="at">test_marqLevAlg =</span> <span class="cn">FALSE</span>, <span class="at">std_error =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb2-3"><a href="confidence-intervals.html#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">anyNA</span>(<span class="fu">c</span>(ns, mod, testing_params))) {</span>
<span id="cb2-4"><a href="confidence-intervals.html#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Some parameters are missing in pois.HMM.generate_estimable_sample&quot;</span>)</span>
<span id="cb2-5"><a href="confidence-intervals.html#cb2-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-6"><a href="confidence-intervals.html#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop as long as there is an issue with nlminb</span></span>
<span id="cb2-7"><a href="confidence-intervals.html#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">repeat</span> {</span>
<span id="cb2-8"><a href="confidence-intervals.html#cb2-8" aria-hidden="true" tabindex="-1"></a>    mod_temp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb2-9"><a href="confidence-intervals.html#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#simulate the data</span></span>
<span id="cb2-10"><a href="confidence-intervals.html#cb2-10" aria-hidden="true" tabindex="-1"></a>    new_data <span class="ot">&lt;-</span> <span class="fu">pois.HMM.generate_sample</span>(<span class="at">ns =</span> ns,</span>
<span id="cb2-11"><a href="confidence-intervals.html#cb2-11" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">mod =</span> mod)</span>
<span id="cb2-12"><a href="confidence-intervals.html#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="confidence-intervals.html#cb2-13" aria-hidden="true" tabindex="-1"></a>    TMB_benchmark_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> new_data<span class="sc">$</span>data, <span class="at">m =</span> mod<span class="sc">$</span>m)</span>
<span id="cb2-14"><a href="confidence-intervals.html#cb2-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-15"><a href="confidence-intervals.html#cb2-15" aria-hidden="true" tabindex="-1"></a>    testing_w_params <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(<span class="at">m =</span> mod<span class="sc">$</span>m, <span class="at">lambda =</span> testing_params<span class="sc">$</span>lambda, <span class="at">gamma =</span> testing_params<span class="sc">$</span>gamma, <span class="at">delta =</span> testing_params<span class="sc">$</span>delta)</span>
<span id="cb2-16"><a href="confidence-intervals.html#cb2-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-17"><a href="confidence-intervals.html#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test TMB</span></span>
<span id="cb2-18"><a href="confidence-intervals.html#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(mod_temp <span class="ot">&lt;-</span> <span class="fu">TMB.estimate</span>(<span class="at">TMB_data =</span> TMB_benchmark_data,</span>
<span id="cb2-19"><a href="confidence-intervals.html#cb2-19" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">parameters =</span> testing_w_params,</span>
<span id="cb2-20"><a href="confidence-intervals.html#cb2-20" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">std_error =</span> std_error))</span>
<span id="cb2-21"><a href="confidence-intervals.html#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If nlminb doesn&#39;t reach any result, retry</span></span>
<span id="cb2-22"><a href="confidence-intervals.html#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(mod_temp)) {</span>
<span id="cb2-23"><a href="confidence-intervals.html#cb2-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb2-24"><a href="confidence-intervals.html#cb2-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-25"><a href="confidence-intervals.html#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If nlminb doesn&#39;t converge successfully, retry</span></span>
<span id="cb2-26"><a href="confidence-intervals.html#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (mod_temp<span class="sc">$</span>convergence <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb2-27"><a href="confidence-intervals.html#cb2-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb2-28"><a href="confidence-intervals.html#cb2-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-29"><a href="confidence-intervals.html#cb2-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-30"><a href="confidence-intervals.html#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test TMB_G</span></span>
<span id="cb2-31"><a href="confidence-intervals.html#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(mod_temp <span class="ot">&lt;-</span> <span class="fu">TMB.estimate</span>(<span class="at">TMB_data =</span> TMB_benchmark_data,</span>
<span id="cb2-32"><a href="confidence-intervals.html#cb2-32" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">parameters =</span> testing_w_params,</span>
<span id="cb2-33"><a href="confidence-intervals.html#cb2-33" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">gradient =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-34"><a href="confidence-intervals.html#cb2-34" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">std_error =</span> std_error))</span>
<span id="cb2-35"><a href="confidence-intervals.html#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If nlminb doesn&#39;t reach any result, retry</span></span>
<span id="cb2-36"><a href="confidence-intervals.html#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(mod_temp)) {</span>
<span id="cb2-37"><a href="confidence-intervals.html#cb2-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb2-38"><a href="confidence-intervals.html#cb2-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-39"><a href="confidence-intervals.html#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If nlminb doesn&#39;t converge successfully, retry</span></span>
<span id="cb2-40"><a href="confidence-intervals.html#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (mod_temp<span class="sc">$</span>convergence <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb2-41"><a href="confidence-intervals.html#cb2-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb2-42"><a href="confidence-intervals.html#cb2-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-43"><a href="confidence-intervals.html#cb2-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-44"><a href="confidence-intervals.html#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test TMB_H</span></span>
<span id="cb2-45"><a href="confidence-intervals.html#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(mod_temp <span class="ot">&lt;-</span> <span class="fu">TMB.estimate</span>(<span class="at">TMB_data =</span> TMB_benchmark_data,</span>
<span id="cb2-46"><a href="confidence-intervals.html#cb2-46" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">parameters =</span> testing_w_params,</span>
<span id="cb2-47"><a href="confidence-intervals.html#cb2-47" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">hessian =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-48"><a href="confidence-intervals.html#cb2-48" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">std_error =</span> std_error))</span>
<span id="cb2-49"><a href="confidence-intervals.html#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If nlminb doesn&#39;t reach any result, retry</span></span>
<span id="cb2-50"><a href="confidence-intervals.html#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(mod_temp)) {</span>
<span id="cb2-51"><a href="confidence-intervals.html#cb2-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb2-52"><a href="confidence-intervals.html#cb2-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-53"><a href="confidence-intervals.html#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If nlminb doesn&#39;t converge successfully, retry</span></span>
<span id="cb2-54"><a href="confidence-intervals.html#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (mod_temp<span class="sc">$</span>convergence <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb2-55"><a href="confidence-intervals.html#cb2-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb2-56"><a href="confidence-intervals.html#cb2-56" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-57"><a href="confidence-intervals.html#cb2-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-58"><a href="confidence-intervals.html#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test TMB_GH</span></span>
<span id="cb2-59"><a href="confidence-intervals.html#cb2-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressWarnings</span>(mod_temp <span class="ot">&lt;-</span> <span class="fu">TMB.estimate</span>(<span class="at">TMB_data =</span> TMB_benchmark_data,</span>
<span id="cb2-60"><a href="confidence-intervals.html#cb2-60" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">parameters =</span> testing_w_params,</span>
<span id="cb2-61"><a href="confidence-intervals.html#cb2-61" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">gradient =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-62"><a href="confidence-intervals.html#cb2-62" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">hessian =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-63"><a href="confidence-intervals.html#cb2-63" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">std_error =</span> std_error))</span>
<span id="cb2-64"><a href="confidence-intervals.html#cb2-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If nlminb doesn&#39;t reach any result, retry</span></span>
<span id="cb2-65"><a href="confidence-intervals.html#cb2-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(mod_temp)) {</span>
<span id="cb2-66"><a href="confidence-intervals.html#cb2-66" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb2-67"><a href="confidence-intervals.html#cb2-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-68"><a href="confidence-intervals.html#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If nlminb doesn&#39;t converge successfully, retry</span></span>
<span id="cb2-69"><a href="confidence-intervals.html#cb2-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (mod_temp<span class="sc">$</span>convergence <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb2-70"><a href="confidence-intervals.html#cb2-70" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb2-71"><a href="confidence-intervals.html#cb2-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-72"><a href="confidence-intervals.html#cb2-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-73"><a href="confidence-intervals.html#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test marqLevAlg</span></span>
<span id="cb2-74"><a href="confidence-intervals.html#cb2-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># marqLevAlg sometimes doesn&#39;t converge either</span></span>
<span id="cb2-75"><a href="confidence-intervals.html#cb2-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (test_marqLevAlg <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb2-76"><a href="confidence-intervals.html#cb2-76" aria-hidden="true" tabindex="-1"></a>      testing_w_params <span class="ot">&lt;-</span> <span class="fu">unlist</span>(testing_w_params)</span>
<span id="cb2-77"><a href="confidence-intervals.html#cb2-77" aria-hidden="true" tabindex="-1"></a>      <span class="co"># No need to spend a few seconds to compute the marqLevAlg optimization if it&#39;s unnecessary</span></span>
<span id="cb2-78"><a href="confidence-intervals.html#cb2-78" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">marqLevAlg</span>(<span class="at">b =</span> testing_w_params, <span class="at">fn =</span> mod_temp<span class="sc">$</span>obj<span class="sc">$</span>fn, <span class="at">gr =</span> mod_temp<span class="sc">$</span>obj<span class="sc">$</span>gr, <span class="at">hess =</span> mod_temp<span class="sc">$</span>obj<span class="sc">$</span>he, <span class="at">maxiter =</span> <span class="dv">10000</span>)<span class="sc">$</span>istop <span class="sc">!=</span> <span class="dv">1</span>) {</span>
<span id="cb2-79"><a href="confidence-intervals.html#cb2-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb2-80"><a href="confidence-intervals.html#cb2-80" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-81"><a href="confidence-intervals.html#cb2-81" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-82"><a href="confidence-intervals.html#cb2-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-83"><a href="confidence-intervals.html#cb2-83" aria-hidden="true" tabindex="-1"></a>    l <span class="ot">&lt;-</span> mod_temp<span class="sc">$</span>lambda</span>
<span id="cb2-84"><a href="confidence-intervals.html#cb2-84" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> mod_temp<span class="sc">$</span>gamma</span>
<span id="cb2-85"><a href="confidence-intervals.html#cb2-85" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> mod_temp<span class="sc">$</span>delta</span>
<span id="cb2-86"><a href="confidence-intervals.html#cb2-86" aria-hidden="true" tabindex="-1"></a>    l_se <span class="ot">&lt;-</span> mod_temp<span class="sc">$</span>lambda_std_error</span>
<span id="cb2-87"><a href="confidence-intervals.html#cb2-87" aria-hidden="true" tabindex="-1"></a>    g_se <span class="ot">&lt;-</span> mod_temp<span class="sc">$</span>gamma_std_error</span>
<span id="cb2-88"><a href="confidence-intervals.html#cb2-88" aria-hidden="true" tabindex="-1"></a>    d_se <span class="ot">&lt;-</span> mod_temp<span class="sc">$</span>delta_std_error</span>
<span id="cb2-89"><a href="confidence-intervals.html#cb2-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-90"><a href="confidence-intervals.html#cb2-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Label switching</span></span>
<span id="cb2-91"><a href="confidence-intervals.html#cb2-91" aria-hidden="true" tabindex="-1"></a>    natural_parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.label.order</span>(m, <span class="at">lambda =</span> l,</span>
<span id="cb2-92"><a href="confidence-intervals.html#cb2-92" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">gamma =</span> g, <span class="at">delta =</span> d,</span>
<span id="cb2-93"><a href="confidence-intervals.html#cb2-93" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">lambda_std_error =</span> l_se,</span>
<span id="cb2-94"><a href="confidence-intervals.html#cb2-94" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">gamma_std_error =</span> g_se,</span>
<span id="cb2-95"><a href="confidence-intervals.html#cb2-95" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">delta_std_error =</span> d_se)</span>
<span id="cb2-96"><a href="confidence-intervals.html#cb2-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-97"><a href="confidence-intervals.html#cb2-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If some parameters are NA for some reason, retry</span></span>
<span id="cb2-98"><a href="confidence-intervals.html#cb2-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">anyNA</span>(natural_parameters[params_names], <span class="at">recursive =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb2-99"><a href="confidence-intervals.html#cb2-99" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb2-100"><a href="confidence-intervals.html#cb2-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-101"><a href="confidence-intervals.html#cb2-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-102"><a href="confidence-intervals.html#cb2-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If everything went well, end the &quot;repeat&quot; loop</span></span>
<span id="cb2-103"><a href="confidence-intervals.html#cb2-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb2-104"><a href="confidence-intervals.html#cb2-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-105"><a href="confidence-intervals.html#cb2-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(<span class="at">data =</span> <span class="fu">list</span>(new_data<span class="sc">$</span>data), <span class="at">natural_parameters =</span> <span class="fu">list</span>(natural_parameters), <span class="at">mod =</span> <span class="fu">list</span>(mod_temp)))</span>
<span id="cb2-106"><a href="confidence-intervals.html#cb2-106" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="relabeling-hmm-states" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Relabeling HMM states</h2>
<ul>
<li>When the model is estimated each time, we don’t impose by default an order for the states.<br />
This can lead to the label switching problem, where states aren’t ordered the same way in each model.
To address this, we re-ordered the states by ascending Poisson means.
Sorting the means is direct, however re-ordering the TPM is not as straightforward.
To do so, we take the permutations of the states given by the sorted Poisson means, and permute each row index and column index to its new value.
A function to achieve this is</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="confidence-intervals.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Relabel states by increasing Poisson means</span></span>
<span id="cb3-2"><a href="confidence-intervals.html#cb3-2" aria-hidden="true" tabindex="-1"></a>pois.HMM.label.order <span class="ot">&lt;-</span> <span class="cf">function</span>(m, lambda, gamma, <span class="at">delta =</span> <span class="cn">NULL</span>, <span class="at">lambda_std_error =</span> <span class="cn">NULL</span>, <span class="at">gamma_std_error =</span> <span class="cn">NULL</span>, <span class="at">delta_std_error =</span> <span class="cn">NULL</span>) {</span>
<span id="cb3-3"><a href="confidence-intervals.html#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the indexes of the sorted states</span></span>
<span id="cb3-4"><a href="confidence-intervals.html#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># according to ascending lambda</span></span>
<span id="cb3-5"><a href="confidence-intervals.html#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sorted_lambda contains the permutations needed</span></span>
<span id="cb3-6"><a href="confidence-intervals.html#cb3-6" aria-hidden="true" tabindex="-1"></a>  sorted_lambda <span class="ot">&lt;-</span> <span class="fu">sort</span>(lambda, <span class="at">index.return =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>ix</span>
<span id="cb3-7"><a href="confidence-intervals.html#cb3-7" aria-hidden="true" tabindex="-1"></a>  ordered_lambda <span class="ot">&lt;-</span> lambda[sorted_lambda]</span>
<span id="cb3-8"><a href="confidence-intervals.html#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Re-order the TPM according to the switched states</span></span>
<span id="cb3-9"><a href="confidence-intervals.html#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in the sorted lambda</span></span>
<span id="cb3-10"><a href="confidence-intervals.html#cb3-10" aria-hidden="true" tabindex="-1"></a>  ordered_gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> m, <span class="at">ncol =</span> m)</span>
<span id="cb3-11"><a href="confidence-intervals.html#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (col <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb3-12"><a href="confidence-intervals.html#cb3-12" aria-hidden="true" tabindex="-1"></a>    new_col <span class="ot">&lt;-</span> <span class="fu">which</span>(sorted_lambda <span class="sc">==</span> col)</span>
<span id="cb3-13"><a href="confidence-intervals.html#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (row <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb3-14"><a href="confidence-intervals.html#cb3-14" aria-hidden="true" tabindex="-1"></a>      new_row <span class="ot">&lt;-</span> <span class="fu">which</span>(sorted_lambda <span class="sc">==</span> row)</span>
<span id="cb3-15"><a href="confidence-intervals.html#cb3-15" aria-hidden="true" tabindex="-1"></a>      ordered_gamma[row, col] <span class="ot">&lt;-</span> gamma[new_row, new_col]</span>
<span id="cb3-16"><a href="confidence-intervals.html#cb3-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-17"><a href="confidence-intervals.html#cb3-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-18"><a href="confidence-intervals.html#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Same for the TPM&#39;s standard errors</span></span>
<span id="cb3-19"><a href="confidence-intervals.html#cb3-19" aria-hidden="true" tabindex="-1"></a>  ordered_gamma_std_error <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-20"><a href="confidence-intervals.html#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(gamma_std_error)) {</span>
<span id="cb3-21"><a href="confidence-intervals.html#cb3-21" aria-hidden="true" tabindex="-1"></a>    ordered_gamma_std_error <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> m, <span class="at">ncol =</span> m)</span>
<span id="cb3-22"><a href="confidence-intervals.html#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb3-23"><a href="confidence-intervals.html#cb3-23" aria-hidden="true" tabindex="-1"></a>      new_col <span class="ot">&lt;-</span> <span class="fu">which</span>(sorted_lambda <span class="sc">==</span> col)</span>
<span id="cb3-24"><a href="confidence-intervals.html#cb3-24" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (row <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb3-25"><a href="confidence-intervals.html#cb3-25" aria-hidden="true" tabindex="-1"></a>        new_row <span class="ot">&lt;-</span> <span class="fu">which</span>(sorted_lambda <span class="sc">==</span> row)</span>
<span id="cb3-26"><a href="confidence-intervals.html#cb3-26" aria-hidden="true" tabindex="-1"></a>        ordered_gamma_std_error[row, col] <span class="ot">&lt;-</span> gamma_std_error[new_row, new_col]</span>
<span id="cb3-27"><a href="confidence-intervals.html#cb3-27" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-28"><a href="confidence-intervals.html#cb3-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-29"><a href="confidence-intervals.html#cb3-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-30"><a href="confidence-intervals.html#cb3-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-31"><a href="confidence-intervals.html#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Re-order the stationary distribution if it is provided</span></span>
<span id="cb3-32"><a href="confidence-intervals.html#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate it otherwise</span></span>
<span id="cb3-33"><a href="confidence-intervals.html#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(delta)) {</span>
<span id="cb3-34"><a href="confidence-intervals.html#cb3-34" aria-hidden="true" tabindex="-1"></a>    ordered_delta <span class="ot">&lt;-</span> <span class="fu">stat.dist</span>(ordered_gamma)</span>
<span id="cb3-35"><a href="confidence-intervals.html#cb3-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-36"><a href="confidence-intervals.html#cb3-36" aria-hidden="true" tabindex="-1"></a>    ordered_delta <span class="ot">&lt;-</span> delta[sorted_lambda]</span>
<span id="cb3-37"><a href="confidence-intervals.html#cb3-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-38"><a href="confidence-intervals.html#cb3-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Re-order the standard errors</span></span>
<span id="cb3-39"><a href="confidence-intervals.html#cb3-39" aria-hidden="true" tabindex="-1"></a>  ordered_lambda_std_error <span class="ot">&lt;-</span> lambda_std_error[sorted_lambda]</span>
<span id="cb3-40"><a href="confidence-intervals.html#cb3-40" aria-hidden="true" tabindex="-1"></a>  ordered_delta_std_error <span class="ot">&lt;-</span> delta_std_error[sorted_lambda]</span>
<span id="cb3-41"><a href="confidence-intervals.html#cb3-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-42"><a href="confidence-intervals.html#cb3-42" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">lambda =</span> ordered_lambda,</span>
<span id="cb3-43"><a href="confidence-intervals.html#cb3-43" aria-hidden="true" tabindex="-1"></a>                 <span class="at">gamma =</span> ordered_gamma,</span>
<span id="cb3-44"><a href="confidence-intervals.html#cb3-44" aria-hidden="true" tabindex="-1"></a>                 <span class="at">delta =</span> ordered_delta,</span>
<span id="cb3-45"><a href="confidence-intervals.html#cb3-45" aria-hidden="true" tabindex="-1"></a>                 <span class="at">lambda_std_error =</span> ordered_lambda_std_error,</span>
<span id="cb3-46"><a href="confidence-intervals.html#cb3-46" aria-hidden="true" tabindex="-1"></a>                 <span class="at">gamma_std_error =</span> ordered_gamma_std_error,</span>
<span id="cb3-47"><a href="confidence-intervals.html#cb3-47" aria-hidden="true" tabindex="-1"></a>                 <span class="at">delta_std_error =</span> ordered_delta_std_error)</span>
<span id="cb3-48"><a href="confidence-intervals.html#cb3-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-49"><a href="confidence-intervals.html#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove the NULL elements</span></span>
<span id="cb3-50"><a href="confidence-intervals.html#cb3-50" aria-hidden="true" tabindex="-1"></a>  result[<span class="fu">sapply</span>(result, is.null)] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-51"><a href="confidence-intervals.html#cb3-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-52"><a href="confidence-intervals.html#cb3-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb3-53"><a href="confidence-intervals.html#cb3-53" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s show an example to understand the process.
For readability, the TPM is filled with row and column indexes instead of probabilities.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="confidence-intervals.html#cb4-1" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">10</span>, <span class="dv">20</span>)</span>
<span id="cb4-2"><a href="confidence-intervals.html#cb4-2" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>,</span>
<span id="cb4-3"><a href="confidence-intervals.html#cb4-3" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">21</span>, <span class="dv">22</span>, <span class="dv">23</span>,</span>
<span id="cb4-4"><a href="confidence-intervals.html#cb4-4" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">31</span>, <span class="dv">32</span>, <span class="dv">33</span>), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb4-5"><a href="confidence-intervals.html#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">pois.HMM.label.order</span>(<span class="at">m =</span> <span class="dv">3</span>, lambda, gamma)</span></code></pre></div>
<pre><code>## $lambda
## [1] 10 20 30
## 
## $gamma
##      [,1] [,2] [,3]
## [1,]   33   31   32
## [2,]   13   11   12
## [3,]   23   21   22
## 
## $delta
## [1] -0.032786885  0.016393443 -0.008196721</code></pre>
<p>State 1 has been relabeled state 3, state 3 became state 2, and state 2 became state 1.</p>
</div>
<div id="bootstrap-code" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Bootstrap code</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="confidence-intervals.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb6-2"><a href="confidence-intervals.html#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TMB)</span>
<span id="cb6-3"><a href="confidence-intervals.html#cb6-3" aria-hidden="true" tabindex="-1"></a>TMB<span class="sc">::</span><span class="fu">compile</span>(<span class="st">&quot;code/poi_hmm.cpp&quot;</span>)</span>
<span id="cb6-4"><a href="confidence-intervals.html#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dyn.load</span>(<span class="fu">dynlib</span>(<span class="st">&quot;code/poi_hmm&quot;</span>))</span>
<span id="cb6-5"><a href="confidence-intervals.html#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;functions/utils.R&quot;</span>)</span>
<span id="cb6-6"><a href="confidence-intervals.html#cb6-6" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb6-7"><a href="confidence-intervals.html#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;data/tinnitus.RData&quot;</span>)</span>
<span id="cb6-8"><a href="confidence-intervals.html#cb6-8" aria-hidden="true" tabindex="-1"></a>TMB_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> tinn_data, <span class="at">m =</span> m)</span>
<span id="cb6-9"><a href="confidence-intervals.html#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="confidence-intervals.html#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial set of parameters</span></span>
<span id="cb6-11"><a href="confidence-intervals.html#cb6-11" aria-hidden="true" tabindex="-1"></a>lambda_init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb6-12"><a href="confidence-intervals.html#cb6-12" aria-hidden="true" tabindex="-1"></a>gamma_init <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>,</span>
<span id="cb6-13"><a href="confidence-intervals.html#cb6-13" aria-hidden="true" tabindex="-1"></a>                       <span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> m)</span>
<span id="cb6-14"><a href="confidence-intervals.html#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="confidence-intervals.html#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn them into working parameters</span></span>
<span id="cb6-16"><a href="confidence-intervals.html#cb6-16" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m, lambda_init, gamma_init)</span>
<span id="cb6-17"><a href="confidence-intervals.html#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="confidence-intervals.html#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the TMB object</span></span>
<span id="cb6-19"><a href="confidence-intervals.html#cb6-19" aria-hidden="true" tabindex="-1"></a>obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb6-20"><a href="confidence-intervals.html#cb6-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-21"><a href="confidence-intervals.html#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="confidence-intervals.html#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize</span></span>
<span id="cb6-23"><a href="confidence-intervals.html#cb6-23" aria-hidden="true" tabindex="-1"></a>mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj_tmb<span class="sc">$</span>par,</span>
<span id="cb6-24"><a href="confidence-intervals.html#cb6-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">objective =</span> obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb6-25"><a href="confidence-intervals.html#cb6-25" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gradient =</span> obj_tmb<span class="sc">$</span>gr,</span>
<span id="cb6-26"><a href="confidence-intervals.html#cb6-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">hessian =</span> obj_tmb<span class="sc">$</span>he)</span>
<span id="cb6-27"><a href="confidence-intervals.html#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="confidence-intervals.html#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="confidence-intervals.html#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap procedure</span></span>
<span id="cb6-30"><a href="confidence-intervals.html#cb6-30" aria-hidden="true" tabindex="-1"></a>bootstrap_estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb6-31"><a href="confidence-intervals.html#cb6-31" aria-hidden="true" tabindex="-1"></a>DATA_SIZE <span class="ot">&lt;-</span> <span class="fu">length</span>(tinn_data)</span>
<span id="cb6-32"><a href="confidence-intervals.html#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Set how many parametric bootstrap samples we create</span></span>
<span id="cb6-33"><a href="confidence-intervals.html#cb6-33" aria-hidden="true" tabindex="-1"></a>BOOTSTRAP_SAMPLES <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb6-34"><a href="confidence-intervals.html#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="confidence-intervals.html#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co"># MLE</span></span>
<span id="cb6-36"><a href="confidence-intervals.html#cb6-36" aria-hidden="true" tabindex="-1"></a>ML_working_estimates <span class="ot">&lt;-</span> obj_tmb<span class="sc">$</span>env<span class="sc">$</span>last.par.best</span>
<span id="cb6-37"><a href="confidence-intervals.html#cb6-37" aria-hidden="true" tabindex="-1"></a>ML_natural_estimates <span class="ot">&lt;-</span> obj_tmb<span class="sc">$</span><span class="fu">report</span>(ML_working_estimates)</span>
<span id="cb6-38"><a href="confidence-intervals.html#cb6-38" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> ML_natural_estimates<span class="sc">$</span>lambda</span>
<span id="cb6-39"><a href="confidence-intervals.html#cb6-39" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> ML_natural_estimates<span class="sc">$</span>gamma</span>
<span id="cb6-40"><a href="confidence-intervals.html#cb6-40" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> ML_natural_estimates<span class="sc">$</span>delta</span>
<span id="cb6-41"><a href="confidence-intervals.html#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="confidence-intervals.html#cb6-42" aria-hidden="true" tabindex="-1"></a>PARAMS_NAMES <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;gamma&quot;</span>, <span class="st">&quot;delta&quot;</span>)</span>
<span id="cb6-43"><a href="confidence-intervals.html#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (idx_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>BOOTSTRAP_SAMPLES) {</span>
<span id="cb6-44"><a href="confidence-intervals.html#cb6-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate a sample based on mod, and ensure a HMM can be estimated on it</span></span>
<span id="cb6-45"><a href="confidence-intervals.html#cb6-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># with testing_params as initial parameters</span></span>
<span id="cb6-46"><a href="confidence-intervals.html#cb6-46" aria-hidden="true" tabindex="-1"></a>  temp <span class="ot">&lt;-</span> <span class="fu">pois.HMM.generate_estimable_sample</span>(<span class="at">ns =</span> DATA_SIZE,</span>
<span id="cb6-47"><a href="confidence-intervals.html#cb6-47" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">mod =</span> <span class="fu">list</span>(<span class="at">m =</span> m,</span>
<span id="cb6-48"><a href="confidence-intervals.html#cb6-48" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">lambda =</span> lambda,</span>
<span id="cb6-49"><a href="confidence-intervals.html#cb6-49" aria-hidden="true" tabindex="-1"></a>                                                        <span class="at">gamma =</span> gamma),</span>
<span id="cb6-50"><a href="confidence-intervals.html#cb6-50" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">testing_params =</span> <span class="fu">list</span>(<span class="at">m =</span> m,</span>
<span id="cb6-51"><a href="confidence-intervals.html#cb6-51" aria-hidden="true" tabindex="-1"></a>                                                                   <span class="at">lambda =</span> lambda_init,</span>
<span id="cb6-52"><a href="confidence-intervals.html#cb6-52" aria-hidden="true" tabindex="-1"></a>                                                                   <span class="at">gamma =</span> gamma_init))<span class="sc">$</span>natural_parameters</span>
<span id="cb6-53"><a href="confidence-intervals.html#cb6-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The values from gamma are taken columnwise</span></span>
<span id="cb6-54"><a href="confidence-intervals.html#cb6-54" aria-hidden="true" tabindex="-1"></a>  natural_parameters <span class="ot">&lt;-</span> <span class="fu">unlist</span>(temp[PARAMS_NAMES])</span>
<span id="cb6-55"><a href="confidence-intervals.html#cb6-55" aria-hidden="true" tabindex="-1"></a>  len_par <span class="ot">&lt;-</span> <span class="fu">length</span>(natural_parameters)</span>
<span id="cb6-56"><a href="confidence-intervals.html#cb6-56" aria-hidden="true" tabindex="-1"></a>  bootstrap_estimates[idx_sample, <span class="dv">1</span><span class="sc">:</span>len_par] <span class="ot">&lt;-</span> natural_parameters</span>
<span id="cb6-57"><a href="confidence-intervals.html#cb6-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-58"><a href="confidence-intervals.html#cb6-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-59"><a href="confidence-intervals.html#cb6-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Lower and upper (2.5% and 97.5%) bounds</span></span>
<span id="cb6-60"><a href="confidence-intervals.html#cb6-60" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">apply</span>(bootstrap_estimates, <span class="dv">2</span>, <span class="cf">function</span>(par_estimate) {</span>
<span id="cb6-61"><a href="confidence-intervals.html#cb6-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quantile</span>(par_estimate, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb6-62"><a href="confidence-intervals.html#cb6-62" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-63"><a href="confidence-intervals.html#cb6-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-64"><a href="confidence-intervals.html#cb6-64" aria-hidden="true" tabindex="-1"></a>PARAMS_NAMES <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rep</span>(<span class="st">&quot;lambda&quot;</span>, m), <span class="dv">1</span><span class="sc">:</span>m)</span>
<span id="cb6-65"><a href="confidence-intervals.html#cb6-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Get row and column indexes for gamma instead of the default</span></span>
<span id="cb6-66"><a href="confidence-intervals.html#cb6-66" aria-hidden="true" tabindex="-1"></a><span class="co"># columnwise index: the default indexes are 1:m for the 1st column,</span></span>
<span id="cb6-67"><a href="confidence-intervals.html#cb6-67" aria-hidden="true" tabindex="-1"></a><span class="co"># then (m + 1):(2 * m) for the 2nd, etc...</span></span>
<span id="cb6-68"><a href="confidence-intervals.html#cb6-68" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (gamma_idx <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m <span class="sc">^</span> <span class="dv">2</span>) {</span>
<span id="cb6-69"><a href="confidence-intervals.html#cb6-69" aria-hidden="true" tabindex="-1"></a>  row <span class="ot">&lt;-</span> (gamma_idx <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> m <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb6-70"><a href="confidence-intervals.html#cb6-70" aria-hidden="true" tabindex="-1"></a>  col <span class="ot">&lt;-</span> (gamma_idx <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%/%</span> m <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb6-71"><a href="confidence-intervals.html#cb6-71" aria-hidden="true" tabindex="-1"></a>  row_col_idx <span class="ot">&lt;-</span> <span class="fu">c</span>(row, col)</span>
<span id="cb6-72"><a href="confidence-intervals.html#cb6-72" aria-hidden="true" tabindex="-1"></a>  PARAMS_NAMES <span class="ot">&lt;-</span> <span class="fu">c</span>(PARAMS_NAMES,</span>
<span id="cb6-73"><a href="confidence-intervals.html#cb6-73" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(<span class="st">&quot;gamma&quot;</span>,</span>
<span id="cb6-74"><a href="confidence-intervals.html#cb6-74" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">paste0</span>(row_col_idx, <span class="at">collapse =</span> <span class="st">&quot;&quot;</span>)))</span>
<span id="cb6-75"><a href="confidence-intervals.html#cb6-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-76"><a href="confidence-intervals.html#cb6-76" aria-hidden="true" tabindex="-1"></a>PARAMS_NAMES <span class="ot">&lt;-</span> <span class="fu">c</span>(PARAMS_NAMES,</span>
<span id="cb6-77"><a href="confidence-intervals.html#cb6-77" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">paste0</span>(<span class="fu">rep</span>(<span class="st">&quot;delta&quot;</span>, m), <span class="dv">1</span><span class="sc">:</span>m))</span>
<span id="cb6-78"><a href="confidence-intervals.html#cb6-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-79"><a href="confidence-intervals.html#cb6-79" aria-hidden="true" tabindex="-1"></a>bootstrap_CI <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Parameter&quot;</span> <span class="ot">=</span> PARAMS_NAMES,</span>
<span id="cb6-80"><a href="confidence-intervals.html#cb6-80" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Estimate&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(lambda, gamma, delta),</span>
<span id="cb6-81"><a href="confidence-intervals.html#cb6-81" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Lower bound&quot;</span> <span class="ot">=</span> q[<span class="dv">1</span>, ],</span>
<span id="cb6-82"><a href="confidence-intervals.html#cb6-82" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Upper bound&quot;</span> <span class="ot">=</span> q[<span class="dv">2</span>, ])</span>
<span id="cb6-83"><a href="confidence-intervals.html#cb6-83" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bootstrap_CI, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-84"><a href="confidence-intervals.html#cb6-84" aria-hidden="true" tabindex="-1"></a><span class="co"># print(counter)</span></span>
<span id="cb6-85"><a href="confidence-intervals.html#cb6-85" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(x = 1:BOOTSTRAP_SAMPLES, y = nll)</span></span>
<span id="cb6-86"><a href="confidence-intervals.html#cb6-86" aria-hidden="true" tabindex="-1"></a><span class="co"># hist(nll)</span></span>
<span id="cb6-87"><a href="confidence-intervals.html#cb6-87" aria-hidden="true" tabindex="-1"></a><span class="co"># apply(bootstrap_estimates[, 1:2], 2, function(est) {</span></span>
<span id="cb6-88"><a href="confidence-intervals.html#cb6-88" aria-hidden="true" tabindex="-1"></a><span class="co">#   hist(est, breaks = &quot;FD&quot;)</span></span>
<span id="cb6-89"><a href="confidence-intervals.html#cb6-89" aria-hidden="true" tabindex="-1"></a><span class="co"># })</span></span>
<span id="cb6-90"><a href="confidence-intervals.html#cb6-90" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(&quot;Lack of convergence/missing results&quot;, counter2, counter1, &quot;times&quot;))</span></span>
<span id="cb6-91"><a href="confidence-intervals.html#cb6-91" aria-hidden="true" tabindex="-1"></a><span class="co"># myAIC[, &quot;pref&quot;] &lt;- ifelse(myAIC[, &quot;1state&quot;] &lt;= myAIC[, &quot;2state&quot;], 1, 2)</span></span>
<span id="cb6-92"><a href="confidence-intervals.html#cb6-92" aria-hidden="true" tabindex="-1"></a><span class="co"># myBIC[, &quot;pref&quot;] &lt;- ifelse(myBIC[, &quot;1state&quot;] &lt;= myBIC[, &quot;2state&quot;], 1, 2)</span></span>
<span id="cb6-93"><a href="confidence-intervals.html#cb6-93" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(&quot;AIC prefers 1 state&quot;, sum(myAIC[, &quot;pref&quot;] == 1), &quot;times, and 2 states&quot;, sum(myAIC[, &quot;pref&quot;] == 2), &quot;times&quot;))</span></span>
<span id="cb6-94"><a href="confidence-intervals.html#cb6-94" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(&quot;BIC prefers 1 state&quot;, sum(myBIC[, &quot;pref&quot;] == 1), &quot;times, and 2 states&quot;, sum(myBIC[, &quot;pref&quot;] == 2), &quot;times&quot;))</span></span>
<span id="cb6-95"><a href="confidence-intervals.html#cb6-95" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-96"><a href="confidence-intervals.html#cb6-96" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-97"><a href="confidence-intervals.html#cb6-97" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(counter1, &quot;don&#39;t reach any result&quot;))</span></span>
<span id="cb6-98"><a href="confidence-intervals.html#cb6-98" aria-hidden="true" tabindex="-1"></a><span class="co"># # print(paste(&quot;conv codes:&quot;, conv1))</span></span>
<span id="cb6-99"><a href="confidence-intervals.html#cb6-99" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(counter2, &quot;don&#39;t converge successfully&quot;))</span></span>
<span id="cb6-100"><a href="confidence-intervals.html#cb6-100" aria-hidden="true" tabindex="-1"></a><span class="co"># # print(paste(&quot;conv codes:&quot;, conv2))</span></span>
<span id="cb6-101"><a href="confidence-intervals.html#cb6-101" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(counter3, &quot;parameters are NA&quot;))</span></span>
<span id="cb6-102"><a href="confidence-intervals.html#cb6-102" aria-hidden="true" tabindex="-1"></a><span class="co"># # print(paste(&quot;gamma over the threshold&quot;, counter_threshold_gamma, &quot;times&quot;))</span></span>
<span id="cb6-103"><a href="confidence-intervals.html#cb6-103" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(&quot;lambda under the threshold&quot;, counter_threshold_lambda, &quot;times&quot;))</span></span></code></pre></div>
<p>It should be noted that some bootstrap estimates can be very large or very small.
One possible reason is that the randomly generated bootstrap sample might contain long chains of the same values, thus causing some probabilities in the TPM to be near the boundary 0 or 1.
However, a large number of bootstrap samples lowers that risk since we leave out 5% of the most extreme values when computing the 95% CI.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="using-tmb.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Data supplements.pdf", "Data supplements.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
