<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Confidence intervals | Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Confidence intervals | Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Confidence intervals | Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Timothée Bacri timothee.bacri@uib.no" />
<meta name="author" content="Jan Bulla jan.bulla@uib.no" />
<meta name="author" content="Geir Berentsen geir.berentsen@nhh.no" />


<meta name="date" content="2021-03-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="applications.html"/>
<link rel="next" href="references.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Summary</a></li>
<li class="chapter" data-level="1" data-path="state-inf.html"><a href="state-inf.html"><i class="fa fa-check"></i><b>1</b> State inference</a>
<ul>
<li class="chapter" data-level="1.1" data-path="state-inf.html"><a href="state-inf.html#prepare-the-model"><i class="fa fa-check"></i><b>1.1</b> Prepare the model</a></li>
<li class="chapter" data-level="1.2" data-path="state-inf.html"><a href="state-inf.html#setup"><i class="fa fa-check"></i><b>1.2</b> Setup</a></li>
<li class="chapter" data-level="1.3" data-path="state-inf.html"><a href="state-inf.html#log-forward"><i class="fa fa-check"></i><b>1.3</b> Log-forward probabilities</a></li>
<li class="chapter" data-level="1.4" data-path="state-inf.html"><a href="state-inf.html#log-backward"><i class="fa fa-check"></i><b>1.4</b> Log-backward probabilities</a></li>
<li class="chapter" data-level="1.5" data-path="state-inf.html"><a href="state-inf.html#local-decoding"><i class="fa fa-check"></i><b>1.5</b> Smoothing probabilities and local decoding</a></li>
<li class="chapter" data-level="1.6" data-path="state-inf.html"><a href="state-inf.html#forecast"><i class="fa fa-check"></i><b>1.6</b> Forecast, h-step-ahead-probabilities</a></li>
<li class="chapter" data-level="1.7" data-path="state-inf.html"><a href="state-inf.html#global-decoding"><i class="fa fa-check"></i><b>1.7</b> Global decoding using the Viterbi algorithm</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="confidence-intervals.html"><a href="confidence-intervals.html"><i class="fa fa-check"></i><b>2</b> Confidence intervals</a></li>
<li class="chapter" data-level="3" data-path="methods.html"><a href="methods.html"><i class="fa fa-check"></i><b>3</b> Methods</a></li>
<li class="chapter" data-level="4" data-path="applications.html"><a href="applications.html"><i class="fa fa-check"></i><b>4</b> Applications</a>
<ul>
<li class="chapter" data-level="4.1" data-path="applications.html"><a href="applications.html#example-one"><i class="fa fa-check"></i><b>4.1</b> Example one</a></li>
<li class="chapter" data-level="4.2" data-path="applications.html"><a href="applications.html#example-two"><i class="fa fa-check"></i><b>4.2</b> Example two</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="confidence-intervals-1.html"><a href="confidence-intervals-1.html"><i class="fa fa-check"></i><b>5</b> Confidence intervals</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="confidence-intervals-1" class="section level1" number="5">
<h1><span class="header-section-number">Chapter 5</span> Confidence intervals</h1>
<p>From the parameters’ ML estimates, we generate new data and re-estimate the parameters  times.
From that list of new estimates we can get the 2.5th and 97.5th percentiles and get 95% confidence intervals for the parameters.\</p>
<p>We show below how we get confidence intervals using bootstrap, based on the 2 state Poisson HMM estimates from above. TIMO: we had a 2-state above, right?</p>
<ul>
<li>First, we need a function to generate random data from a HMM.</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="confidence-intervals-1.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a random sample from a HMM</span></span>
<span id="cb1-2"><a href="confidence-intervals-1.html#cb1-2" aria-hidden="true" tabindex="-1"></a>pois.HMM.generate_sample  <span class="ot">&lt;-</span> <span class="cf">function</span>(ns, mod) {</span>
<span id="cb1-3"><a href="confidence-intervals-1.html#cb1-3" aria-hidden="true" tabindex="-1"></a>  mvect <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>mod<span class="sc">$</span>m</span>
<span id="cb1-4"><a href="confidence-intervals-1.html#cb1-4" aria-hidden="true" tabindex="-1"></a>  state <span class="ot">&lt;-</span> <span class="fu">numeric</span>(ns)</span>
<span id="cb1-5"><a href="confidence-intervals-1.html#cb1-5" aria-hidden="true" tabindex="-1"></a>  state[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">sample</span>(mvect, <span class="dv">1</span>, <span class="at">prob =</span> mod<span class="sc">$</span>delta)</span>
<span id="cb1-6"><a href="confidence-intervals-1.html#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>ns) {</span>
<span id="cb1-7"><a href="confidence-intervals-1.html#cb1-7" aria-hidden="true" tabindex="-1"></a>    state[i] <span class="ot">&lt;-</span> <span class="fu">sample</span>(mvect, <span class="dv">1</span>, <span class="at">prob =</span> mod<span class="sc">$</span>gamma[state[i <span class="sc">-</span> <span class="dv">1</span>], ])</span>
<span id="cb1-8"><a href="confidence-intervals-1.html#cb1-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-9"><a href="confidence-intervals-1.html#cb1-9" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rpois</span>(ns, <span class="at">lambda =</span> mod<span class="sc">$</span>lambda[state])</span>
<span id="cb1-10"><a href="confidence-intervals-1.html#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">data =</span> x, <span class="at">state =</span> state))</span>
<span id="cb1-11"><a href="confidence-intervals-1.html#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>Then, when the model is estimated each time, we don’t impose an order for the states.</li>
</ul>
<p>This can lead to the label switching problem, where states aren’t ordered the same way in each model.
To address this, we re-ordered the states by ascending Poisson means.\
Sorting the means is pretty straightforward.
Re-ordering the TPM is a little trickier.
To do so, we took the permutations of the states given by the sorted Poisson means, and permuted each row index and column index to its new value.\
The function we used is</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="confidence-intervals-1.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Relabel states by increasing Poisson means</span></span>
<span id="cb2-2"><a href="confidence-intervals-1.html#cb2-2" aria-hidden="true" tabindex="-1"></a>pois.HMM.label.order <span class="ot">&lt;-</span> <span class="cf">function</span>(m, lambda, gamma, <span class="at">delta =</span> <span class="cn">NULL</span>) {</span>
<span id="cb2-3"><a href="confidence-intervals-1.html#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the indexes of the sorted states</span></span>
<span id="cb2-4"><a href="confidence-intervals-1.html#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># according to ascending lambda</span></span>
<span id="cb2-5"><a href="confidence-intervals-1.html#cb2-5" aria-hidden="true" tabindex="-1"></a>  sorted_lambda <span class="ot">&lt;-</span> <span class="fu">sort</span>(lambda, <span class="at">index.return =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>ix</span>
<span id="cb2-6"><a href="confidence-intervals-1.html#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Re-order the TPM according to the switched states</span></span>
<span id="cb2-7"><a href="confidence-intervals-1.html#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in the sorted lambda</span></span>
<span id="cb2-8"><a href="confidence-intervals-1.html#cb2-8" aria-hidden="true" tabindex="-1"></a>  ordered_gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> m, <span class="at">ncol =</span> m)</span>
<span id="cb2-9"><a href="confidence-intervals-1.html#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (col <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb2-10"><a href="confidence-intervals-1.html#cb2-10" aria-hidden="true" tabindex="-1"></a>    new_col <span class="ot">&lt;-</span> <span class="fu">which</span>(sorted_lambda <span class="sc">==</span> col)</span>
<span id="cb2-11"><a href="confidence-intervals-1.html#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (row <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb2-12"><a href="confidence-intervals-1.html#cb2-12" aria-hidden="true" tabindex="-1"></a>      new_row <span class="ot">&lt;-</span> <span class="fu">which</span>(sorted_lambda <span class="sc">==</span> row)</span>
<span id="cb2-13"><a href="confidence-intervals-1.html#cb2-13" aria-hidden="true" tabindex="-1"></a>      ordered_gamma[row, col] <span class="ot">&lt;-</span> gamma[new_row, new_col]</span>
<span id="cb2-14"><a href="confidence-intervals-1.html#cb2-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-15"><a href="confidence-intervals-1.html#cb2-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-16"><a href="confidence-intervals-1.html#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Re-order the stationary distribution if it was provided</span></span>
<span id="cb2-17"><a href="confidence-intervals-1.html#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate it otherwise</span></span>
<span id="cb2-18"><a href="confidence-intervals-1.html#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(delta)) {</span>
<span id="cb2-19"><a href="confidence-intervals-1.html#cb2-19" aria-hidden="true" tabindex="-1"></a>    delta <span class="ot">&lt;-</span> <span class="fu">stat.dist</span>(ordered_gamma)</span>
<span id="cb2-20"><a href="confidence-intervals-1.html#cb2-20" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-21"><a href="confidence-intervals-1.html#cb2-21" aria-hidden="true" tabindex="-1"></a>    delta <span class="ot">&lt;-</span> delta[sorted_lambda]</span>
<span id="cb2-22"><a href="confidence-intervals-1.html#cb2-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-23"><a href="confidence-intervals-1.html#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">lambda =</span> <span class="fu">sort</span>(lambda),</span>
<span id="cb2-24"><a href="confidence-intervals-1.html#cb2-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">gamma =</span> ordered_gamma,</span>
<span id="cb2-25"><a href="confidence-intervals-1.html#cb2-25" aria-hidden="true" tabindex="-1"></a>              <span class="at">delta =</span> delta))</span>
<span id="cb2-26"><a href="confidence-intervals-1.html#cb2-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s show an example to understand the process.
For readability, the TPM is filled with row and column indexes instead of probabilities.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="confidence-intervals-1.html#cb3-1" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">10</span>, <span class="dv">20</span>)</span>
<span id="cb3-2"><a href="confidence-intervals-1.html#cb3-2" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>,</span>
<span id="cb3-3"><a href="confidence-intervals-1.html#cb3-3" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">21</span>, <span class="dv">22</span>, <span class="dv">23</span>,</span>
<span id="cb3-4"><a href="confidence-intervals-1.html#cb3-4" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">31</span>, <span class="dv">32</span>, <span class="dv">33</span>), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb3-5"><a href="confidence-intervals-1.html#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">pois.HMM.label.order</span>(<span class="at">m =</span> <span class="dv">3</span>, lambda, gamma)</span></code></pre></div>
<pre><code>## $lambda
## [1] 10 20 30
## 
## $gamma
##      [,1] [,2] [,3]
## [1,]   33   31   32
## [2,]   13   11   12
## [3,]   23   21   22
## 
## $delta
## [1] -0.032786885  0.016393443 -0.008196721</code></pre>
<p>State 1 has been relabeled state 3, state 2 became state 1, and state 3 became state 2.</p>
<ul>
<li>Bootstrap code</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="confidence-intervals-1.html#cb5-1" aria-hidden="true" tabindex="-1"></a>bootstrap_estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb5-2"><a href="confidence-intervals-1.html#cb5-2" aria-hidden="true" tabindex="-1"></a>DATA_SIZE <span class="ot">&lt;-</span> <span class="fu">length</span>(lamb_data)</span>
<span id="cb5-3"><a href="confidence-intervals-1.html#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set how many parametric bootstrap samples we create</span></span>
<span id="cb5-4"><a href="confidence-intervals-1.html#cb5-4" aria-hidden="true" tabindex="-1"></a>BOOTSTRAP_SAMPLES <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb5-5"><a href="confidence-intervals-1.html#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="confidence-intervals-1.html#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ML parameters</span></span>
<span id="cb5-7"><a href="confidence-intervals-1.html#cb5-7" aria-hidden="true" tabindex="-1"></a>ML_working_estimates <span class="ot">&lt;-</span> obj_tmb<span class="sc">$</span>env<span class="sc">$</span>last.par.best</span>
<span id="cb5-8"><a href="confidence-intervals-1.html#cb5-8" aria-hidden="true" tabindex="-1"></a>ML_natural_estimates <span class="ot">&lt;-</span> obj_tmb<span class="sc">$</span><span class="fu">report</span>(ML_working_estimates)</span>
<span id="cb5-9"><a href="confidence-intervals-1.html#cb5-9" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> ML_natural_estimates<span class="sc">$</span>gamma</span>
<span id="cb5-10"><a href="confidence-intervals-1.html#cb5-10" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> ML_natural_estimates<span class="sc">$</span>lambda</span>
<span id="cb5-11"><a href="confidence-intervals-1.html#cb5-11" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> ML_natural_estimates<span class="sc">$</span>delta</span>
<span id="cb5-12"><a href="confidence-intervals-1.html#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="confidence-intervals-1.html#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for TMB</span></span>
<span id="cb5-14"><a href="confidence-intervals-1.html#cb5-14" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">names</span>(ML_working_estimates)</span>
<span id="cb5-15"><a href="confidence-intervals-1.html#cb5-15" aria-hidden="true" tabindex="-1"></a>tgamma <span class="ot">&lt;-</span> ML_working_estimates[cols <span class="sc">==</span> <span class="st">&quot;tgamma&quot;</span>]</span>
<span id="cb5-16"><a href="confidence-intervals-1.html#cb5-16" aria-hidden="true" tabindex="-1"></a>tlambda <span class="ot">&lt;-</span> ML_working_estimates[cols <span class="sc">==</span> <span class="st">&quot;tlambda&quot;</span>]</span>
<span id="cb5-17"><a href="confidence-intervals-1.html#cb5-17" aria-hidden="true" tabindex="-1"></a>ML_TMB_parameters <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tlambda =</span> tlambda,</span>
<span id="cb5-18"><a href="confidence-intervals-1.html#cb5-18" aria-hidden="true" tabindex="-1"></a>                          <span class="at">tgamma =</span> tgamma)</span>
<span id="cb5-19"><a href="confidence-intervals-1.html#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="confidence-intervals-1.html#cb5-20" aria-hidden="true" tabindex="-1"></a>params_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;lambda&quot;</span>, <span class="st">&quot;gamma&quot;</span>, <span class="st">&quot;delta&quot;</span>)</span>
<span id="cb5-21"><a href="confidence-intervals-1.html#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># counter1 &lt;- counter2 &lt;- counter3 &lt;- counter_threshold_gamma &lt;- counter_threshold_lambda &lt;- 0</span></span>
<span id="cb5-22"><a href="confidence-intervals-1.html#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co"># conv1 &lt;- c()</span></span>
<span id="cb5-23"><a href="confidence-intervals-1.html#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># conv2 &lt;- data.frame(message = character(),</span></span>
<span id="cb5-24"><a href="confidence-intervals-1.html#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">#                     min_g = numeric(),</span></span>
<span id="cb5-25"><a href="confidence-intervals-1.html#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">#                     max_g = numeric(),</span></span>
<span id="cb5-26"><a href="confidence-intervals-1.html#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co">#                     min_l = numeric(),</span></span>
<span id="cb5-27"><a href="confidence-intervals-1.html#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">#                     max_l = numeric())</span></span>
<span id="cb5-28"><a href="confidence-intervals-1.html#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co"># # nll &lt;- c()</span></span>
<span id="cb5-29"><a href="confidence-intervals-1.html#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co"># idx_sample &lt;- 1</span></span>
<span id="cb5-30"><a href="confidence-intervals-1.html#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="co"># myAIC &lt;- myBIC &lt;- data.frame()</span></span>
<span id="cb5-31"><a href="confidence-intervals-1.html#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (idx_sample <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>BOOTSTRAP_SAMPLES) {</span>
<span id="cb5-32"><a href="confidence-intervals-1.html#cb5-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop as long as there is an issue with nlminb</span></span>
<span id="cb5-33"><a href="confidence-intervals-1.html#cb5-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">repeat</span> {</span>
<span id="cb5-34"><a href="confidence-intervals-1.html#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#simulate the data</span></span>
<span id="cb5-35"><a href="confidence-intervals-1.html#cb5-35" aria-hidden="true" tabindex="-1"></a>    bootstrap_data <span class="ot">&lt;-</span> <span class="fu">pois.HMM.generate_sample</span>(DATA_SIZE,</span>
<span id="cb5-36"><a href="confidence-intervals-1.html#cb5-36" aria-hidden="true" tabindex="-1"></a>                                               <span class="fu">list</span>(<span class="at">m =</span> m,</span>
<span id="cb5-37"><a href="confidence-intervals-1.html#cb5-37" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">lambda =</span> lambda,</span>
<span id="cb5-38"><a href="confidence-intervals-1.html#cb5-38" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">gamma =</span> gamma,</span>
<span id="cb5-39"><a href="confidence-intervals-1.html#cb5-39" aria-hidden="true" tabindex="-1"></a>                                                    <span class="at">delta =</span> delta))</span>
<span id="cb5-40"><a href="confidence-intervals-1.html#cb5-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-41"><a href="confidence-intervals-1.html#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # TRUE STATE FILTERING</span></span>
<span id="cb5-42"><a href="confidence-intervals-1.html#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tab &lt;- as.numeric(table(bootstrap_data$state)) / DATA_SIZE</span></span>
<span id="cb5-43"><a href="confidence-intervals-1.html#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if (any(tab &gt;= 0.99)) {</span></span>
<span id="cb5-44"><a href="confidence-intervals-1.html#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   counter = counter + 1</span></span>
<span id="cb5-45"><a href="confidence-intervals-1.html#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   next</span></span>
<span id="cb5-46"><a href="confidence-intervals-1.html#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb5-47"><a href="confidence-intervals-1.html#cb5-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-48"><a href="confidence-intervals-1.html#cb5-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parameters for TMB</span></span>
<span id="cb5-49"><a href="confidence-intervals-1.html#cb5-49" aria-hidden="true" tabindex="-1"></a>    TMB_data_bootstrap <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> bootstrap_data<span class="sc">$</span>data, <span class="at">m =</span> m)</span>
<span id="cb5-50"><a href="confidence-intervals-1.html#cb5-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-51"><a href="confidence-intervals-1.html#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimate the parameters</span></span>
<span id="cb5-52"><a href="confidence-intervals-1.html#cb5-52" aria-hidden="true" tabindex="-1"></a>    obj <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data_bootstrap,</span>
<span id="cb5-53"><a href="confidence-intervals-1.html#cb5-53" aria-hidden="true" tabindex="-1"></a>                     ML_TMB_parameters,</span>
<span id="cb5-54"><a href="confidence-intervals-1.html#cb5-54" aria-hidden="true" tabindex="-1"></a>                     <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>,</span>
<span id="cb5-55"><a href="confidence-intervals-1.html#cb5-55" aria-hidden="true" tabindex="-1"></a>                     <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-56"><a href="confidence-intervals-1.html#cb5-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-57"><a href="confidence-intervals-1.html#cb5-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using tryCatch to break the loop if an error happens</span></span>
<span id="cb5-58"><a href="confidence-intervals-1.html#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># interrupts the outer (for) loop, not the inner one (repeat)</span></span>
<span id="cb5-59"><a href="confidence-intervals-1.html#cb5-59" aria-hidden="true" tabindex="-1"></a>    mod_bootstrap <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb5-60"><a href="confidence-intervals-1.html#cb5-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">try</span>(mod_bootstrap <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj<span class="sc">$</span>par, <span class="at">objective =</span> obj<span class="sc">$</span>fn,</span>
<span id="cb5-61"><a href="confidence-intervals-1.html#cb5-61" aria-hidden="true" tabindex="-1"></a>                                <span class="at">gradient =</span> obj<span class="sc">$</span>gr, <span class="at">hessian =</span> obj<span class="sc">$</span>he),</span>
<span id="cb5-62"><a href="confidence-intervals-1.html#cb5-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-63"><a href="confidence-intervals-1.html#cb5-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-64"><a href="confidence-intervals-1.html#cb5-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If nlminb doesn&#39;t reach any result, retry</span></span>
<span id="cb5-65"><a href="confidence-intervals-1.html#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(mod_bootstrap)) {</span>
<span id="cb5-66"><a href="confidence-intervals-1.html#cb5-66" aria-hidden="true" tabindex="-1"></a>      <span class="co"># conv1 &lt;- c(conv1, mod_bootstrap$convergence)</span></span>
<span id="cb5-67"><a href="confidence-intervals-1.html#cb5-67" aria-hidden="true" tabindex="-1"></a>      <span class="co"># counter1 &lt;- counter1 + 1</span></span>
<span id="cb5-68"><a href="confidence-intervals-1.html#cb5-68" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb5-69"><a href="confidence-intervals-1.html#cb5-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-70"><a href="confidence-intervals-1.html#cb5-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If nlminb doesn&#39;t converge successfully, retry</span></span>
<span id="cb5-71"><a href="confidence-intervals-1.html#cb5-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (mod_bootstrap<span class="sc">$</span>convergence <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb5-72"><a href="confidence-intervals-1.html#cb5-72" aria-hidden="true" tabindex="-1"></a>      <span class="co"># working_parameters &lt;- obj$env$last.par.best</span></span>
<span id="cb5-73"><a href="confidence-intervals-1.html#cb5-73" aria-hidden="true" tabindex="-1"></a>      <span class="co"># natural_parameters &lt;- obj$report(working_parameters)</span></span>
<span id="cb5-74"><a href="confidence-intervals-1.html#cb5-74" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span></span>
<span id="cb5-75"><a href="confidence-intervals-1.html#cb5-75" aria-hidden="true" tabindex="-1"></a>      <span class="co"># g &lt;- natural_parameters$gamma</span></span>
<span id="cb5-76"><a href="confidence-intervals-1.html#cb5-76" aria-hidden="true" tabindex="-1"></a>      <span class="co"># conv2[counter2 + 1, ] &lt;- cbind(mod_bootstrap$message,</span></span>
<span id="cb5-77"><a href="confidence-intervals-1.html#cb5-77" aria-hidden="true" tabindex="-1"></a>      <span class="co">#                                round(min(g), 4),</span></span>
<span id="cb5-78"><a href="confidence-intervals-1.html#cb5-78" aria-hidden="true" tabindex="-1"></a>      <span class="co">#                                round(max(g), 4),</span></span>
<span id="cb5-79"><a href="confidence-intervals-1.html#cb5-79" aria-hidden="true" tabindex="-1"></a>      <span class="co">#                                round(min(l), 4),</span></span>
<span id="cb5-80"><a href="confidence-intervals-1.html#cb5-80" aria-hidden="true" tabindex="-1"></a>      <span class="co">#                                round(max(l), 4))</span></span>
<span id="cb5-81"><a href="confidence-intervals-1.html#cb5-81" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if(min(l) &lt;= 1e-3) {</span></span>
<span id="cb5-82"><a href="confidence-intervals-1.html#cb5-82" aria-hidden="true" tabindex="-1"></a>      <span class="co">#   print(min(l), digits = 10)</span></span>
<span id="cb5-83"><a href="confidence-intervals-1.html#cb5-83" aria-hidden="true" tabindex="-1"></a>      <span class="co"># }</span></span>
<span id="cb5-84"><a href="confidence-intervals-1.html#cb5-84" aria-hidden="true" tabindex="-1"></a>      <span class="co"># counter2 &lt;- counter2 + 1</span></span>
<span id="cb5-85"><a href="confidence-intervals-1.html#cb5-85" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb5-86"><a href="confidence-intervals-1.html#cb5-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-87"><a href="confidence-intervals-1.html#cb5-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-88"><a href="confidence-intervals-1.html#cb5-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # SMOOTHING FILTERING</span></span>
<span id="cb5-89"><a href="confidence-intervals-1.html#cb5-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># smoot &lt;- HMM.decode(obj)$ldecode</span></span>
<span id="cb5-90"><a href="confidence-intervals-1.html#cb5-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tab &lt;- as.numeric(table(smoot)) / DATA_SIZE</span></span>
<span id="cb5-91"><a href="confidence-intervals-1.html#cb5-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if (any(tab &gt;= 0.99)) {</span></span>
<span id="cb5-92"><a href="confidence-intervals-1.html#cb5-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   counter = counter + 1</span></span>
<span id="cb5-93"><a href="confidence-intervals-1.html#cb5-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   next</span></span>
<span id="cb5-94"><a href="confidence-intervals-1.html#cb5-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb5-95"><a href="confidence-intervals-1.html#cb5-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-96"><a href="confidence-intervals-1.html#cb5-96" aria-hidden="true" tabindex="-1"></a>    working_parameters <span class="ot">&lt;-</span> obj<span class="sc">$</span>env<span class="sc">$</span>last.par.best</span>
<span id="cb5-97"><a href="confidence-intervals-1.html#cb5-97" aria-hidden="true" tabindex="-1"></a>    natural_parameters <span class="ot">&lt;-</span> obj<span class="sc">$</span><span class="fu">report</span>(working_parameters)</span>
<span id="cb5-98"><a href="confidence-intervals-1.html#cb5-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-99"><a href="confidence-intervals-1.html#cb5-99" aria-hidden="true" tabindex="-1"></a>    l <span class="ot">&lt;-</span> natural_parameters<span class="sc">$</span>lambda</span>
<span id="cb5-100"><a href="confidence-intervals-1.html#cb5-100" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> natural_parameters<span class="sc">$</span>gamma</span>
<span id="cb5-101"><a href="confidence-intervals-1.html#cb5-101" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> natural_parameters<span class="sc">$</span>delta</span>
<span id="cb5-102"><a href="confidence-intervals-1.html#cb5-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-103"><a href="confidence-intervals-1.html#cb5-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # VITERBI FILTERING</span></span>
<span id="cb5-104"><a href="confidence-intervals-1.html#cb5-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># vit &lt;- pois.HMM.viterbi(bootstrap_data$sample, m, lambda = l, gamma = g, delta = d)</span></span>
<span id="cb5-105"><a href="confidence-intervals-1.html#cb5-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tab &lt;- as.numeric(table(vit)) / DATA_SIZE</span></span>
<span id="cb5-106"><a href="confidence-intervals-1.html#cb5-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if (any(tab &gt;= 0.99)) {</span></span>
<span id="cb5-107"><a href="confidence-intervals-1.html#cb5-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   counter = counter + 1</span></span>
<span id="cb5-108"><a href="confidence-intervals-1.html#cb5-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   next</span></span>
<span id="cb5-109"><a href="confidence-intervals-1.html#cb5-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb5-110"><a href="confidence-intervals-1.html#cb5-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-111"><a href="confidence-intervals-1.html#cb5-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-112"><a href="confidence-intervals-1.html#cb5-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Label switching</span></span>
<span id="cb5-113"><a href="confidence-intervals-1.html#cb5-113" aria-hidden="true" tabindex="-1"></a>    natural_parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.label.order</span>(<span class="at">m =</span> m, <span class="at">lambda =</span> l,</span>
<span id="cb5-114"><a href="confidence-intervals-1.html#cb5-114" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">gamma =</span> g, <span class="at">delta =</span> d)</span>
<span id="cb5-115"><a href="confidence-intervals-1.html#cb5-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-116"><a href="confidence-intervals-1.html#cb5-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If some parameters are NA for some reason, retry</span></span>
<span id="cb5-117"><a href="confidence-intervals-1.html#cb5-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">anyNA</span>(natural_parameters[params_names], <span class="at">recursive =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb5-118"><a href="confidence-intervals-1.html#cb5-118" aria-hidden="true" tabindex="-1"></a>      <span class="co"># counter3 &lt;- counter3 + 1</span></span>
<span id="cb5-119"><a href="confidence-intervals-1.html#cb5-119" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb5-120"><a href="confidence-intervals-1.html#cb5-120" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-121"><a href="confidence-intervals-1.html#cb5-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-122"><a href="confidence-intervals-1.html#cb5-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if(max(g) &gt;= 0.999999) {</span></span>
<span id="cb5-123"><a href="confidence-intervals-1.html#cb5-123" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   counter_threshold_gamma &lt;- counter_threshold_gamma + 1</span></span>
<span id="cb5-124"><a href="confidence-intervals-1.html#cb5-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }    </span></span>
<span id="cb5-125"><a href="confidence-intervals-1.html#cb5-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if(min(l) &lt;= 1e-3) {</span></span>
<span id="cb5-126"><a href="confidence-intervals-1.html#cb5-126" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   counter_threshold_lambda &lt;- counter_threshold_lambda + 1</span></span>
<span id="cb5-127"><a href="confidence-intervals-1.html#cb5-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb5-128"><a href="confidence-intervals-1.html#cb5-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-129"><a href="confidence-intervals-1.html#cb5-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # ATTEMPT ONE STATE, AIC AND BIC</span></span>
<span id="cb5-130"><a href="confidence-intervals-1.html#cb5-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># lambda1state &lt;- mean(bootstrap_data$data)</span></span>
<span id="cb5-131"><a href="confidence-intervals-1.html#cb5-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># gamma1state &lt;- matrix(1, nrow = 1, ncol = 1)</span></span>
<span id="cb5-132"><a href="confidence-intervals-1.html#cb5-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # parvect &lt;- pois.HMM.pn2pw(m = 1, lambda = lambda1state, gamma = gamma1state)</span></span>
<span id="cb5-133"><a href="confidence-intervals-1.html#cb5-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # mllk &lt;- pois.HMM.mllk(parvect, x_alias = bootstrap_data$data, m_alias = 1)</span></span>
<span id="cb5-134"><a href="confidence-intervals-1.html#cb5-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mllk &lt;- -log(prod(dpois(bootstrap_data$data, lambda1state)))</span></span>
<span id="cb5-135"><a href="confidence-intervals-1.html#cb5-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # np &lt;- length(unlist(parvect))</span></span>
<span id="cb5-136"><a href="confidence-intervals-1.html#cb5-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># np &lt;- 1</span></span>
<span id="cb5-137"><a href="confidence-intervals-1.html#cb5-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># myAIC[idx_sample, &quot;1state&quot;] &lt;- 2 * (mllk + np)</span></span>
<span id="cb5-138"><a href="confidence-intervals-1.html#cb5-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># n &lt;- sum(!is.na(bootstrap_data$data))</span></span>
<span id="cb5-139"><a href="confidence-intervals-1.html#cb5-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># myBIC[idx_sample, &quot;1state&quot;] &lt;- 2 * mllk + np * log(n)</span></span>
<span id="cb5-140"><a href="confidence-intervals-1.html#cb5-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-141"><a href="confidence-intervals-1.html#cb5-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-142"><a href="confidence-intervals-1.html#cb5-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # 2 STATE AIC AND BIC</span></span>
<span id="cb5-143"><a href="confidence-intervals-1.html#cb5-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mllk &lt;- mod_bootstrap$objective</span></span>
<span id="cb5-144"><a href="confidence-intervals-1.html#cb5-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># np &lt;- length(mod_bootstrap$par)</span></span>
<span id="cb5-145"><a href="confidence-intervals-1.html#cb5-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># myAIC[idx_sample, &quot;2state&quot;] &lt;- 2 * (mllk + np)</span></span>
<span id="cb5-146"><a href="confidence-intervals-1.html#cb5-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># myBIC[idx_sample, &quot;2state&quot;] &lt;- 2 * mllk + np * log(n)</span></span>
<span id="cb5-147"><a href="confidence-intervals-1.html#cb5-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-148"><a href="confidence-intervals-1.html#cb5-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LOGLIKELIHOOD VALUES</span></span>
<span id="cb5-149"><a href="confidence-intervals-1.html#cb5-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># nll &lt;- c(nll, mod_bootstrap$objective)</span></span>
<span id="cb5-150"><a href="confidence-intervals-1.html#cb5-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># nll &lt;- mod_bootstrap$objective</span></span>
<span id="cb5-151"><a href="confidence-intervals-1.html#cb5-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if (nll &lt;= 142.1408 | nll &gt;= 215.7791) {</span></span>
<span id="cb5-152"><a href="confidence-intervals-1.html#cb5-152" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   counter = counter + 1</span></span>
<span id="cb5-153"><a href="confidence-intervals-1.html#cb5-153" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   next</span></span>
<span id="cb5-154"><a href="confidence-intervals-1.html#cb5-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb5-155"><a href="confidence-intervals-1.html#cb5-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if (nll &lt;= 146.7423 | nll &gt;= 208.3097) {</span></span>
<span id="cb5-156"><a href="confidence-intervals-1.html#cb5-156" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   counter = counter + 1</span></span>
<span id="cb5-157"><a href="confidence-intervals-1.html#cb5-157" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   next</span></span>
<span id="cb5-158"><a href="confidence-intervals-1.html#cb5-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb5-159"><a href="confidence-intervals-1.html#cb5-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-160"><a href="confidence-intervals-1.html#cb5-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If everything went well, end the &quot;repeat&quot; loop</span></span>
<span id="cb5-161"><a href="confidence-intervals-1.html#cb5-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb5-162"><a href="confidence-intervals-1.html#cb5-162" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-163"><a href="confidence-intervals-1.html#cb5-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The values from gamma are taken columnwise</span></span>
<span id="cb5-164"><a href="confidence-intervals-1.html#cb5-164" aria-hidden="true" tabindex="-1"></a>  natural_parameters <span class="ot">&lt;-</span> <span class="fu">unlist</span>(natural_parameters[params_names])</span>
<span id="cb5-165"><a href="confidence-intervals-1.html#cb5-165" aria-hidden="true" tabindex="-1"></a>  len_par <span class="ot">&lt;-</span> <span class="fu">length</span>(natural_parameters)</span>
<span id="cb5-166"><a href="confidence-intervals-1.html#cb5-166" aria-hidden="true" tabindex="-1"></a>  bootstrap_estimates[idx_sample, <span class="dv">1</span><span class="sc">:</span>len_par] <span class="ot">&lt;-</span> natural_parameters</span>
<span id="cb5-167"><a href="confidence-intervals-1.html#cb5-167" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-168"><a href="confidence-intervals-1.html#cb5-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-169"><a href="confidence-intervals-1.html#cb5-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Lower and upper (2.5% and 97.5%) bounds</span></span>
<span id="cb5-170"><a href="confidence-intervals-1.html#cb5-170" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">apply</span>(bootstrap_estimates, <span class="dv">2</span>, <span class="cf">function</span>(par_estimate) {</span>
<span id="cb5-171"><a href="confidence-intervals-1.html#cb5-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quantile</span>(par_estimate, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb5-172"><a href="confidence-intervals-1.html#cb5-172" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-173"><a href="confidence-intervals-1.html#cb5-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-174"><a href="confidence-intervals-1.html#cb5-174" aria-hidden="true" tabindex="-1"></a>params_names <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">rep</span>(<span class="st">&quot;lambda&quot;</span>, m), <span class="dv">1</span><span class="sc">:</span>m)</span>
<span id="cb5-175"><a href="confidence-intervals-1.html#cb5-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Get row and column indexes for gamma instead of the default</span></span>
<span id="cb5-176"><a href="confidence-intervals-1.html#cb5-176" aria-hidden="true" tabindex="-1"></a><span class="co"># columnwise index: the default indexes are 1:m for the 1st column,</span></span>
<span id="cb5-177"><a href="confidence-intervals-1.html#cb5-177" aria-hidden="true" tabindex="-1"></a><span class="co"># then (m + 1):(2 * m) for the 2nd, etc...</span></span>
<span id="cb5-178"><a href="confidence-intervals-1.html#cb5-178" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (gamma_idx <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m <span class="sc">^</span> <span class="dv">2</span>) {</span>
<span id="cb5-179"><a href="confidence-intervals-1.html#cb5-179" aria-hidden="true" tabindex="-1"></a>  row <span class="ot">&lt;-</span> (gamma_idx <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> m <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-180"><a href="confidence-intervals-1.html#cb5-180" aria-hidden="true" tabindex="-1"></a>  col <span class="ot">&lt;-</span> (gamma_idx <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%/%</span> m <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb5-181"><a href="confidence-intervals-1.html#cb5-181" aria-hidden="true" tabindex="-1"></a>  row_col_idx <span class="ot">&lt;-</span> <span class="fu">c</span>(row, col)</span>
<span id="cb5-182"><a href="confidence-intervals-1.html#cb5-182" aria-hidden="true" tabindex="-1"></a>  params_names <span class="ot">&lt;-</span> <span class="fu">c</span>(params_names,</span>
<span id="cb5-183"><a href="confidence-intervals-1.html#cb5-183" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">paste0</span>(<span class="st">&quot;gamma&quot;</span>,</span>
<span id="cb5-184"><a href="confidence-intervals-1.html#cb5-184" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">paste0</span>(row_col_idx, <span class="at">collapse =</span> <span class="st">&quot;&quot;</span>)))</span>
<span id="cb5-185"><a href="confidence-intervals-1.html#cb5-185" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-186"><a href="confidence-intervals-1.html#cb5-186" aria-hidden="true" tabindex="-1"></a>params_names <span class="ot">&lt;-</span> <span class="fu">c</span>(params_names,</span>
<span id="cb5-187"><a href="confidence-intervals-1.html#cb5-187" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">paste0</span>(<span class="fu">rep</span>(<span class="st">&quot;delta&quot;</span>, m), <span class="dv">1</span><span class="sc">:</span>m))</span>
<span id="cb5-188"><a href="confidence-intervals-1.html#cb5-188" aria-hidden="true" tabindex="-1"></a>bootstrap_CI <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Parameter&quot;</span> <span class="ot">=</span> params_names,</span>
<span id="cb5-189"><a href="confidence-intervals-1.html#cb5-189" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Estimate&quot;</span> <span class="ot">=</span> <span class="fu">c</span>(lambda, gamma, delta),</span>
<span id="cb5-190"><a href="confidence-intervals-1.html#cb5-190" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Lower bound&quot;</span> <span class="ot">=</span> q[<span class="dv">1</span>, ],</span>
<span id="cb5-191"><a href="confidence-intervals-1.html#cb5-191" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Upper bound&quot;</span> <span class="ot">=</span> q[<span class="dv">2</span>, ])</span>
<span id="cb5-192"><a href="confidence-intervals-1.html#cb5-192" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bootstrap_CI, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-193"><a href="confidence-intervals-1.html#cb5-193" aria-hidden="true" tabindex="-1"></a><span class="co"># print(counter)</span></span>
<span id="cb5-194"><a href="confidence-intervals-1.html#cb5-194" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(x = 1:BOOTSTRAP_SAMPLES, y = nll)</span></span>
<span id="cb5-195"><a href="confidence-intervals-1.html#cb5-195" aria-hidden="true" tabindex="-1"></a><span class="co"># hist(nll)</span></span>
<span id="cb5-196"><a href="confidence-intervals-1.html#cb5-196" aria-hidden="true" tabindex="-1"></a><span class="co"># apply(bootstrap_estimates[, 1:2], 2, function(est) {</span></span>
<span id="cb5-197"><a href="confidence-intervals-1.html#cb5-197" aria-hidden="true" tabindex="-1"></a><span class="co">#   hist(est, breaks = &quot;FD&quot;)</span></span>
<span id="cb5-198"><a href="confidence-intervals-1.html#cb5-198" aria-hidden="true" tabindex="-1"></a><span class="co"># })</span></span>
<span id="cb5-199"><a href="confidence-intervals-1.html#cb5-199" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(&quot;Lack of convergence/missing results&quot;, counter2, counter1, &quot;times&quot;))</span></span>
<span id="cb5-200"><a href="confidence-intervals-1.html#cb5-200" aria-hidden="true" tabindex="-1"></a><span class="co"># myAIC[, &quot;pref&quot;] &lt;- ifelse(myAIC[, &quot;1state&quot;] &lt;= myAIC[, &quot;2state&quot;], 1, 2)</span></span>
<span id="cb5-201"><a href="confidence-intervals-1.html#cb5-201" aria-hidden="true" tabindex="-1"></a><span class="co"># myBIC[, &quot;pref&quot;] &lt;- ifelse(myBIC[, &quot;1state&quot;] &lt;= myBIC[, &quot;2state&quot;], 1, 2)</span></span>
<span id="cb5-202"><a href="confidence-intervals-1.html#cb5-202" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(&quot;AIC prefers 1 state&quot;, sum(myAIC[, &quot;pref&quot;] == 1), &quot;times, and 2 states&quot;, sum(myAIC[, &quot;pref&quot;] == 2), &quot;times&quot;))</span></span>
<span id="cb5-203"><a href="confidence-intervals-1.html#cb5-203" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(&quot;BIC prefers 1 state&quot;, sum(myBIC[, &quot;pref&quot;] == 1), &quot;times, and 2 states&quot;, sum(myBIC[, &quot;pref&quot;] == 2), &quot;times&quot;))</span></span>
<span id="cb5-204"><a href="confidence-intervals-1.html#cb5-204" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb5-205"><a href="confidence-intervals-1.html#cb5-205" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb5-206"><a href="confidence-intervals-1.html#cb5-206" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(counter1, &quot;don&#39;t reach any result&quot;))</span></span>
<span id="cb5-207"><a href="confidence-intervals-1.html#cb5-207" aria-hidden="true" tabindex="-1"></a><span class="co"># # print(paste(&quot;conv codes:&quot;, conv1))</span></span>
<span id="cb5-208"><a href="confidence-intervals-1.html#cb5-208" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(counter2, &quot;don&#39;t converge successfully&quot;))</span></span>
<span id="cb5-209"><a href="confidence-intervals-1.html#cb5-209" aria-hidden="true" tabindex="-1"></a><span class="co"># # print(paste(&quot;conv codes:&quot;, conv2))</span></span>
<span id="cb5-210"><a href="confidence-intervals-1.html#cb5-210" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(counter3, &quot;parameters are NA&quot;))</span></span>
<span id="cb5-211"><a href="confidence-intervals-1.html#cb5-211" aria-hidden="true" tabindex="-1"></a><span class="co"># # print(paste(&quot;gamma over the threshold&quot;, counter_threshold_gamma, &quot;times&quot;))</span></span>
<span id="cb5-212"><a href="confidence-intervals-1.html#cb5-212" aria-hidden="true" tabindex="-1"></a><span class="co"># print(paste(&quot;lambda under the threshold&quot;, counter_threshold_lambda, &quot;times&quot;))</span></span></code></pre></div>
<p>It should be noted that some estimates can be very large or very small.
One possible reason is that the randomly generated bootstrap sample might contain long chains of the same values, thus causing a probability in the TPM to be almost 0 or almost 1.
However, a large number of bootstrap samples lowers that risk since we leave out 5% of the most extreme values when computing the 95% CI.</p>
<p>TIMO: REALLY? So the biologist / MD determines which samples are not convenient, leaves them out, and cites us. Patients might die…</p>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="applications.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Data supplements.pdf", "Data supplements.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
