<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Using TMB | [ UNDER CONSTRUCTION ] Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Using TMB | [ UNDER CONSTRUCTION ] Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Using TMB | [ UNDER CONSTRUCTION ] Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Timothée Bacri timothee.bacri@uib.no" />
<meta name="author" content="Jan Bulla jan.bulla@uib.no" />
<meta name="author" content="Geir Berentsen geir.berentsen@nhh.no" />


<meta name="date" content="2021-06-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="parameter-estimation-techniques.html"/>
<link rel="next" href="confidence-intervals.html"/>
<script src="libs/header-attrs-2.9/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Summary</a></li>
<li class="chapter" data-level="1" data-path="state-inf.html"><a href="state-inf.html"><i class="fa fa-check"></i><b>1</b> State inference</a>
<ul>
<li class="chapter" data-level="1.1" data-path="state-inf.html"><a href="state-inf.html#prepare-the-model"><i class="fa fa-check"></i><b>1.1</b> Prepare the model</a></li>
<li class="chapter" data-level="1.2" data-path="state-inf.html"><a href="state-inf.html#setup"><i class="fa fa-check"></i><b>1.2</b> Setup</a></li>
<li class="chapter" data-level="1.3" data-path="state-inf.html"><a href="state-inf.html#log-forward"><i class="fa fa-check"></i><b>1.3</b> Log-forward probabilities</a></li>
<li class="chapter" data-level="1.4" data-path="state-inf.html"><a href="state-inf.html#log-backward"><i class="fa fa-check"></i><b>1.4</b> Log-backward probabilities</a></li>
<li class="chapter" data-level="1.5" data-path="state-inf.html"><a href="state-inf.html#local-decoding"><i class="fa fa-check"></i><b>1.5</b> Smoothing probabilities and local decoding</a></li>
<li class="chapter" data-level="1.6" data-path="state-inf.html"><a href="state-inf.html#forecast"><i class="fa fa-check"></i><b>1.6</b> Forecast, h-step-ahead-probabilities</a></li>
<li class="chapter" data-level="1.7" data-path="state-inf.html"><a href="state-inf.html#global-decoding"><i class="fa fa-check"></i><b>1.7</b> Global decoding using the Viterbi algorithm</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><i class="fa fa-check"></i><b>2</b> Principles of using <strong>TMB</strong> for Maximum Likelihood Estimation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#setting-up-tmb"><i class="fa fa-check"></i><b>2.1</b> Setting up <strong>TMB</strong></a></li>
<li class="chapter" data-level="2.2" data-path="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#getting-started-with-a-linear-regression"><i class="fa fa-check"></i><b>2.2</b> Getting started with a linear regression</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="parameter-estimation-techniques.html"><a href="parameter-estimation-techniques.html"><i class="fa fa-check"></i><b>3</b> Parameter estimation techniques</a></li>
<li class="chapter" data-level="4" data-path="using-tmb.html"><a href="using-tmb.html"><i class="fa fa-check"></i><b>4</b> Using TMB</a>
<ul>
<li class="chapter" data-level="4.1" data-path="using-tmb.html"><a href="using-tmb.html#likelihood-function"><i class="fa fa-check"></i><b>4.1</b> Likelihood function</a></li>
<li class="chapter" data-level="4.2" data-path="using-tmb.html"><a href="using-tmb.html#preparing-data-and-functions"><i class="fa fa-check"></i><b>4.2</b> Preparing data and functions</a></li>
<li class="chapter" data-level="4.3" data-path="using-tmb.html"><a href="using-tmb.html#nested-models"><i class="fa fa-check"></i><b>4.3</b> Nested models</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="using-tmb.html"><a href="using-tmb.html#principle"><i class="fa fa-check"></i><b>4.3.1</b> Principle</a></li>
<li class="chapter" data-level="4.3.2" data-path="using-tmb.html"><a href="using-tmb.html#limit"><i class="fa fa-check"></i><b>4.3.2</b> Limit</a></li>
<li class="chapter" data-level="4.3.3" data-path="using-tmb.html"><a href="using-tmb.html#parameters-equality-constraint"><i class="fa fa-check"></i><b>4.3.3</b> Parameters equality constraint</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="confidence-intervals.html"><a href="confidence-intervals.html"><i class="fa fa-check"></i><b>5</b> Confidence intervals</a>
<ul>
<li class="chapter" data-level="5.1" data-path="confidence-intervals.html"><a href="confidence-intervals.html#generating-data"><i class="fa fa-check"></i><b>5.1</b> Generating data</a></li>
<li class="chapter" data-level="5.2" data-path="confidence-intervals.html"><a href="confidence-intervals.html#relabeling-hmm-states"><i class="fa fa-check"></i><b>5.2</b> Relabeling HMM states</a></li>
<li class="chapter" data-level="5.3" data-path="confidence-intervals.html"><a href="confidence-intervals.html#bootstrap-code"><i class="fa fa-check"></i><b>5.3</b> Bootstrap code</a></li>
<li class="chapter" data-level="5.4" data-path="confidence-intervals.html"><a href="confidence-intervals.html#profiling-the-negative-log-likelihood"><i class="fa fa-check"></i><b>5.4</b> Profiling the negative log-likelihood</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html"><i class="fa fa-check"></i><b>6</b> Application to different data sets</a>
<ul>
<li class="chapter" data-level="6.1" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#tyt-dataset"><i class="fa fa-check"></i><b>6.1</b> TYT dataset</a></li>
<li class="chapter" data-level="6.2" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#simulated-dataset"><i class="fa fa-check"></i><b>6.2</b> Simulated dataset</a></li>
<li class="chapter" data-level="6.3" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#lamb-data"><i class="fa fa-check"></i><b>6.3</b> Lamb data</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="main-github-page.html"><a href="main-github-page.html"><i class="fa fa-check"></i><b>7</b> Main GitHub page</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">[ UNDER CONSTRUCTION ] Fast parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="using-tmb" class="section level1" number="4">
<h1><span class="header-section-number">Chapter 4</span> Using TMB</h1>
<div id="likelihood-function" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Likelihood function</h2>
<p>The function is defined in <em><a href="code/poi_hmm.cpp">poi_hmm.cpp</a></em></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="using-tmb.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;TMB.hpp&gt;</span></span>
<span id="cb1-2"><a href="using-tmb.html#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;../functions/utils.cpp&quot;</span></span>
<span id="cb1-3"><a href="using-tmb.html#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="using-tmb.html#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Likelihood for a poisson hidden markov model. </span></span>
<span id="cb1-5"><a href="using-tmb.html#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;</span>
<span id="cb1-6"><a href="using-tmb.html#cb1-6" aria-hidden="true" tabindex="-1"></a>Type objective_function&lt;Type&gt;::<span class="kw">operator</span>() ()</span>
<span id="cb1-7"><a href="using-tmb.html#cb1-7" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb1-8"><a href="using-tmb.html#cb1-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-9"><a href="using-tmb.html#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Data</span></span>
<span id="cb1-10"><a href="using-tmb.html#cb1-10" aria-hidden="true" tabindex="-1"></a>  DATA_VECTOR(x);          <span class="co">// timeseries vector</span></span>
<span id="cb1-11"><a href="using-tmb.html#cb1-11" aria-hidden="true" tabindex="-1"></a>  DATA_INTEGER(m);         <span class="co">// Number of states m</span></span>
<span id="cb1-12"><a href="using-tmb.html#cb1-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-13"><a href="using-tmb.html#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Parameters</span></span>
<span id="cb1-14"><a href="using-tmb.html#cb1-14" aria-hidden="true" tabindex="-1"></a>  PARAMETER_VECTOR(tlambda);     <span class="co">// conditional log_lambdas&#39;s</span></span>
<span id="cb1-15"><a href="using-tmb.html#cb1-15" aria-hidden="true" tabindex="-1"></a>  PARAMETER_VECTOR(tgamma);      <span class="co">// m(m-1) working parameters of TPM</span></span>
<span id="cb1-16"><a href="using-tmb.html#cb1-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-17"><a href="using-tmb.html#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Uncomment only when using a non-stationary distribution</span></span>
<span id="cb1-18"><a href="using-tmb.html#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">//PARAMETER_VECTOR(tdelta);    // transformed stationary distribution,</span></span>
<span id="cb1-19"><a href="using-tmb.html#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="using-tmb.html#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Transform working parameters to natural parameters:</span></span>
<span id="cb1-21"><a href="using-tmb.html#cb1-21" aria-hidden="true" tabindex="-1"></a>  vector&lt;Type&gt; lambda = tlambda.exp();</span>
<span id="cb1-22"><a href="using-tmb.html#cb1-22" aria-hidden="true" tabindex="-1"></a>  matrix&lt;Type&gt; gamma = Gamma_w2n(m, tgamma);</span>
<span id="cb1-23"><a href="using-tmb.html#cb1-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-24"><a href="using-tmb.html#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct stationary distribution</span></span>
<span id="cb1-25"><a href="using-tmb.html#cb1-25" aria-hidden="true" tabindex="-1"></a>  vector&lt;Type&gt; delta = Stat_dist(m, gamma);</span>
<span id="cb1-26"><a href="using-tmb.html#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If using a non-stationary distribution, use this instead</span></span>
<span id="cb1-27"><a href="using-tmb.html#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">//vector&lt;Type&gt; delta = Delta_w2n(m, tdelta);</span></span>
<span id="cb1-28"><a href="using-tmb.html#cb1-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-29"><a href="using-tmb.html#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get number of timesteps (n)</span></span>
<span id="cb1-30"><a href="using-tmb.html#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n = x.size();</span>
<span id="cb1-31"><a href="using-tmb.html#cb1-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-32"><a href="using-tmb.html#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Evaluate conditional distribution: Put conditional</span></span>
<span id="cb1-33"><a href="using-tmb.html#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">// probabilities of observed x in n times m matrix</span></span>
<span id="cb1-34"><a href="using-tmb.html#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// (one column for each state, one row for each datapoint):</span></span>
<span id="cb1-35"><a href="using-tmb.html#cb1-35" aria-hidden="true" tabindex="-1"></a>  matrix&lt;Type&gt; emission_probs(n, m);</span>
<span id="cb1-36"><a href="using-tmb.html#cb1-36" aria-hidden="true" tabindex="-1"></a>  matrix&lt;Type&gt; row1vec(<span class="dv">1</span>, m);</span>
<span id="cb1-37"><a href="using-tmb.html#cb1-37" aria-hidden="true" tabindex="-1"></a>  row1vec.setOnes();</span>
<span id="cb1-38"><a href="using-tmb.html#cb1-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; n; i++) {</span>
<span id="cb1-39"><a href="using-tmb.html#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (x[i] != x[i]) { <span class="co">// f != f returns true if and only if f is NaN. </span></span>
<span id="cb1-40"><a href="using-tmb.html#cb1-40" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Replace missing values (NA in R, NaN in C++) with 1</span></span>
<span id="cb1-41"><a href="using-tmb.html#cb1-41" aria-hidden="true" tabindex="-1"></a>      emission_probs.row(i) = row1vec;</span>
<span id="cb1-42"><a href="using-tmb.html#cb1-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-43"><a href="using-tmb.html#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb1-44"><a href="using-tmb.html#cb1-44" aria-hidden="true" tabindex="-1"></a>      emission_probs.row(i) = dpois(x[i], lambda, <span class="kw">false</span>);</span>
<span id="cb1-45"><a href="using-tmb.html#cb1-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-46"><a href="using-tmb.html#cb1-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-47"><a href="using-tmb.html#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="using-tmb.html#cb1-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Corresponds to the Zucchini page 333</span></span>
<span id="cb1-49"><a href="using-tmb.html#cb1-49" aria-hidden="true" tabindex="-1"></a>  matrix&lt;Type&gt; foo, P;</span>
<span id="cb1-50"><a href="using-tmb.html#cb1-50" aria-hidden="true" tabindex="-1"></a>  Type mllk, sumfoo, lscale;</span>
<span id="cb1-51"><a href="using-tmb.html#cb1-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-52"><a href="using-tmb.html#cb1-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (m == <span class="dv">1</span>) {</span>
<span id="cb1-53"><a href="using-tmb.html#cb1-53" aria-hidden="true" tabindex="-1"></a>    mllk = - emission_probs.col(<span class="dv">0</span>).array().log().sum();</span>
<span id="cb1-54"><a href="using-tmb.html#cb1-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-55"><a href="using-tmb.html#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use adreport on variables we are interested in:</span></span>
<span id="cb1-56"><a href="using-tmb.html#cb1-56" aria-hidden="true" tabindex="-1"></a>    ADREPORT(lambda);</span>
<span id="cb1-57"><a href="using-tmb.html#cb1-57" aria-hidden="true" tabindex="-1"></a>    ADREPORT(gamma);</span>
<span id="cb1-58"><a href="using-tmb.html#cb1-58" aria-hidden="true" tabindex="-1"></a>    ADREPORT(delta);</span>
<span id="cb1-59"><a href="using-tmb.html#cb1-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-60"><a href="using-tmb.html#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Things we need for local decoding</span></span>
<span id="cb1-61"><a href="using-tmb.html#cb1-61" aria-hidden="true" tabindex="-1"></a>    REPORT(lambda);</span>
<span id="cb1-62"><a href="using-tmb.html#cb1-62" aria-hidden="true" tabindex="-1"></a>    REPORT(gamma);</span>
<span id="cb1-63"><a href="using-tmb.html#cb1-63" aria-hidden="true" tabindex="-1"></a>    REPORT(delta);</span>
<span id="cb1-64"><a href="using-tmb.html#cb1-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-65"><a href="using-tmb.html#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mllk;</span>
<span id="cb1-66"><a href="using-tmb.html#cb1-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-67"><a href="using-tmb.html#cb1-67" aria-hidden="true" tabindex="-1"></a>  foo = (delta * vector&lt;Type&gt;(emission_probs.row(<span class="dv">0</span>))).matrix();</span>
<span id="cb1-68"><a href="using-tmb.html#cb1-68" aria-hidden="true" tabindex="-1"></a>  sumfoo = foo.sum();</span>
<span id="cb1-69"><a href="using-tmb.html#cb1-69" aria-hidden="true" tabindex="-1"></a>  lscale = log(sumfoo);</span>
<span id="cb1-70"><a href="using-tmb.html#cb1-70" aria-hidden="true" tabindex="-1"></a>  foo.transposeInPlace();</span>
<span id="cb1-71"><a href="using-tmb.html#cb1-71" aria-hidden="true" tabindex="-1"></a>  foo /= sumfoo;</span>
<span id="cb1-72"><a href="using-tmb.html#cb1-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">2</span>; i &lt;= n; i++) {</span>
<span id="cb1-73"><a href="using-tmb.html#cb1-73" aria-hidden="true" tabindex="-1"></a>    P = emission_probs.row(i - <span class="dv">1</span>);</span>
<span id="cb1-74"><a href="using-tmb.html#cb1-74" aria-hidden="true" tabindex="-1"></a>    foo = ((foo * gamma).array() * P.array()).matrix();</span>
<span id="cb1-75"><a href="using-tmb.html#cb1-75" aria-hidden="true" tabindex="-1"></a>    sumfoo = foo.sum();</span>
<span id="cb1-76"><a href="using-tmb.html#cb1-76" aria-hidden="true" tabindex="-1"></a>    lscale += log(sumfoo);</span>
<span id="cb1-77"><a href="using-tmb.html#cb1-77" aria-hidden="true" tabindex="-1"></a>    foo /= sumfoo;</span>
<span id="cb1-78"><a href="using-tmb.html#cb1-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-79"><a href="using-tmb.html#cb1-79" aria-hidden="true" tabindex="-1"></a>  mllk = -lscale;</span>
<span id="cb1-80"><a href="using-tmb.html#cb1-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-81"><a href="using-tmb.html#cb1-81" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use adreport on variables for which we want standard errors</span></span>
<span id="cb1-82"><a href="using-tmb.html#cb1-82" aria-hidden="true" tabindex="-1"></a>  ADREPORT(lambda);</span>
<span id="cb1-83"><a href="using-tmb.html#cb1-83" aria-hidden="true" tabindex="-1"></a>  ADREPORT(gamma);</span>
<span id="cb1-84"><a href="using-tmb.html#cb1-84" aria-hidden="true" tabindex="-1"></a>  ADREPORT(delta);</span>
<span id="cb1-85"><a href="using-tmb.html#cb1-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-86"><a href="using-tmb.html#cb1-86" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Variables we need for local decoding and in a convenient format</span></span>
<span id="cb1-87"><a href="using-tmb.html#cb1-87" aria-hidden="true" tabindex="-1"></a>  REPORT(lambda);</span>
<span id="cb1-88"><a href="using-tmb.html#cb1-88" aria-hidden="true" tabindex="-1"></a>  REPORT(gamma);</span>
<span id="cb1-89"><a href="using-tmb.html#cb1-89" aria-hidden="true" tabindex="-1"></a>  REPORT(delta);</span>
<span id="cb1-90"><a href="using-tmb.html#cb1-90" aria-hidden="true" tabindex="-1"></a>  REPORT(n);</span>
<span id="cb1-91"><a href="using-tmb.html#cb1-91" aria-hidden="true" tabindex="-1"></a>  REPORT(emission_probs);</span>
<span id="cb1-92"><a href="using-tmb.html#cb1-92" aria-hidden="true" tabindex="-1"></a>  REPORT(mllk);</span>
<span id="cb1-93"><a href="using-tmb.html#cb1-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-94"><a href="using-tmb.html#cb1-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> mllk;</span>
<span id="cb1-95"><a href="using-tmb.html#cb1-95" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="preparing-data-and-functions" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Preparing data and functions</h2>
<p>Loading of the necessary packages, compilation of the nll function with TMB and subsequent loading, and loading of the auxiliary functions for parameter transformation</p>
<p>With the nll function available in {}, we can carry out the parameter estimation and all pre-/post-processing in {}. In the following we describe the steps to be carried out.</p>
<p>On a minor note, when comparing our estimation results to those reported by <span class="citation">(<a href="#ref-leroux" role="doc-biblioref">Leroux and Puterman 1992</a>)</span>, some non-negligible differences can be noted. The reasons for this are difficult to determine, but some likely explanations are given in the following. First, differences in the parameter estimates may result e.g.~from the optimizing algorithms used and related setting (e.g.~convergence criterion, number of steps, optimization routines used in 1992,…). Moreover, <span class="citation">(<a href="#ref-leroux" role="doc-biblioref">Leroux and Puterman 1992</a>)</span> seem to base their calculations on an altered likelihood, which is reduced by removing the constant term <span class="math inline">\(\sum_{i=1}^{T} \log(x_{i}!)\)</span> from the log-likelihood. This modification may also possess an impact on the behavior of the optimization algorithm, as e.g.~relative convergence criteria and step size could be affected.</p>
</div>
<div id="nested-models" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Nested models</h2>
<div id="principle" class="section level3" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> Principle</h3>
<p>In order to build a nested model, we decide to fix <span class="math inline">\(\lambda_1\)</span> to the value 1.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="using-tmb.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the previous values, and fix some</span></span>
<span id="cb2-2"><a href="using-tmb.html#cb2-2" aria-hidden="true" tabindex="-1"></a>fixed_par_lambda <span class="ot">&lt;-</span> lambda</span>
<span id="cb2-3"><a href="using-tmb.html#cb2-3" aria-hidden="true" tabindex="-1"></a>fixed_par_lambda[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-4"><a href="using-tmb.html#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform them into working parameters</span></span>
<span id="cb2-5"><a href="using-tmb.html#cb2-5" aria-hidden="true" tabindex="-1"></a>new_parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(<span class="at">m =</span> m,</span>
<span id="cb2-6"><a href="using-tmb.html#cb2-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">lambda =</span> fixed_par_lambda,</span>
<span id="cb2-7"><a href="using-tmb.html#cb2-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">gamma =</span> gamma)</span></code></pre></div>
<p>Then, we instruct <strong>TMB</strong> to read these custom parameters.
We indicate fixed values by mapping them to NA values, whereas the variable values need to be mapped to different factor variables.
Lastly, we specify this mapping with the <strong>map</strong> argument when making the <strong>TMB</strong> object.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="using-tmb.html#cb3-1" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tlambda =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>)),</span>
<span id="cb3-2"><a href="using-tmb.html#cb3-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">tgamma =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)))</span>
<span id="cb3-3"><a href="using-tmb.html#cb3-3" aria-hidden="true" tabindex="-1"></a>fixed_par_obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, new_parameters,</span>
<span id="cb3-4"><a href="using-tmb.html#cb3-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>,</span>
<span id="cb3-5"><a href="using-tmb.html#cb3-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">silent =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-6"><a href="using-tmb.html#cb3-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">map =</span> map)</span></code></pre></div>
<p>Estimating of the model and displaying the results is performed as usual</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="using-tmb.html#cb4-1" aria-hidden="true" tabindex="-1"></a>fixed_par_mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> fixed_par_obj_tmb<span class="sc">$</span>par,</span>
<span id="cb4-2"><a href="using-tmb.html#cb4-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">objective =</span> fixed_par_obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb4-3"><a href="using-tmb.html#cb4-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gradient =</span> fixed_par_obj_tmb<span class="sc">$</span>gr,</span>
<span id="cb4-4"><a href="using-tmb.html#cb4-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">hessian =</span> fixed_par_obj_tmb<span class="sc">$</span>he)</span>
<span id="cb4-5"><a href="using-tmb.html#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">sdreport</span>(fixed_par_obj_tmb), <span class="st">&quot;report&quot;</span>)</span></code></pre></div>
<pre><code>##          Estimate Std. Error
## lambda 1.00000000 0.00000000
## lambda 5.50164872 0.30963641
## gamma  0.94561055 0.04791050
## gamma  0.02655944 0.02133283
## gamma  0.05438945 0.04791050
## gamma  0.97344056 0.02133283
## delta  0.32810136 0.22314460
## delta  0.67189864 0.22314460</code></pre>
<p>Note that the standard error of <span class="math inline">\(\lambda_1\)</span> is zero, because it is no longer considered a variable parameter and does not enter the optimization procedure.</p>
</div>
<div id="limit" class="section level3" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> Limit</h3>
<p>This method cannot work in general for working parameters which are not linked to a single natural parameter.
This is because only working parameters can be fixed with this method, but the working parameters of the TPM are not each linked to a single natural parameter. As an example, fixing the natural parameter <span class="math inline">\(gamma_{11}\)</span> is not equivalent to fixing any working parameter <span class="math inline">\(\tau{ij}\)</span>.
Hence, the TPM cannot in general be fixed.</p>
<p>However, if conditions on the natural parameters can be translated to conditions on the working parameters, then there should not be any issue.</p>
<p>We will show in the next section that a type of general constraints on the TPM can be carried out.</p>
<p>In addition, overcoming this restriction should be possible via constrained optimization.</p>
</div>
<div id="parameters-equality-constraint" class="section level3" number="4.3.3">
<h3><span class="header-section-number">4.3.3</span> Parameters equality constraint</h3>
<p>It is noteworthy that more complex constraints are possible as well. For example, to impose equality constraints (such as <span class="math inline">\(\gamma_{11} = \gamma_{22}\)</span>), the corresponding factor level has to be identical for the concerned entries.</p>
<p>As a reminder, we defined the working parameters via
<span class="math display">\[\begin{equation*}
\tau_{ij} = \log\left(\frac{\gamma_{ij}}{1 - \sum_{k \neq i} \gamma_{ik}}\right) = \log(\gamma_{ij}/\gamma_{ii}), \text{ for } i \neq j
\end{equation*}\]</span></p>
<p>With a 2 state HMM, the constraint <span class="math inline">\(\gamma_{11} = \gamma_{22}\)</span> is equivalent to <span class="math inline">\(\gamma_{12} = \gamma_{21}\)</span>.
Thus, the constraint can be transformed into <span class="math inline">\(\tau_{12} = \log(\gamma_{12}/\gamma_{11}) = \log(\gamma_{21}/\gamma_{22}) = \tau_{21}\)</span>.</p>
<p>The mapping parameters must be set to a common factor to be forced equal.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="using-tmb.html#cb6-1" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tlambda =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)),</span>
<span id="cb6-2"><a href="using-tmb.html#cb6-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">tgamma =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>)))</span>
<span id="cb6-3"><a href="using-tmb.html#cb6-3" aria-hidden="true" tabindex="-1"></a>fixed_par_obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb6-4"><a href="using-tmb.html#cb6-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>,</span>
<span id="cb6-5"><a href="using-tmb.html#cb6-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">silent =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-6"><a href="using-tmb.html#cb6-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">map =</span> map)</span>
<span id="cb6-7"><a href="using-tmb.html#cb6-7" aria-hidden="true" tabindex="-1"></a>fixed_par_mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> fixed_par_obj_tmb<span class="sc">$</span>par,</span>
<span id="cb6-8"><a href="using-tmb.html#cb6-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">objective =</span> fixed_par_obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb6-9"><a href="using-tmb.html#cb6-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gradient =</span> fixed_par_obj_tmb<span class="sc">$</span>gr,</span>
<span id="cb6-10"><a href="using-tmb.html#cb6-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">hessian =</span> fixed_par_obj_tmb<span class="sc">$</span>he)</span>
<span id="cb6-11"><a href="using-tmb.html#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Results + check that the constraint is respected</span></span>
<span id="cb6-12"><a href="using-tmb.html#cb6-12" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">sdreport</span>(fixed_par_obj_tmb), <span class="st">&quot;report&quot;</span>)</span>
<span id="cb6-13"><a href="using-tmb.html#cb6-13" aria-hidden="true" tabindex="-1"></a>tpm <span class="ot">&lt;-</span> <span class="fu">matrix</span>(results[<span class="fu">rownames</span>(results) <span class="sc">==</span> <span class="st">&quot;gamma&quot;</span>, <span class="st">&quot;Estimate&quot;</span>],</span>
<span id="cb6-14"><a href="using-tmb.html#cb6-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">nrow =</span> m,</span>
<span id="cb6-15"><a href="using-tmb.html#cb6-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">ncol =</span> m,</span>
<span id="cb6-16"><a href="using-tmb.html#cb6-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">byrow =</span> <span class="cn">FALSE</span>) <span class="co"># Transformations are column-wise by default, be careful!</span></span>
<span id="cb6-17"><a href="using-tmb.html#cb6-17" aria-hidden="true" tabindex="-1"></a>tpm</span></code></pre></div>
<pre><code>##            [,1]       [,2]
## [1,] 0.96759216 0.03240784
## [2,] 0.03240784 0.96759216</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="using-tmb.html#cb8-1" aria-hidden="true" tabindex="-1"></a>tpm[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">==</span> tpm[<span class="dv">2</span>, <span class="dv">2</span>]</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Similar complex constraints on the TPM can also be setup for HMMs with over two states. However, it appears that it can only be done in general when the constraint involves natural parameters of the same row with the exception of a 2 state model. We have not found a way to easily implement equality constraints between natural TPM parameters of different rows. Possible solutions are constrained optimization and different parameterization.</p>
<p>As an example, we will look at a 3 state HMM with the constraint <span class="math inline">\(\gamma_{12} = \gamma_{13}\)</span>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="using-tmb.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with 2 states</span></span>
<span id="cb10-2"><a href="using-tmb.html#cb10-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb10-3"><a href="using-tmb.html#cb10-3" aria-hidden="true" tabindex="-1"></a>TMB_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> tinn_data, <span class="at">m =</span> m)</span>
<span id="cb10-4"><a href="using-tmb.html#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="using-tmb.html#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial set of parameters</span></span>
<span id="cb10-6"><a href="using-tmb.html#cb10-6" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>)</span>
<span id="cb10-7"><a href="using-tmb.html#cb10-7" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>,</span>
<span id="cb10-8"><a href="using-tmb.html#cb10-8" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="fl">0.1</span>,</span>
<span id="cb10-9"><a href="using-tmb.html#cb10-9" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.8</span>), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> m)</span>
<span id="cb10-10"><a href="using-tmb.html#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="using-tmb.html#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn them into working parameters</span></span>
<span id="cb10-12"><a href="using-tmb.html#cb10-12" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m, lambda, gamma)</span>
<span id="cb10-13"><a href="using-tmb.html#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="using-tmb.html#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the TMB object</span></span>
<span id="cb10-15"><a href="using-tmb.html#cb10-15" aria-hidden="true" tabindex="-1"></a>obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb10-16"><a href="using-tmb.html#cb10-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-17"><a href="using-tmb.html#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="using-tmb.html#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize</span></span>
<span id="cb10-19"><a href="using-tmb.html#cb10-19" aria-hidden="true" tabindex="-1"></a>mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj_tmb<span class="sc">$</span>par,</span>
<span id="cb10-20"><a href="using-tmb.html#cb10-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">objective =</span> obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb10-21"><a href="using-tmb.html#cb10-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gradient =</span> obj_tmb<span class="sc">$</span>gr,</span>
<span id="cb10-22"><a href="using-tmb.html#cb10-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">hessian =</span> obj_tmb<span class="sc">$</span>he)</span>
<span id="cb10-23"><a href="using-tmb.html#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="using-tmb.html#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Check convergence</span></span>
<span id="cb10-25"><a href="using-tmb.html#cb10-25" aria-hidden="true" tabindex="-1"></a>mod_tmb<span class="sc">$</span>convergence <span class="sc">==</span> <span class="dv">0</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="using-tmb.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Results</span></span>
<span id="cb12-2"><a href="using-tmb.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">sdreport</span>(obj_tmb), <span class="st">&quot;report&quot;</span>)</span></code></pre></div>
<pre><code>##            Estimate   Std. Error
## lambda 8.281290e-01 5.418824e-01
## lambda 1.705082e+00 2.949769e-01
## lambda 5.514886e+00 3.080238e-01
## gamma  5.516919e-01 3.132490e-01
## gamma  4.596623e-09 5.115944e-05
## gamma  2.749570e-02 2.164849e-02
## gamma  1.989160e-01 2.698088e-01
## gamma  9.772963e-01 3.436716e-02
## gamma  2.453591e-10 2.730433e-06
## gamma  2.493922e-01 2.546636e-01
## gamma  2.270369e-02 3.436717e-02
## gamma  9.725043e-01 2.164849e-02
## delta  3.836408e-02 3.757898e-02
## delta  3.361227e-01 3.144598e-01
## delta  6.255132e-01 3.063220e-01</code></pre>
<p>The transformed constraint becomes <span class="math inline">\(\tau_{12} = \log(\gamma_{12}/\gamma_{11} = \log(\gamma_{13}/\gamma_{11} = \tau_{13}\)</span>.</p>
<p>We need to be careful how we specify the constraint, because the vector <strong>tgamma</strong> will be converted into a matrix column-wise since this is R’s default way to handle matrix-vector conversions.</p>
The <strong>tgamma</strong> matrix looks naturally like
<span class="math display">\[\begin{pmatrix}
         &amp;\tau_{12}&amp;\tau_{13}\\
\tau_{21}&amp;         &amp;\tau_{23}\\
\tau_{31}&amp;\tau_{32}&amp;
\end{pmatrix}\]</span>
<p>As a vector in R, it becomes
<span class="math inline">\(\left(\tau_{21}, \tau_{31}, \tau_{12}, \tau_{32}, \tau_{13}, \tau_{23}\right)\)</span>. Therefore, the constraint needs to be placed on the <span class="math inline">\(3^{rd}\)</span> and <span class="math inline">\(6^{th}\)</span> vector parameter.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="using-tmb.html#cb14-1" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tlambda =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)),</span>
<span id="cb14-2"><a href="using-tmb.html#cb14-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">tgamma =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">6</span>, <span class="dv">8</span>)))</span>
<span id="cb14-3"><a href="using-tmb.html#cb14-3" aria-hidden="true" tabindex="-1"></a>fixed_par_obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb14-4"><a href="using-tmb.html#cb14-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>,</span>
<span id="cb14-5"><a href="using-tmb.html#cb14-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">silent =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-6"><a href="using-tmb.html#cb14-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">map =</span> map)</span>
<span id="cb14-7"><a href="using-tmb.html#cb14-7" aria-hidden="true" tabindex="-1"></a>fixed_par_mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> fixed_par_obj_tmb<span class="sc">$</span>par,</span>
<span id="cb14-8"><a href="using-tmb.html#cb14-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">objective =</span> fixed_par_obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb14-9"><a href="using-tmb.html#cb14-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gradient =</span> fixed_par_obj_tmb<span class="sc">$</span>gr,</span>
<span id="cb14-10"><a href="using-tmb.html#cb14-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">hessian =</span> fixed_par_obj_tmb<span class="sc">$</span>he)</span>
<span id="cb14-11"><a href="using-tmb.html#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Results + check that the constraint is respected</span></span>
<span id="cb14-12"><a href="using-tmb.html#cb14-12" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">sdreport</span>(fixed_par_obj_tmb), <span class="st">&quot;report&quot;</span>)</span>
<span id="cb14-13"><a href="using-tmb.html#cb14-13" aria-hidden="true" tabindex="-1"></a>tpm <span class="ot">&lt;-</span> <span class="fu">matrix</span>(results[<span class="fu">rownames</span>(results) <span class="sc">==</span> <span class="st">&quot;gamma&quot;</span>, <span class="st">&quot;Estimate&quot;</span>],</span>
<span id="cb14-14"><a href="using-tmb.html#cb14-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">nrow =</span> m,</span>
<span id="cb14-15"><a href="using-tmb.html#cb14-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">ncol =</span> m,</span>
<span id="cb14-16"><a href="using-tmb.html#cb14-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">byrow =</span> <span class="cn">FALSE</span>) <span class="co"># Transformations are column-wise by default, be careful!</span></span>
<span id="cb14-17"><a href="using-tmb.html#cb14-17" aria-hidden="true" tabindex="-1"></a>tpm</span></code></pre></div>
<pre><code>##              [,1]         [,2]       [,3]
## [1,] 5.447127e-01 2.276437e-01 0.22764365
## [2,] 2.718007e-09 9.753263e-01 0.02467374
## [3,] 2.710078e-02 2.005408e-10 0.97289922</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="using-tmb.html#cb16-1" aria-hidden="true" tabindex="-1"></a>tpm[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">==</span> tpm[<span class="dv">1</span>, <span class="dv">3</span>]</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Equality constraints involving a diagonal member of the TPM are simpler to specify: the constraint <span class="math inline">\(\gamma_{i,j} = \gamma_{i,i}\)</span> becomes transformed to <span class="math inline">\(\tau_{i,j} = 1\)</span> and this can be specified in the same way the Poisson mean <span class="math inline">\(\lambda_1\)</span> was fixed.</p>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-leroux" class="csl-entry">
Leroux, Brian G., and Martin L. Puterman. 1992. <span>“Maximum-Penalized-Likelihood Estimation for Independent and Markov- Dependent Mixture Models.”</span> <em>Biometrics</em> 48 (2): 545–58. <a href="https://doi.org/10.2307/2532308">https://doi.org/10.2307/2532308</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="parameter-estimation-techniques.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="confidence-intervals.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Data supplements.pdf", "Data supplements.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
