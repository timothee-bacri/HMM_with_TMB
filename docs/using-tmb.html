<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title> 4 Using TMB | [ UNDER CONSTRUCTION ] A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</title>
  <meta name="description" content="This accompanies the article published at [GITHUB LINK]." />
  <meta name="generator" content="bookdown 0.23 and GitBook 2.6.7" />

  <meta property="og:title" content=" 4 Using TMB | [ UNDER CONSTRUCTION ] A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/timothee-bacri/HMM_with_TMB" />
  
  <meta property="og:description" content="This accompanies the article published at [GITHUB LINK]." />
  <meta name="github-repo" content="timothee-bacri/HMM_with_TMB" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content=" 4 Using TMB | [ UNDER CONSTRUCTION ] A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  
  <meta name="twitter:description" content="This accompanies the article published at [GITHUB LINK]." />
  

<meta name="author" content="Timothée Bacri timothee.bacri@uib.no" />
<meta name="author" content="Jan Bulla jan.bulla@uib.no" />
<meta name="author" content="Geir Berentsen geir.berentsen@nhh.no" />
<meta name="author" content="Sondre Hølleland sondre.hoelleland@hi.no" />


<meta name="date" content="2021-08-20" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="parameter-estimation-techniques-for-hmms.html"/>
<link rel="next" href="confidence-intervals.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A gentle tutorial of accelerated<br>parameter and confidence interval<br>estimation for Hidden Markov Models<BR>using Template Model Builder</a></li>
<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Summary</a></li>
<li class="chapter" data-level="2" data-path="principles-of-using-tmb-for-mle.html"><a href="principles-of-using-tmb-for-mle.html"><i class="fa fa-check"></i><b>2</b> Principles of using <code>TMB</code> for MLE</a>
<ul>
<li class="chapter" data-level="2.1" data-path="principles-of-using-tmb-for-mle.html"><a href="principles-of-using-tmb-for-mle.html#setup"><i class="fa fa-check"></i><b>2.1</b> Setup</a></li>
<li class="chapter" data-level="2.2" data-path="principles-of-using-tmb-for-mle.html"><a href="principles-of-using-tmb-for-mle.html#linear-regression-example"><i class="fa fa-check"></i><b>2.2</b> Linear regression example</a></li>
<li class="chapter" data-level="2.3" data-path="principles-of-using-tmb-for-mle.html"><a href="principles-of-using-tmb-for-mle.html#extending-the-c-nll"><i class="fa fa-check"></i><b>2.3</b> Extending the <code>C++</code> nll</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html"><i class="fa fa-check"></i><b>3</b> Parameter estimation techniques<br>for HMMs</a>
<ul>
<li class="chapter" data-level="3.1" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#basic-notation-and-model-setup"><i class="fa fa-check"></i><b>3.1</b> Basic notation and model setup</a></li>
<li class="chapter" data-level="3.2" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#the-likelihood-function-of-an-hmm"><i class="fa fa-check"></i><b>3.2</b> The likelihood function of an HMM</a></li>
<li class="chapter" data-level="3.3" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#forward-backward"><i class="fa fa-check"></i><b>3.3</b> Forward algorithm and<br>backward algorithm</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#setup-1"><i class="fa fa-check"></i><b>3.3.1</b> Setup</a>
<ul>
<li class="chapter" data-level="3.3.1.1" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#prepare-the-model"><i class="fa fa-check"></i><b>3.3.1.1</b> Prepare the model</a></li>
<li class="chapter" data-level="3.3.1.2" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#define-variables"><i class="fa fa-check"></i><b>3.3.1.2</b> Define variables</a></li>
<li class="chapter" data-level="3.3.1.3" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#emissionoutput-probabilities"><i class="fa fa-check"></i><b>3.3.1.3</b> Emission/output probabilities</a></li>
</ul></li>
<li class="chapter" data-level="3.3.2" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#log-forward"><i class="fa fa-check"></i><b>3.3.2</b> Log-forward probabilities</a></li>
<li class="chapter" data-level="3.3.3" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#log-backward"><i class="fa fa-check"></i><b>3.3.3</b> Log-backward probabilities</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#reparameterization-of-the-likelihood-function"><i class="fa fa-check"></i><b>3.4</b> Reparameterization of the<br>likelihood function</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#utility-functions-in-tmb"><i class="fa fa-check"></i><b>3.4.1</b> Utility functions in <code>TMB</code></a></li>
<li class="chapter" data-level="3.4.2" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#utility-functions-in-r"><i class="fa fa-check"></i><b>3.4.2</b> Utility functions in <code>R</code></a>
<ul>
<li class="chapter" data-level="3.4.2.1" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#label-switching"><i class="fa fa-check"></i><b>3.4.2.1</b> Label switching</a></li>
</ul></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="using-tmb.html"><a href="using-tmb.html"><i class="fa fa-check"></i><b>4</b> Using <code>TMB</code></a>
<ul>
<li class="chapter" data-level="4.1" data-path="using-tmb.html"><a href="using-tmb.html#likelihood-function"><i class="fa fa-check"></i><b>4.1</b> Likelihood function</a></li>
<li class="chapter" data-level="4.2" data-path="using-tmb.html"><a href="using-tmb.html#optimization"><i class="fa fa-check"></i><b>4.2</b> Optimization</a></li>
<li class="chapter" data-level="4.3" data-path="using-tmb.html"><a href="using-tmb.html#basic-nested-model-specification"><i class="fa fa-check"></i><b>4.3</b> Basic nested model<br>specification</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="using-tmb.html"><a href="using-tmb.html#principle"><i class="fa fa-check"></i><b>4.3.1</b> Principle</a></li>
<li class="chapter" data-level="4.3.2" data-path="using-tmb.html"><a href="using-tmb.html#limits"><i class="fa fa-check"></i><b>4.3.2</b> Limits</a></li>
<li class="chapter" data-level="4.3.3" data-path="using-tmb.html"><a href="using-tmb.html#param-eq-constraints"><i class="fa fa-check"></i><b>4.3.3</b> Parameter equality<br>constraints</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="using-tmb.html"><a href="using-tmb.html#state-inference"><i class="fa fa-check"></i><b>4.4</b> State inference and forecasting</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="using-tmb.html"><a href="using-tmb.html#local-decoding"><i class="fa fa-check"></i><b>4.4.1</b> Local decoding</a></li>
<li class="chapter" data-level="4.4.2" data-path="using-tmb.html"><a href="using-tmb.html#forecast"><i class="fa fa-check"></i><b>4.4.2</b> Forecast</a></li>
<li class="chapter" data-level="4.4.3" data-path="using-tmb.html"><a href="using-tmb.html#global-decoding"><i class="fa fa-check"></i><b>4.4.3</b> Global decoding</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="using-tmb.html"><a href="using-tmb.html#appendix"><i class="fa fa-check"></i><b>4.5</b> Appendix</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="confidence-intervals.html"><a href="confidence-intervals.html"><i class="fa fa-check"></i><b>5</b> Confidence intervals</a>
<ul>
<li class="chapter" data-level="5.1" data-path="confidence-intervals.html"><a href="confidence-intervals.html#Wald-type"><i class="fa fa-check"></i><b>5.1</b> Wald-type confidence<br>intervals based on the Hessian</a></li>
<li class="chapter" data-level="5.2" data-path="confidence-intervals.html"><a href="confidence-intervals.html#likelihood-profile-based-confidence-intervals"><i class="fa fa-check"></i><b>5.2</b> Likelihood profile based<br>confidence intervals</a></li>
<li class="chapter" data-level="5.3" data-path="confidence-intervals.html"><a href="confidence-intervals.html#bootstrap-based-confidence-intervals"><i class="fa fa-check"></i><b>5.3</b> Bootstrap-based<br>confidence intervals</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="confidence-intervals.html"><a href="confidence-intervals.html#generating-data"><i class="fa fa-check"></i><b>5.3.1</b> Generating data</a></li>
<li class="chapter" data-level="5.3.2" data-path="confidence-intervals.html"><a href="confidence-intervals.html#bootstrap"><i class="fa fa-check"></i><b>5.3.2</b> Bootstrap</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html"><i class="fa fa-check"></i><b>6</b> Application to different data sets</a>
<ul>
<li class="chapter" data-level="6.1" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#tyt-data"><i class="fa fa-check"></i><b>6.1</b> TYT data</a></li>
<li class="chapter" data-level="6.2" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#lamb-data"><i class="fa fa-check"></i><b>6.2</b> Lamb data</a></li>
<li class="chapter" data-level="6.3" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#simulated-data"><i class="fa fa-check"></i><b>6.3</b> Simulated data</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="github.html"><a href="github.html"><i class="fa fa-check"></i><b>7</b> GitHub</a>
<ul>
<li class="chapter" data-level="7.1" data-path="github.html"><a href="github.html#directory-structure"><i class="fa fa-check"></i><b>7.1</b> Directory structure</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="github.html"><a href="github.html#code"><i class="fa fa-check"></i><b>7.1.1</b> code/</a></li>
<li class="chapter" data-level="7.1.2" data-path="github.html"><a href="github.html#linreg.cpp"><i class="fa fa-check"></i><b>7.1.2</b> code/linreg.cpp</a></li>
<li class="chapter" data-level="7.1.3" data-path="github.html"><a href="github.html#codelinreg.dll"><i class="fa fa-check"></i><b>7.1.3</b> code/linreg.dll</a></li>
<li class="chapter" data-level="7.1.4" data-path="github.html"><a href="github.html#linreg.o"><i class="fa fa-check"></i><b>7.1.4</b> code/linreg.o</a></li>
<li class="chapter" data-level="7.1.5" data-path="github.html"><a href="github.html#linreg_extended.cpp"><i class="fa fa-check"></i><b>7.1.5</b> code/linreg_extended.cpp</a></li>
<li class="chapter" data-level="7.1.6" data-path="github.html"><a href="github.html#codelinreg_extended.dll"><i class="fa fa-check"></i><b>7.1.6</b> code/linreg_extended.dll</a></li>
<li class="chapter" data-level="7.1.7" data-path="github.html"><a href="github.html#codelinreg_extended.o"><i class="fa fa-check"></i><b>7.1.7</b> code/linreg_extended.o</a></li>
<li class="chapter" data-level="7.1.8" data-path="github.html"><a href="github.html#main.R"><i class="fa fa-check"></i><b>7.1.8</b> code/main.R</a></li>
<li class="chapter" data-level="7.1.9" data-path="github.html"><a href="github.html#codepackages.r"><i class="fa fa-check"></i><b>7.1.9</b> code/packages.R</a></li>
<li class="chapter" data-level="7.1.10" data-path="github.html"><a href="github.html#poi_hmm.cpp"><i class="fa fa-check"></i><b>7.1.10</b> code/poi_hmm.cpp</a></li>
<li class="chapter" data-level="7.1.11" data-path="github.html"><a href="github.html#codepoi_hmm.dll"><i class="fa fa-check"></i><b>7.1.11</b> code/poi_hmm.dll</a></li>
<li class="chapter" data-level="7.1.12" data-path="github.html"><a href="github.html#codepoi_hmm.o"><i class="fa fa-check"></i><b>7.1.12</b> code/poi_hmm.o</a></li>
<li class="chapter" data-level="7.1.13" data-path="github.html"><a href="github.html#poi_hmm_lamb.R"><i class="fa fa-check"></i><b>7.1.13</b> code/poi_hmm_lamb.R</a></li>
<li class="chapter" data-level="7.1.14" data-path="github.html"><a href="github.html#poi_hmm_simu1.R"><i class="fa fa-check"></i><b>7.1.14</b> code/poi_hmm_simu1.R</a></li>
<li class="chapter" data-level="7.1.15" data-path="github.html"><a href="github.html#poi_hmm_simu2.R"><i class="fa fa-check"></i><b>7.1.15</b> code/poi_hmm_simu2.R</a></li>
<li class="chapter" data-level="7.1.16" data-path="github.html"><a href="github.html#poi_hmm_tinn.R"><i class="fa fa-check"></i><b>7.1.16</b> code/poi_hmm_tinn.R</a></li>
<li class="chapter" data-level="7.1.17" data-path="github.html"><a href="github.html#setup_parameters.R"><i class="fa fa-check"></i><b>7.1.17</b> code/setup_parameters.R</a></li>
<li class="chapter" data-level="7.1.18" data-path="github.html"><a href="github.html#data"><i class="fa fa-check"></i><b>7.1.18</b> data/</a></li>
<li class="chapter" data-level="7.1.19" data-path="github.html"><a href="github.html#fetal-lamb.RData"><i class="fa fa-check"></i><b>7.1.19</b> data/fetal-lamb.RData</a></li>
<li class="chapter" data-level="7.1.20" data-path="github.html"><a href="github.html#dataresults_lamb.rdata"><i class="fa fa-check"></i><b>7.1.20</b> data/results_lamb.RData</a></li>
<li class="chapter" data-level="7.1.21" data-path="github.html"><a href="github.html#dataresults_simu1.rdata"><i class="fa fa-check"></i><b>7.1.21</b> data/results_simu1.RData</a></li>
<li class="chapter" data-level="7.1.22" data-path="github.html"><a href="github.html#dataresults_simu2.rdata"><i class="fa fa-check"></i><b>7.1.22</b> data/results_simu2.RData</a></li>
<li class="chapter" data-level="7.1.23" data-path="github.html"><a href="github.html#dataresults_tinn.rdata"><i class="fa fa-check"></i><b>7.1.23</b> data/results_tinn.RData</a></li>
<li class="chapter" data-level="7.1.24" data-path="github.html"><a href="github.html#tinnitus.RData"><i class="fa fa-check"></i><b>7.1.24</b> data/tinnitus.RData</a></li>
<li class="chapter" data-level="7.1.25" data-path="github.html"><a href="github.html#functions"><i class="fa fa-check"></i><b>7.1.25</b> functions/</a></li>
<li class="chapter" data-level="7.1.26" data-path="github.html"><a href="github.html#functionsutils.cpp"><i class="fa fa-check"></i><b>7.1.26</b> functions/utils.cpp</a></li>
<li class="chapter" data-level="7.1.27" data-path="github.html"><a href="github.html#functionsutils.r"><i class="fa fa-check"></i><b>7.1.27</b> functions/utils.R</a></li>
<li class="chapter" data-level="7.1.28" data-path="github.html"><a href="github.html#utils_linreg_extended.cpp"><i class="fa fa-check"></i><b>7.1.28</b> functions/utils_linreg_extended.cpp</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">[ UNDER CONSTRUCTION ] A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="using-tmb" class="section level1" number="4">
<h1><span class="header-section-number"> 4</span> Using <code>TMB</code></h1>
<div id="likelihood-function" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Likelihood function</h2>
<p>The function is defined in <em><a href="github.html#poi_hmm.cpp">code/poi_hmm.cpp</a></em></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb47-1"><a href="using-tmb.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;TMB.hpp&gt;</span></span>
<span id="cb47-2"><a href="using-tmb.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;../functions/utils.cpp&quot;</span></span>
<span id="cb47-3"><a href="using-tmb.html#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="using-tmb.html#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Likelihood for a poisson hidden markov model. </span></span>
<span id="cb47-5"><a href="using-tmb.html#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;</span>
<span id="cb47-6"><a href="using-tmb.html#cb47-6" aria-hidden="true" tabindex="-1"></a>Type objective_function&lt;Type&gt;::<span class="kw">operator</span>() ()</span>
<span id="cb47-7"><a href="using-tmb.html#cb47-7" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb47-8"><a href="using-tmb.html#cb47-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-9"><a href="using-tmb.html#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Data</span></span>
<span id="cb47-10"><a href="using-tmb.html#cb47-10" aria-hidden="true" tabindex="-1"></a>  DATA_VECTOR(x);          <span class="co">// timeseries vector</span></span>
<span id="cb47-11"><a href="using-tmb.html#cb47-11" aria-hidden="true" tabindex="-1"></a>  DATA_INTEGER(m);         <span class="co">// Number of states m</span></span>
<span id="cb47-12"><a href="using-tmb.html#cb47-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-13"><a href="using-tmb.html#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Parameters</span></span>
<span id="cb47-14"><a href="using-tmb.html#cb47-14" aria-hidden="true" tabindex="-1"></a>  PARAMETER_VECTOR(tlambda);     <span class="co">// conditional log_lambdas&#39;s</span></span>
<span id="cb47-15"><a href="using-tmb.html#cb47-15" aria-hidden="true" tabindex="-1"></a>  PARAMETER_VECTOR(tgamma);      <span class="co">// m(m-1) working parameters of TPM</span></span>
<span id="cb47-16"><a href="using-tmb.html#cb47-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-17"><a href="using-tmb.html#cb47-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Uncomment only when using a non-stationary distribution</span></span>
<span id="cb47-18"><a href="using-tmb.html#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">//PARAMETER_VECTOR(tdelta);    // transformed stationary distribution,</span></span>
<span id="cb47-19"><a href="using-tmb.html#cb47-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-20"><a href="using-tmb.html#cb47-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Transform working parameters to natural parameters:</span></span>
<span id="cb47-21"><a href="using-tmb.html#cb47-21" aria-hidden="true" tabindex="-1"></a>  vector&lt;Type&gt; lambda = tlambda.exp();</span>
<span id="cb47-22"><a href="using-tmb.html#cb47-22" aria-hidden="true" tabindex="-1"></a>  matrix&lt;Type&gt; gamma = gamma_w2n(m, tgamma);</span>
<span id="cb47-23"><a href="using-tmb.html#cb47-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-24"><a href="using-tmb.html#cb47-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct stationary distribution</span></span>
<span id="cb47-25"><a href="using-tmb.html#cb47-25" aria-hidden="true" tabindex="-1"></a>  vector&lt;Type&gt; delta = stat_dist(m, gamma);</span>
<span id="cb47-26"><a href="using-tmb.html#cb47-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If using a non-stationary distribution, use this instead</span></span>
<span id="cb47-27"><a href="using-tmb.html#cb47-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">//vector&lt;Type&gt; delta = delta_w2n(m, tdelta);</span></span>
<span id="cb47-28"><a href="using-tmb.html#cb47-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-29"><a href="using-tmb.html#cb47-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get number of timesteps (n)</span></span>
<span id="cb47-30"><a href="using-tmb.html#cb47-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n = x.size();</span>
<span id="cb47-31"><a href="using-tmb.html#cb47-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-32"><a href="using-tmb.html#cb47-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Evaluate conditional distribution: Put conditional</span></span>
<span id="cb47-33"><a href="using-tmb.html#cb47-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">// probabilities of observed x in n times m matrix</span></span>
<span id="cb47-34"><a href="using-tmb.html#cb47-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// (one column for each state, one row for each datapoint):</span></span>
<span id="cb47-35"><a href="using-tmb.html#cb47-35" aria-hidden="true" tabindex="-1"></a>  matrix&lt;Type&gt; emission_probs(n, m);</span>
<span id="cb47-36"><a href="using-tmb.html#cb47-36" aria-hidden="true" tabindex="-1"></a>  matrix&lt;Type&gt; row1vec(<span class="dv">1</span>, m);</span>
<span id="cb47-37"><a href="using-tmb.html#cb47-37" aria-hidden="true" tabindex="-1"></a>  row1vec.setOnes();</span>
<span id="cb47-38"><a href="using-tmb.html#cb47-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; n; i++) {</span>
<span id="cb47-39"><a href="using-tmb.html#cb47-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (x[i] != x[i]) { <span class="co">// f != f returns true if and only if f is NaN. </span></span>
<span id="cb47-40"><a href="using-tmb.html#cb47-40" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Replace missing values (NA in R, NaN in C++) with 1</span></span>
<span id="cb47-41"><a href="using-tmb.html#cb47-41" aria-hidden="true" tabindex="-1"></a>      emission_probs.row(i) = row1vec;</span>
<span id="cb47-42"><a href="using-tmb.html#cb47-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb47-43"><a href="using-tmb.html#cb47-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb47-44"><a href="using-tmb.html#cb47-44" aria-hidden="true" tabindex="-1"></a>      emission_probs.row(i) = dpois(x[i], lambda, <span class="kw">false</span>);</span>
<span id="cb47-45"><a href="using-tmb.html#cb47-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb47-46"><a href="using-tmb.html#cb47-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-47"><a href="using-tmb.html#cb47-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-48"><a href="using-tmb.html#cb47-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Corresponds to Zucchini&#39;s book page 333</span></span>
<span id="cb47-49"><a href="using-tmb.html#cb47-49" aria-hidden="true" tabindex="-1"></a>  matrix&lt;Type&gt; foo, P;</span>
<span id="cb47-50"><a href="using-tmb.html#cb47-50" aria-hidden="true" tabindex="-1"></a>  Type mllk, sumfoo, lscale;</span>
<span id="cb47-51"><a href="using-tmb.html#cb47-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-52"><a href="using-tmb.html#cb47-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">// No need for an &quot;else&quot; statement because we return</span></span>
<span id="cb47-53"><a href="using-tmb.html#cb47-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">// the likelihood directly if m is 1, thus ending the function</span></span>
<span id="cb47-54"><a href="using-tmb.html#cb47-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (m == <span class="dv">1</span>) {</span>
<span id="cb47-55"><a href="using-tmb.html#cb47-55" aria-hidden="true" tabindex="-1"></a>    mllk = - emission_probs.col(<span class="dv">0</span>).array().log().sum();</span>
<span id="cb47-56"><a href="using-tmb.html#cb47-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-57"><a href="using-tmb.html#cb47-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use adreport on variables we are interested in:</span></span>
<span id="cb47-58"><a href="using-tmb.html#cb47-58" aria-hidden="true" tabindex="-1"></a>    ADREPORT(lambda);</span>
<span id="cb47-59"><a href="using-tmb.html#cb47-59" aria-hidden="true" tabindex="-1"></a>    ADREPORT(gamma);</span>
<span id="cb47-60"><a href="using-tmb.html#cb47-60" aria-hidden="true" tabindex="-1"></a>    ADREPORT(delta);</span>
<span id="cb47-61"><a href="using-tmb.html#cb47-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-62"><a href="using-tmb.html#cb47-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Things we need for local decoding</span></span>
<span id="cb47-63"><a href="using-tmb.html#cb47-63" aria-hidden="true" tabindex="-1"></a>    REPORT(lambda);</span>
<span id="cb47-64"><a href="using-tmb.html#cb47-64" aria-hidden="true" tabindex="-1"></a>    REPORT(gamma);</span>
<span id="cb47-65"><a href="using-tmb.html#cb47-65" aria-hidden="true" tabindex="-1"></a>    REPORT(delta);</span>
<span id="cb47-66"><a href="using-tmb.html#cb47-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb47-67"><a href="using-tmb.html#cb47-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mllk;</span>
<span id="cb47-68"><a href="using-tmb.html#cb47-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-69"><a href="using-tmb.html#cb47-69" aria-hidden="true" tabindex="-1"></a>  foo = (delta * vector&lt;Type&gt;(emission_probs.row(<span class="dv">0</span>))).matrix();</span>
<span id="cb47-70"><a href="using-tmb.html#cb47-70" aria-hidden="true" tabindex="-1"></a>  sumfoo = foo.sum();</span>
<span id="cb47-71"><a href="using-tmb.html#cb47-71" aria-hidden="true" tabindex="-1"></a>  lscale = log(sumfoo);</span>
<span id="cb47-72"><a href="using-tmb.html#cb47-72" aria-hidden="true" tabindex="-1"></a>  foo.transposeInPlace();</span>
<span id="cb47-73"><a href="using-tmb.html#cb47-73" aria-hidden="true" tabindex="-1"></a>  foo /= sumfoo;</span>
<span id="cb47-74"><a href="using-tmb.html#cb47-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">2</span>; i &lt;= n; i++) {</span>
<span id="cb47-75"><a href="using-tmb.html#cb47-75" aria-hidden="true" tabindex="-1"></a>    P = emission_probs.row(i - <span class="dv">1</span>);</span>
<span id="cb47-76"><a href="using-tmb.html#cb47-76" aria-hidden="true" tabindex="-1"></a>    foo = ((foo * gamma).array() * P.array()).matrix();</span>
<span id="cb47-77"><a href="using-tmb.html#cb47-77" aria-hidden="true" tabindex="-1"></a>    sumfoo = foo.sum();</span>
<span id="cb47-78"><a href="using-tmb.html#cb47-78" aria-hidden="true" tabindex="-1"></a>    lscale += log(sumfoo);</span>
<span id="cb47-79"><a href="using-tmb.html#cb47-79" aria-hidden="true" tabindex="-1"></a>    foo /= sumfoo;</span>
<span id="cb47-80"><a href="using-tmb.html#cb47-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-81"><a href="using-tmb.html#cb47-81" aria-hidden="true" tabindex="-1"></a>  mllk = -lscale;</span>
<span id="cb47-82"><a href="using-tmb.html#cb47-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-83"><a href="using-tmb.html#cb47-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use adreport on variables for which we want standard errors</span></span>
<span id="cb47-84"><a href="using-tmb.html#cb47-84" aria-hidden="true" tabindex="-1"></a>  ADREPORT(lambda);</span>
<span id="cb47-85"><a href="using-tmb.html#cb47-85" aria-hidden="true" tabindex="-1"></a>  ADREPORT(gamma);</span>
<span id="cb47-86"><a href="using-tmb.html#cb47-86" aria-hidden="true" tabindex="-1"></a>  ADREPORT(delta);</span>
<span id="cb47-87"><a href="using-tmb.html#cb47-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-88"><a href="using-tmb.html#cb47-88" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Variables we need for local decoding and in a convenient format</span></span>
<span id="cb47-89"><a href="using-tmb.html#cb47-89" aria-hidden="true" tabindex="-1"></a>  REPORT(lambda);</span>
<span id="cb47-90"><a href="using-tmb.html#cb47-90" aria-hidden="true" tabindex="-1"></a>  REPORT(gamma);</span>
<span id="cb47-91"><a href="using-tmb.html#cb47-91" aria-hidden="true" tabindex="-1"></a>  REPORT(delta);</span>
<span id="cb47-92"><a href="using-tmb.html#cb47-92" aria-hidden="true" tabindex="-1"></a>  REPORT(n);</span>
<span id="cb47-93"><a href="using-tmb.html#cb47-93" aria-hidden="true" tabindex="-1"></a>  REPORT(emission_probs);</span>
<span id="cb47-94"><a href="using-tmb.html#cb47-94" aria-hidden="true" tabindex="-1"></a>  REPORT(mllk);</span>
<span id="cb47-95"><a href="using-tmb.html#cb47-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-96"><a href="using-tmb.html#cb47-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> mllk;</span>
<span id="cb47-97"><a href="using-tmb.html#cb47-97" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="optimization" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Optimization</h2>
<p>Before we can fit the model, we need to load some necessary packages and data files. We also need to compile the <code>C++</code> code and load the functions into our working environment in <code>R</code>.</p>
<ol style="list-style-type: lower-roman">
<li>We start by compiling the <code>C++</code> code for computing the likelihood and its gradients. Once it is compiled, we can load the TMB likelihood object into <code>R</code> – making it available from <code>R</code>.</li>
</ol>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="using-tmb.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load TMB and optimization packages</span></span>
<span id="cb48-2"><a href="using-tmb.html#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TMB)</span>
<span id="cb48-3"><a href="using-tmb.html#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(optimr)</span>
<span id="cb48-4"><a href="using-tmb.html#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the C++ file containing the TMB code</span></span>
<span id="cb48-5"><a href="using-tmb.html#cb48-5" aria-hidden="true" tabindex="-1"></a>TMB<span class="sc">::</span><span class="fu">compile</span>(<span class="st">&quot;code/poi_hmm.cpp&quot;</span>)</span>
<span id="cb48-6"><a href="using-tmb.html#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load it</span></span>
<span id="cb48-7"><a href="using-tmb.html#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dyn.load</span>(<span class="fu">dynlib</span>(<span class="st">&quot;code/poi_hmm&quot;</span>))</span></code></pre></div>
<p>Next, we need to load the necessary packages and the utility <code>R</code> functions.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="using-tmb.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the parameter transformation function</span></span>
<span id="cb49-2"><a href="using-tmb.html#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;functions/utils.R&quot;</span>)</span></code></pre></div>
<ol start="2" style="list-style-type: lower-roman">
<li>The data are part of a large data set collected with the “Track Your Tinnitus” (TYT) mobile application, a detailed description of which is presented in <span class="citation">(<a href="#ref-pryss" role="doc-biblioref">Pryss, Reichert, Herrmann, Langguth, &amp; Schlee, 2015</a>; <a href="#ref-pryssa" role="doc-biblioref">Pryss, Reichert, Langguth, &amp; Schlee, 2015</a>)</span>.
We analyze 87 successive days of the “arousal” variable, which is measured on a discrete scale.
Higher values correspond to a higher degree of excitement, lower values to a more calm emotional state <span class="citation">(for details, see <a href="#ref-probst" role="doc-biblioref">Probst, Pryss, Langguth, &amp; Schlee, 2016</a>)</span>.
The data can be loaded by a simple call.</li>
</ol>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="using-tmb.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;data/tinnitus.RData&quot;</span>)</span></code></pre></div>
<p>Figure <a href="using-tmb.html#fig:3tinnitus-fig">4.1</a> presents the raw data in the <a href="#table:tinnitus_data">Table</a> below, which are also available for download at <em><a href="github.html#tinnitus.RData">data/tinnitus.RData</a></em>.</p>
<!-- html table generated in R 4.0.5 by xtable 1.8-4 package -->
<!-- Fri Aug 20 00:48:54 2021 -->
<table border="1">
<caption align="bottom">
TYT data. Observations collected by the TYT app on 87 successive days (from left to right).
</caption>
<tr>
<td>
6 5 3 6 4 3 5 6 6 6 4 6 6 4 6 6 6 6 6 4 6 5 6 7 6 5 5 5 7 6 5 6 5 6 6 6 5 6 7 7 6 7 6 6 6 6 5 7 6 1 6 0 2 1 6 7 6 6 6 5 5 6 6 2 5 0 1 1 1 2 3 1 3 1 3 0 1 1 1 4 1 4 1 2 2 2 0
</td>
</tr>
<a name=table:tinnitus_data></a>
</table>
<div class="figure"><span style="display:block;" id="fig:3tinnitus-fig"></span>
<img src="Data-supplements_files/figure-html/3tinnitus-fig-1.png" alt="Plot of observations from TYT app data for 87 succesive days." width="672" />
<p class="caption">
Figure 4.1: Plot of observations from TYT app data for 87 succesive days.
</p>
</div>
<ol start="3" style="list-style-type: lower-roman">
<li>Initialization of the number of states and starting (or initial) values for the optimization.</li>
</ol>
<p>First, the number of states needs to be determined. As explained by <span class="citation"><a href="#ref-pohlea" role="doc-biblioref">Pohle, Langrock, van Beest, &amp; Schmidt</a> (<a href="#ref-pohlea" role="doc-biblioref">2017b</a>)</span>, <span class="citation"><a href="#ref-pohle" role="doc-biblioref">Pohle, Langrock, van Beest, &amp; Schmidt</a> (<a href="#ref-pohle" role="doc-biblioref">2017a</a>)</span>, and <span class="citation">(<a href="#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, &amp; Langrock, 2016</a>, Section 6)</span> (to name only a few), usually one would first fit models with a different number of states. Then, these models are evaluated e.g. by means of model selection criteria <span class="citation">(as carried out by, <a href="#ref-leroux" role="doc-biblioref">Leroux &amp; Puterman, 1992</a>)</span> or prediction performance <span class="citation">(<a href="#ref-celeux" role="doc-biblioref">Celeux &amp; Durand, 2008</a>)</span>.
As shown in <a href="using-tmb.html#appendix">the appendix</a>, the model selection procedure shows that both AIC and BIC prefer a two-state model over a Poisson regression and over a model with three or four states. Consequently, we focus on the two-state model in the following.<br />
The list object <code>TMB_data</code> contains the data and the number of states.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="using-tmb.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with 2 states</span></span>
<span id="cb51-2"><a href="using-tmb.html#cb51-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb51-3"><a href="using-tmb.html#cb51-3" aria-hidden="true" tabindex="-1"></a>TMB_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> tinn_data, <span class="at">m =</span> m)</span></code></pre></div>
<p>Secondly, initial values for the optimization procedure need to be defined.
Although we will apply unconstrained optimization, we initialize the natural parameters, because this is much more intuitive and practical than handling the working parameters.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="using-tmb.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate initial set of parameters for optimization</span></span>
<span id="cb52-2"><a href="using-tmb.html#cb52-2" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb52-3"><a href="using-tmb.html#cb52-3" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>,</span>
<span id="cb52-4"><a href="using-tmb.html#cb52-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> m)</span></code></pre></div>
<ol start="4" style="list-style-type: lower-roman">
<li>Transformation from natural to working parameters</li>
</ol>
<p>The previously created initial values are transformed and stored in the list <code>parameters</code> for the optimization procedure.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="using-tmb.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn them into working parameters</span></span>
<span id="cb53-2"><a href="using-tmb.html#cb53-2" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m, lambda, gamma)</span></code></pre></div>
<ol start="22" style="list-style-type: lower-alpha">
<li>Creation of the <code>TMB</code> negative log-likelihood function with its derivatives</li>
</ol>
<p>This object, stored as <code>obj_tmb</code> requires the data, the initial values, and the previously created DLL as input.
Setting argument <code>silent = TRUE</code> disables tracing information and is only used here to avoid excessive output.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="using-tmb.html#cb54-1" aria-hidden="true" tabindex="-1"></a>obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb54-2"><a href="using-tmb.html#cb54-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>This object also contains the previously defined initial values as a vector (<code>par</code>) rather than a list.
The negative log-likelihood (<code>fn</code>), its gradient (<code>gr</code>), and Hessian (<code>he</code>) are functions of the parameters (in vector form) while the data are considered fixed:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="using-tmb.html#cb55-1" aria-hidden="true" tabindex="-1"></a>obj_tmb<span class="sc">$</span>par</span></code></pre></div>
<pre><code>##   tlambda   tlambda    tgamma    tgamma 
##  0.000000  1.098612 -1.386294 -1.386294</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="using-tmb.html#cb57-1" aria-hidden="true" tabindex="-1"></a>obj_tmb<span class="sc">$</span><span class="fu">fn</span>(obj_tmb<span class="sc">$</span>par)</span></code></pre></div>
<pre><code>## [1] 228.3552</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="using-tmb.html#cb59-1" aria-hidden="true" tabindex="-1"></a>obj_tmb<span class="sc">$</span><span class="fu">gr</span>(obj_tmb<span class="sc">$</span>par)</span></code></pre></div>
<pre><code>##          [,1]      [,2]     [,3]      [,4]
## [1,] -3.60306 -146.0336 10.52832 -1.031706</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="using-tmb.html#cb61-1" aria-hidden="true" tabindex="-1"></a>obj_tmb<span class="sc">$</span><span class="fu">he</span>(obj_tmb<span class="sc">$</span>par)</span></code></pre></div>
<pre><code>##           [,1]       [,2]       [,3]       [,4]
## [1,]  1.902009  -5.877900 -1.3799682  2.4054017
## [2,] -5.877900 188.088247 -4.8501589  2.3434284
## [3,] -1.379968  -4.850159  9.6066700 -0.8410438
## [4,]  2.405402   2.343428 -0.8410438  0.7984216</code></pre>
<ol start="6" style="list-style-type: lower-roman">
<li>Execution of the optimization</li>
</ol>
<p>For this step we rely again on the optimizer implemented in the <code>nlminb</code> function.
The arguments, i.e.~ initial values for the parameters and the function to be optimized, are extracted from the previously created TMB object.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="using-tmb.html#cb63-1" aria-hidden="true" tabindex="-1"></a>mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj_tmb<span class="sc">$</span>par, <span class="at">objective =</span> obj_tmb<span class="sc">$</span>fn)</span>
<span id="cb63-2"><a href="using-tmb.html#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that it converged successfully</span></span>
<span id="cb63-3"><a href="using-tmb.html#cb63-3" aria-hidden="true" tabindex="-1"></a>mod_tmb<span class="sc">$</span>convergence <span class="sc">==</span> <span class="dv">0</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>It is noteworthy that various alternatives to <code>nlminb</code> exist.
Nevertheless, we focus on this established optimization routine because of its high speed of convergence.</p>
<ol start="7" style="list-style-type: lower-roman">
<li>Obtaining ML estimates</li>
</ol>
<p>Obtaining the ML estimates of the natural parameters together with their standard errors is possible by using the previously introduced command <code>sdreport</code>.</p>
<p>Recall that this requires the parameters of interest to be treated by the <code>ADREPORT</code> statement in the <code>C++</code> part. It should be noted that the presentation of the set of parameters <code>gamma</code> below results from a column-wise representation of the TPM.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="using-tmb.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">sdreport</span>(obj_tmb, <span class="at">par.fixed =</span> mod_tmb<span class="sc">$</span>par), <span class="st">&quot;report&quot;</span>)</span></code></pre></div>
<pre><code>##          Estimate Std. Error
## lambda 1.63641070 0.27758294
## lambda 5.53309626 0.31876141
## gamma  0.94980192 0.04374682
## gamma  0.02592209 0.02088689
## gamma  0.05019808 0.04374682
## gamma  0.97407791 0.02088689
## delta  0.34054163 0.23056401
## delta  0.65945837 0.23056401</code></pre>
<p>Note that the table above also contains estimation results for <span class="math inline">\({\boldsymbol\delta}\)</span> and accompanying standard errors, although <span class="math inline">\({\boldsymbol\delta}\)</span> is not estimated, but derived from <span class="math inline">\({\boldsymbol\Gamma}\)</span>.
We provide further details on this aspect in <a href="confidence-intervals.html#confidence-intervals">Confidence intervals</a>.<br />
The value of the nll function in the minimum found by the optimizer can also be extracted directly from the object <code>mod_tmb</code> by accessing the list element <code>objective</code>:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="using-tmb.html#cb67-1" aria-hidden="true" tabindex="-1"></a>mod_tmb<span class="sc">$</span>objective</span></code></pre></div>
<pre><code>## [1] 168.5361</code></pre>
<ol start="8" style="list-style-type: lower-roman">
<li>Use exact gradient and Hessian</li>
</ol>
<p>In the optimization above we already benefited from an increased speed due to the evaluation of the nll in <code>C++</code> compared to the forward algorithm being executed entirely in <code>R</code>.
However, the use of <code>TMB</code> also permits to introduce the gradient and/or the Hessian computed by <code>TMB</code> into the optimization procedure.
This is in general advisable, because <code>TMB</code> provides an exact value of both gradient and Hessian up to machine precision, which is superior to approximations used by optimizing procedure.
Similar to the nll, both quantities can be extracted directly from the <code>TMB</code> object <code>obj_tmb</code>:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="using-tmb.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The negative log-likelihood is accessed by the objective</span></span>
<span id="cb69-2"><a href="using-tmb.html#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute of the optimized object</span></span>
<span id="cb69-3"><a href="using-tmb.html#cb69-3" aria-hidden="true" tabindex="-1"></a>mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj_tmb<span class="sc">$</span>par, <span class="at">objective =</span> obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb69-4"><a href="using-tmb.html#cb69-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gradient =</span> obj_tmb<span class="sc">$</span>gr, <span class="at">hessian =</span> obj_tmb<span class="sc">$</span>he)</span>
<span id="cb69-5"><a href="using-tmb.html#cb69-5" aria-hidden="true" tabindex="-1"></a>mod_tmb<span class="sc">$</span>objective</span></code></pre></div>
<pre><code>## [1] 168.5361</code></pre>
<p>Note that passing the exact gradient and Hessian as provided by <code>TMB</code> to <code>nlminb</code> leads to the same minimum, i.e. value of the nll function, here.</p>
<p>Is it noteworthy that inconsistencies can happen in the estimates due to computer approximations.</p>
<p>The stationary distribution is a vector of probabilities and should sum to 1.
However, it doesn’t always behave as expected.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="using-tmb.html#cb71-1" aria-hidden="true" tabindex="-1"></a>adrep <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">sdreport</span>(obj_tmb), <span class="st">&quot;report&quot;</span>)</span>
<span id="cb71-2"><a href="using-tmb.html#cb71-2" aria-hidden="true" tabindex="-1"></a>estimate_delta <span class="ot">&lt;-</span> adrep[<span class="fu">rownames</span>(adrep) <span class="sc">==</span> <span class="st">&quot;delta&quot;</span>, <span class="st">&quot;Estimate&quot;</span>]</span>
<span id="cb71-3"><a href="using-tmb.html#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(estimate_delta)</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="using-tmb.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(estimate_delta) <span class="sc">==</span> <span class="dv">1</span> <span class="co"># The sum is displayed as 1 but is not 1</span></span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>As noted on <span class="citation">(<a href="#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, &amp; Langrock, 2016, pp. 159–160</a>)</span>, ``the row sums of <span class="math inline">\({\boldsymbol\Gamma}\)</span> will only approximately equal 1, and the components of the vector <span class="math inline">\({\boldsymbol\delta}\)</span> will only approximately total 1. This can be remedied by scaling the vector <span class="math inline">\({\boldsymbol\delta}\)</span> and each row of <span class="math inline">\({\boldsymbol\Gamma}\)</span> to total 1’’.
We do not remedy this issue because it provides no benefit to us, but this may lead to surprising results when checking equality.</p>
<p>This is likely due to machine approximations when numbers far apart from each other interact together.
In R, a small number is not 0 but is treated as 0 when added to a much larger number.</p>
<p>This can result in incoherent findings when checking equality between 2 numbers.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="using-tmb.html#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fl">1e-100</span> <span class="sc">==</span> <span class="dv">0</span> <span class="co"># Small numbers are 0</span></span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="using-tmb.html#cb77-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span> <span class="sc">+</span> <span class="fl">1e-100</span>) <span class="sc">==</span> <span class="dv">1</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="basic-nested-model-specification" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Basic nested model<br>specification</h2>
<div id="principle" class="section level3" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> Principle</h3>
<p>As a first step in building a nested model, we arbitrarily fix <span class="math inline">\(\lambda_1\)</span> to the value 1.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="using-tmb.html#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the previous values, and fix some</span></span>
<span id="cb79-2"><a href="using-tmb.html#cb79-2" aria-hidden="true" tabindex="-1"></a>fixed_par_lambda <span class="ot">&lt;-</span> lambda</span>
<span id="cb79-3"><a href="using-tmb.html#cb79-3" aria-hidden="true" tabindex="-1"></a>fixed_par_lambda[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb79-4"><a href="using-tmb.html#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform them into working parameters</span></span>
<span id="cb79-5"><a href="using-tmb.html#cb79-5" aria-hidden="true" tabindex="-1"></a>new_parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(<span class="at">m =</span> m,</span>
<span id="cb79-6"><a href="using-tmb.html#cb79-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">lambda =</span> fixed_par_lambda,</span>
<span id="cb79-7"><a href="using-tmb.html#cb79-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">gamma =</span> gamma)</span></code></pre></div>
<p>Then, we instruct <code>TMB</code> to read these custom parameters.
We indicate fixed values by mapping them to NA values, whereas the variable values need to be mapped to different factor variables.
Lastly, we specify this mapping with the <code>map</code> argument when making the <code>TMB</code> object.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="using-tmb.html#cb80-1" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tlambda =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">1</span>)),</span>
<span id="cb80-2"><a href="using-tmb.html#cb80-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">tgamma =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)))</span>
<span id="cb80-3"><a href="using-tmb.html#cb80-3" aria-hidden="true" tabindex="-1"></a>fixed_par_obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, new_parameters,</span>
<span id="cb80-4"><a href="using-tmb.html#cb80-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>,</span>
<span id="cb80-5"><a href="using-tmb.html#cb80-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">silent =</span> <span class="cn">TRUE</span>,</span>
<span id="cb80-6"><a href="using-tmb.html#cb80-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">map =</span> map)</span></code></pre></div>
<p>Estimating of the model and displaying the results is performed as usual</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="using-tmb.html#cb81-1" aria-hidden="true" tabindex="-1"></a>fixed_par_mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> fixed_par_obj_tmb<span class="sc">$</span>par,</span>
<span id="cb81-2"><a href="using-tmb.html#cb81-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">objective =</span> fixed_par_obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb81-3"><a href="using-tmb.html#cb81-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gradient =</span> fixed_par_obj_tmb<span class="sc">$</span>gr,</span>
<span id="cb81-4"><a href="using-tmb.html#cb81-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">hessian =</span> fixed_par_obj_tmb<span class="sc">$</span>he)</span>
<span id="cb81-5"><a href="using-tmb.html#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">sdreport</span>(fixed_par_obj_tmb), <span class="st">&quot;report&quot;</span>)</span></code></pre></div>
<pre><code>##          Estimate Std. Error
## lambda 1.00000000 0.00000000
## lambda 5.50164872 0.30963641
## gamma  0.94561055 0.04791050
## gamma  0.02655944 0.02133283
## gamma  0.05438945 0.04791050
## gamma  0.97344056 0.02133283
## delta  0.32810136 0.22314460
## delta  0.67189864 0.22314460</code></pre>
<p>Note that the standard error of <span class="math inline">\(\lambda_1\)</span> is zero, because it is no longer considered a variable parameter and does not enter the optimization procedure.</p>
</div>
<div id="limits" class="section level3" number="4.3.2">
<h3><span class="header-section-number">4.3.2</span> Limits</h3>
<p>This method cannot work in general for working parameters which are not linked to a single natural parameter.
This is because only working parameters can be fixed with this method, but the working parameters of the TPM are not each linked to a single natural parameter.
As an example, fixing the natural parameter <span class="math inline">\(\gamma_{11}\)</span> is not equivalent to fixing any working parameter <span class="math inline">\(\tau_{ij}\)</span>.
Hence, the TPM cannot in general be fixed, except perhaps via constrained optimization.</p>
<p>However, if conditions on the natural parameters can be translated to conditions on the working parameters, then there should not be any issue. We refer to <a href="using-tmb.html#param-eq-constraints">the next section</a> for more details.</p>
<p>We will show in the next section that a type of general constraints on the TPM can be carried out.</p>
</div>
<div id="param-eq-constraints" class="section level3" number="4.3.3">
<h3><span class="header-section-number">4.3.3</span> Parameter equality<br>constraints</h3>
<p>More complex constraints than above are possible.
For example, imposing equality constraints (such as <span class="math inline">\(\gamma_{11} = \gamma_{22}\)</span>) requires the corresponding factor level to be identical for the concerned entries.</p>
<p>As a reminder, we defined the working parameters via
<span class="math display">\[
\tau_{ij} = \log(\frac{\gamma_{ij}}{1 - \sum_{k \neq i} \gamma_{ik}}) = \log(\gamma_{ij}/\gamma_{ii}), \text{ for } i \neq j
\]</span></p>
<p>With a two-state Poisson HMM, the constraint <span class="math inline">\(\gamma_{11} = \gamma_{22}\)</span> is equivalent to <span class="math inline">\(\gamma_{12} = \gamma_{21}\)</span>.
Thus, the constraint can be transformed into <span class="math inline">\(\tau_{12} = \log(\gamma_{12}/\gamma_{11}) = \log(\gamma_{21}/\gamma_{22}) = \tau_{21}\)</span>.</p>
<p>The mapping parameters must be set to a common factor to be forced equal.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="using-tmb.html#cb83-1" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tlambda =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)),</span>
<span id="cb83-2"><a href="using-tmb.html#cb83-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">tgamma =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>)))</span>
<span id="cb83-3"><a href="using-tmb.html#cb83-3" aria-hidden="true" tabindex="-1"></a>fixed_par_obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb83-4"><a href="using-tmb.html#cb83-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>,</span>
<span id="cb83-5"><a href="using-tmb.html#cb83-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">silent =</span> <span class="cn">TRUE</span>,</span>
<span id="cb83-6"><a href="using-tmb.html#cb83-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">map =</span> map)</span>
<span id="cb83-7"><a href="using-tmb.html#cb83-7" aria-hidden="true" tabindex="-1"></a>fixed_par_mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> fixed_par_obj_tmb<span class="sc">$</span>par,</span>
<span id="cb83-8"><a href="using-tmb.html#cb83-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">objective =</span> fixed_par_obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb83-9"><a href="using-tmb.html#cb83-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gradient =</span> fixed_par_obj_tmb<span class="sc">$</span>gr,</span>
<span id="cb83-10"><a href="using-tmb.html#cb83-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">hessian =</span> fixed_par_obj_tmb<span class="sc">$</span>he)</span>
<span id="cb83-11"><a href="using-tmb.html#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Results + check that the constraint is respected</span></span>
<span id="cb83-12"><a href="using-tmb.html#cb83-12" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">sdreport</span>(fixed_par_obj_tmb), <span class="st">&quot;report&quot;</span>)</span>
<span id="cb83-13"><a href="using-tmb.html#cb83-13" aria-hidden="true" tabindex="-1"></a>tpm <span class="ot">&lt;-</span> <span class="fu">matrix</span>(results[<span class="fu">rownames</span>(results) <span class="sc">==</span> <span class="st">&quot;gamma&quot;</span>, <span class="st">&quot;Estimate&quot;</span>],</span>
<span id="cb83-14"><a href="using-tmb.html#cb83-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">nrow =</span> m,</span>
<span id="cb83-15"><a href="using-tmb.html#cb83-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">ncol =</span> m,</span>
<span id="cb83-16"><a href="using-tmb.html#cb83-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">byrow =</span> <span class="cn">FALSE</span>) <span class="co"># Transformations are column-wise by default, be careful!</span></span>
<span id="cb83-17"><a href="using-tmb.html#cb83-17" aria-hidden="true" tabindex="-1"></a>tpm</span></code></pre></div>
<pre><code>##            [,1]       [,2]
## [1,] 0.96759216 0.03240784
## [2,] 0.03240784 0.96759216</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="using-tmb.html#cb85-1" aria-hidden="true" tabindex="-1"></a>tpm[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">==</span> tpm[<span class="dv">2</span>, <span class="dv">2</span>]</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Similar complex constraints on the TPM can also be setup for HMMs with three or more states.
However, it appears it can only be done in general when the constraint involves natural parameters of the same row with the exception of a 2 state model.
We have not found a way to easily implement equality constraints between natural TPM parameters of different rows.
Possible solutions are constrained optimization and different parametrization.</p>
<p>As an example, we will look at a three-state HMM with the constraint <span class="math inline">\(\gamma_{12} = \gamma_{13}\)</span>.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="using-tmb.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model with 2 states</span></span>
<span id="cb87-2"><a href="using-tmb.html#cb87-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb87-3"><a href="using-tmb.html#cb87-3" aria-hidden="true" tabindex="-1"></a>TMB_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> tinn_data, <span class="at">m =</span> m)</span>
<span id="cb87-4"><a href="using-tmb.html#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="using-tmb.html#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial set of parameters</span></span>
<span id="cb87-6"><a href="using-tmb.html#cb87-6" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>)</span>
<span id="cb87-7"><a href="using-tmb.html#cb87-7" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>,</span>
<span id="cb87-8"><a href="using-tmb.html#cb87-8" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.1</span>, <span class="fl">0.8</span>, <span class="fl">0.1</span>,</span>
<span id="cb87-9"><a href="using-tmb.html#cb87-9" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.8</span>), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> m)</span>
<span id="cb87-10"><a href="using-tmb.html#cb87-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-11"><a href="using-tmb.html#cb87-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn them into working parameters</span></span>
<span id="cb87-12"><a href="using-tmb.html#cb87-12" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m, lambda, gamma)</span>
<span id="cb87-13"><a href="using-tmb.html#cb87-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-14"><a href="using-tmb.html#cb87-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the TMB object</span></span>
<span id="cb87-15"><a href="using-tmb.html#cb87-15" aria-hidden="true" tabindex="-1"></a>obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb87-16"><a href="using-tmb.html#cb87-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb87-17"><a href="using-tmb.html#cb87-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-18"><a href="using-tmb.html#cb87-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize</span></span>
<span id="cb87-19"><a href="using-tmb.html#cb87-19" aria-hidden="true" tabindex="-1"></a>mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj_tmb<span class="sc">$</span>par,</span>
<span id="cb87-20"><a href="using-tmb.html#cb87-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">objective =</span> obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb87-21"><a href="using-tmb.html#cb87-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gradient =</span> obj_tmb<span class="sc">$</span>gr,</span>
<span id="cb87-22"><a href="using-tmb.html#cb87-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">hessian =</span> obj_tmb<span class="sc">$</span>he)</span>
<span id="cb87-23"><a href="using-tmb.html#cb87-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-24"><a href="using-tmb.html#cb87-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Check convergence</span></span>
<span id="cb87-25"><a href="using-tmb.html#cb87-25" aria-hidden="true" tabindex="-1"></a>mod_tmb<span class="sc">$</span>convergence <span class="sc">==</span> <span class="dv">0</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="using-tmb.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Results</span></span>
<span id="cb89-2"><a href="using-tmb.html#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">sdreport</span>(obj_tmb), <span class="st">&quot;report&quot;</span>)</span></code></pre></div>
<pre><code>##            Estimate   Std. Error
## lambda 8.281290e-01 5.418824e-01
## lambda 1.705082e+00 2.949769e-01
## lambda 5.514886e+00 3.080238e-01
## gamma  5.516919e-01 3.132490e-01
## gamma  4.596623e-09 5.115944e-05
## gamma  2.749570e-02 2.164849e-02
## gamma  1.989160e-01 2.698088e-01
## gamma  9.772963e-01 3.436716e-02
## gamma  2.453591e-10 2.730433e-06
## gamma  2.493922e-01 2.546636e-01
## gamma  2.270369e-02 3.436717e-02
## gamma  9.725043e-01 2.164849e-02
## delta  3.836408e-02 3.757898e-02
## delta  3.361227e-01 3.144598e-01
## delta  6.255132e-01 3.063220e-01</code></pre>
<p>The transformed constraint becomes <span class="math inline">\(\tau_{12} = \log(\gamma_{12}/\gamma_{11}) = \log(\gamma_{13}/\gamma_{11}) = \tau_{13}\)</span>.</p>
<p>We need to be careful how we specify the constraint, because the vector <code>tgamma</code> will be converted into a matrix column-wise since this is R’s default way to handle matrix-vector conversions.</p>
<p>The <code>tgamma</code> matrix looks naturally like
<span class="math display">\[\begin{pmatrix}
         &amp;\tau_{12}&amp;\tau_{13}\\
\tau_{21}&amp;         &amp;\tau_{23}\\
\tau_{31}&amp;\tau_{32}&amp;
\end{pmatrix}\]</span></p>
<p>As a vector in <code>R</code>, it becomes <span class="math inline">\(\left(\tau_{21}, \tau_{31}, \tau_{12}, \tau_{32}, \tau_{13}, \tau_{23}\right)\)</span>.
Therefore, the constraint needs to be placed on the <span class="math inline">\(3^{rd}\)</span> and <span class="math inline">\(5^{th}\)</span> vector parameter.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="using-tmb.html#cb91-1" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tlambda =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)),</span>
<span id="cb91-2"><a href="using-tmb.html#cb91-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">tgamma =</span> <span class="fu">as.factor</span>(<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">6</span>, <span class="dv">8</span>)))</span>
<span id="cb91-3"><a href="using-tmb.html#cb91-3" aria-hidden="true" tabindex="-1"></a>fixed_par_obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb91-4"><a href="using-tmb.html#cb91-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>,</span>
<span id="cb91-5"><a href="using-tmb.html#cb91-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">silent =</span> <span class="cn">TRUE</span>,</span>
<span id="cb91-6"><a href="using-tmb.html#cb91-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">map =</span> map)</span>
<span id="cb91-7"><a href="using-tmb.html#cb91-7" aria-hidden="true" tabindex="-1"></a>fixed_par_mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> fixed_par_obj_tmb<span class="sc">$</span>par,</span>
<span id="cb91-8"><a href="using-tmb.html#cb91-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">objective =</span> fixed_par_obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb91-9"><a href="using-tmb.html#cb91-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">gradient =</span> fixed_par_obj_tmb<span class="sc">$</span>gr,</span>
<span id="cb91-10"><a href="using-tmb.html#cb91-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">hessian =</span> fixed_par_obj_tmb<span class="sc">$</span>he)</span>
<span id="cb91-11"><a href="using-tmb.html#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Results + check that the constraint is respected</span></span>
<span id="cb91-12"><a href="using-tmb.html#cb91-12" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">summary</span>(<span class="fu">sdreport</span>(fixed_par_obj_tmb), <span class="st">&quot;report&quot;</span>)</span>
<span id="cb91-13"><a href="using-tmb.html#cb91-13" aria-hidden="true" tabindex="-1"></a>tpm <span class="ot">&lt;-</span> <span class="fu">matrix</span>(results[<span class="fu">rownames</span>(results) <span class="sc">==</span> <span class="st">&quot;gamma&quot;</span>, <span class="st">&quot;Estimate&quot;</span>],</span>
<span id="cb91-14"><a href="using-tmb.html#cb91-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">nrow =</span> m,</span>
<span id="cb91-15"><a href="using-tmb.html#cb91-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">ncol =</span> m,</span>
<span id="cb91-16"><a href="using-tmb.html#cb91-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">byrow =</span> <span class="cn">FALSE</span>) <span class="co"># Transformations are column-wise by default, be careful!</span></span>
<span id="cb91-17"><a href="using-tmb.html#cb91-17" aria-hidden="true" tabindex="-1"></a>tpm</span></code></pre></div>
<pre><code>##              [,1]         [,2]       [,3]
## [1,] 5.447127e-01 2.276437e-01 0.22764365
## [2,] 2.718007e-09 9.753263e-01 0.02467374
## [3,] 2.710078e-02 2.005408e-10 0.97289922</code></pre>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="using-tmb.html#cb93-1" aria-hidden="true" tabindex="-1"></a>tpm[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">==</span> tpm[<span class="dv">1</span>, <span class="dv">3</span>]</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Equality constraints involving a diagonal member of the TPM are simpler to specify: the constraint <span class="math inline">\(\gamma_{i,j} = \gamma_{i,i}\)</span> becomes transformed to <span class="math inline">\(\tau_{i,j} = 1\)</span> and this can be specified in the same way the Poisson mean <span class="math inline">\(\lambda_1\)</span> was fixed.</p>
</div>
</div>
<div id="state-inference" class="section level2" number="4.4">
<h2><span class="header-section-number">4.4</span> State inference and forecasting</h2>
<p>The following code requires executing the code presented in the Section <a href="parameter-estimation-techniques-for-hmms.html#forward-backward">Forward algorithm and backward algorithm</a>, as the log-forward and log-backward probabilities are needed.</p>
<div id="local-decoding" class="section level3" number="4.4.1">
<h3><span class="header-section-number">4.4.1</span> Local decoding</h3>
<p>The smoothing probabilities are defined in <span class="citation"><a href="#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, &amp; Langrock</a> (<a href="#ref-zucchini" role="doc-biblioref">2016, p. 87</a> and p.336)</span> as
<span class="math display">\[
\text{P}(C_t = i \vert X^{(n)}) = x^{(n)}) = \frac{\alpha_t(i) \beta_t(i)}{L_n}
\]</span></p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="using-tmb.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute conditional state probabilities, smoothing probabilities</span></span>
<span id="cb95-2"><a href="using-tmb.html#cb95-2" aria-hidden="true" tabindex="-1"></a>stateprobs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">ncol =</span> n, <span class="at">nrow =</span> m)</span>
<span id="cb95-3"><a href="using-tmb.html#cb95-3" aria-hidden="true" tabindex="-1"></a>llk <span class="ot">&lt;-</span> <span class="sc">-</span> mllk</span>
<span id="cb95-4"><a href="using-tmb.html#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb95-5"><a href="using-tmb.html#cb95-5" aria-hidden="true" tabindex="-1"></a>  stateprobs[, i] <span class="ot">&lt;-</span> <span class="fu">exp</span>(lalpha[, i] <span class="sc">+</span> lbeta[, i] <span class="sc">-</span> llk)</span>
<span id="cb95-6"><a href="using-tmb.html#cb95-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Local decoding is a straightforward maximum of the smoothing probabilities.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="using-tmb.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Most probable states (local decoding)</span></span>
<span id="cb96-2"><a href="using-tmb.html#cb96-2" aria-hidden="true" tabindex="-1"></a>ldecode <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, n)</span>
<span id="cb96-3"><a href="using-tmb.html#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb96-4"><a href="using-tmb.html#cb96-4" aria-hidden="true" tabindex="-1"></a>  ldecode[i] <span class="ot">&lt;-</span> <span class="fu">which.max</span>(stateprobs[, i])</span>
<span id="cb96-5"><a href="using-tmb.html#cb96-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-6"><a href="using-tmb.html#cb96-6" aria-hidden="true" tabindex="-1"></a>ldecode</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2
##  [88] 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## [175] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</code></pre>
</div>
<div id="forecast" class="section level3" number="4.4.2">
<h3><span class="header-section-number">4.4.2</span> Forecast</h3>
<p>The forecast distribution or h-step-ahead-probabilities as well as its
implementation in R is detailed in <span class="citation"><a href="#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, &amp; Langrock</a> (<a href="#ref-zucchini" role="doc-biblioref">2016, p. 83</a> and p.337)</span></p>
<p>Then,
<span class="math display">\[
\text{P}(X_{n+h} = x \vert X^{(n)} = x^{(n)}) = \frac{{\boldsymbol\alpha}_n {\boldsymbol\Gamma}^h \textbf{P}(x) {\boldsymbol 1}&#39;}{{\boldsymbol\alpha}_n {\boldsymbol 1}&#39;} = {\boldsymbol\Phi}_n {\boldsymbol\Gamma}^h \textbf{P}(x) {\boldsymbol 1}&#39;
\]</span>
An implementation of this using a scaling scheme is</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="using-tmb.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of steps</span></span>
<span id="cb98-2"><a href="using-tmb.html#cb98-2" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb98-3"><a href="using-tmb.html#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Values for which we want the forecast probabilities</span></span>
<span id="cb98-4"><a href="using-tmb.html#cb98-4" aria-hidden="true" tabindex="-1"></a>xf <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">50</span></span>
<span id="cb98-5"><a href="using-tmb.html#cb98-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-6"><a href="using-tmb.html#cb98-6" aria-hidden="true" tabindex="-1"></a>nxf <span class="ot">&lt;-</span> <span class="fu">length</span>(xf)</span>
<span id="cb98-7"><a href="using-tmb.html#cb98-7" aria-hidden="true" tabindex="-1"></a>dxf <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> h, <span class="at">ncol =</span> nxf)</span>
<span id="cb98-8"><a href="using-tmb.html#cb98-8" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> delta <span class="sc">*</span> emission_probs[<span class="dv">1</span>, ]</span>
<span id="cb98-9"><a href="using-tmb.html#cb98-9" aria-hidden="true" tabindex="-1"></a>sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb98-10"><a href="using-tmb.html#cb98-10" aria-hidden="true" tabindex="-1"></a>lscale <span class="ot">&lt;-</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb98-11"><a href="using-tmb.html#cb98-11" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> foo <span class="sc">/</span> sumfoo</span>
<span id="cb98-12"><a href="using-tmb.html#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb98-13"><a href="using-tmb.html#cb98-13" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> foo <span class="sc">%*%</span> gamma <span class="sc">*</span> emission_probs[i, ]</span>
<span id="cb98-14"><a href="using-tmb.html#cb98-14" aria-hidden="true" tabindex="-1"></a>  sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>( foo)</span>
<span id="cb98-15"><a href="using-tmb.html#cb98-15" aria-hidden="true" tabindex="-1"></a>  lscale <span class="ot">&lt;-</span> lscale <span class="sc">+</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb98-16"><a href="using-tmb.html#cb98-16" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> foo <span class="sc">/</span> sumfoo</span>
<span id="cb98-17"><a href="using-tmb.html#cb98-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-18"><a href="using-tmb.html#cb98-18" aria-hidden="true" tabindex="-1"></a>emission_probs_xf <span class="ot">&lt;-</span> <span class="fu">get.emission.probs</span>(xf, lambda)</span>
<span id="cb98-19"><a href="using-tmb.html#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>h) {</span>
<span id="cb98-20"><a href="using-tmb.html#cb98-20" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> foo <span class="sc">%*%</span> gamma</span>
<span id="cb98-21"><a href="using-tmb.html#cb98-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb98-22"><a href="using-tmb.html#cb98-22" aria-hidden="true" tabindex="-1"></a>    dxf[i, ] <span class="ot">&lt;-</span> dxf[i, ] <span class="sc">+</span> foo[j] <span class="sc">*</span> emission_probs_xf[, j]</span>
<span id="cb98-23"><a href="using-tmb.html#cb98-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb98-24"><a href="using-tmb.html#cb98-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-25"><a href="using-tmb.html#cb98-25" aria-hidden="true" tabindex="-1"></a><span class="co"># dxf contains n=240 columns, so we only display 4 for readability</span></span>
<span id="cb98-26"><a href="using-tmb.html#cb98-26" aria-hidden="true" tabindex="-1"></a>dxf[, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span></code></pre></div>
<pre><code>## [1] 0.36414482 0.36531388 0.18441055 0.06322379</code></pre>
</div>
<div id="global-decoding" class="section level3" number="4.4.3">
<h3><span class="header-section-number">4.4.3</span> Global decoding</h3>
<p>The Viterbi algorithm is detailed in <span class="citation"><a href="#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, &amp; Langrock</a> (<a href="#ref-zucchini" role="doc-biblioref">2016, p. 88</a> and p.334)</span>.
It calculates the sequence of states <span class="math inline">\((i_1^*, \ldots, i_T^*)\)</span> which
maximizes the conditional probability of all states simultaneously, i.e.
<span class="math display">\[
(i_1^*, \ldots, i_n^*) = \mathop{\mathrm{argmax}}_{i_1, \ldots, i_n \in \{1, \ldots, m \}} \text{P}(C_1 = i_1, \ldots, C_n = i_n \vert X^{(n)} = x^{(n)}).
\]</span>
An implementation of it is</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="using-tmb.html#cb100-1" aria-hidden="true" tabindex="-1"></a>xi <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, m)</span>
<span id="cb100-2"><a href="using-tmb.html#cb100-2" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> delta <span class="sc">*</span> emission_probs[<span class="dv">1</span>, ]</span>
<span id="cb100-3"><a href="using-tmb.html#cb100-3" aria-hidden="true" tabindex="-1"></a>xi[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> foo <span class="sc">/</span> <span class="fu">sum</span>(foo)</span>
<span id="cb100-4"><a href="using-tmb.html#cb100-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb100-5"><a href="using-tmb.html#cb100-5" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> <span class="fu">apply</span>(xi[i <span class="sc">-</span> <span class="dv">1</span>, ] <span class="sc">*</span> gamma, <span class="dv">2</span>, max) <span class="sc">*</span> emission_probs[i, ]</span>
<span id="cb100-6"><a href="using-tmb.html#cb100-6" aria-hidden="true" tabindex="-1"></a>  xi[i, ] <span class="ot">&lt;-</span> foo <span class="sc">/</span> <span class="fu">sum</span>(foo)</span>
<span id="cb100-7"><a href="using-tmb.html#cb100-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-8"><a href="using-tmb.html#cb100-8" aria-hidden="true" tabindex="-1"></a>iv <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n)</span>
<span id="cb100-9"><a href="using-tmb.html#cb100-9" aria-hidden="true" tabindex="-1"></a>iv[n] <span class="ot">&lt;-</span> <span class="fu">which.max</span>(xi[n, ])</span>
<span id="cb100-10"><a href="using-tmb.html#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> (n <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span><span class="dv">1</span>){</span>
<span id="cb100-11"><a href="using-tmb.html#cb100-11" aria-hidden="true" tabindex="-1"></a>  iv[i] <span class="ot">&lt;-</span> <span class="fu">which.max</span>(gamma[, iv[i <span class="sc">+</span> <span class="dv">1</span>]] <span class="sc">*</span> xi[i, ])</span>
<span id="cb100-12"><a href="using-tmb.html#cb100-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-13"><a href="using-tmb.html#cb100-13" aria-hidden="true" tabindex="-1"></a>iv</span></code></pre></div>
<pre><code>##   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2
##  [88] 2 2 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
## [175] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1</code></pre>
</div>
</div>
<div id="appendix" class="section level2" number="4.5">
<h2><span class="header-section-number">4.5</span> Appendix</h2>
<p>Model selection tinnitus via AIC and BIC (calculation defined in <span class="citation"><a href="#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, &amp; Langrock</a> (<a href="#ref-zucchini" role="doc-biblioref">2016</a>)</span>).</p>
<ul>
<li>AIC and BIC for a Poisson regression</li>
</ul>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="using-tmb.html#cb102-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb102-2"><a href="using-tmb.html#cb102-2" aria-hidden="true" tabindex="-1"></a>TMB_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> tinn_data, <span class="at">m =</span> m)</span>
<span id="cb102-3"><a href="using-tmb.html#cb102-3" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb102-4"><a href="using-tmb.html#cb102-4" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb102-5"><a href="using-tmb.html#cb102-5" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m, lambda, gamma)</span>
<span id="cb102-6"><a href="using-tmb.html#cb102-6" aria-hidden="true" tabindex="-1"></a>obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb102-7"><a href="using-tmb.html#cb102-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb102-8"><a href="using-tmb.html#cb102-8" aria-hidden="true" tabindex="-1"></a>mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj_tmb<span class="sc">$</span>par, <span class="at">objective =</span> obj_tmb<span class="sc">$</span>fn)</span>
<span id="cb102-9"><a href="using-tmb.html#cb102-9" aria-hidden="true" tabindex="-1"></a>mllk <span class="ot">&lt;-</span> mod_tmb<span class="sc">$</span>objective</span>
<span id="cb102-10"><a href="using-tmb.html#cb102-10" aria-hidden="true" tabindex="-1"></a>np <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unlist</span>(parameters))</span>
<span id="cb102-11"><a href="using-tmb.html#cb102-11" aria-hidden="true" tabindex="-1"></a>AIC_1 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> (mllk <span class="sc">+</span> np)</span>
<span id="cb102-12"><a href="using-tmb.html#cb102-12" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(TMB_data<span class="sc">$</span>x))</span>
<span id="cb102-13"><a href="using-tmb.html#cb102-13" aria-hidden="true" tabindex="-1"></a>BIC_1 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> mllk <span class="sc">+</span> np <span class="sc">*</span> <span class="fu">log</span>(n)</span>
<span id="cb102-14"><a href="using-tmb.html#cb102-14" aria-hidden="true" tabindex="-1"></a>mod_tmb<span class="sc">$</span>convergence <span class="sc">==</span> <span class="dv">0</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="using-tmb.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;AIC =&quot;</span>, AIC_1, <span class="st">&quot;and BIC =&quot;</span>, BIC_1)</span></code></pre></div>
<pre><code>## [1] &quot;AIC = 394.196996175401 and BIC = 396.662904294055&quot;</code></pre>
<ul>
<li>AIC and BIC for a two-state HMM</li>
</ul>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="using-tmb.html#cb106-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb106-2"><a href="using-tmb.html#cb106-2" aria-hidden="true" tabindex="-1"></a>TMB_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> tinn_data, <span class="at">m =</span> m)</span>
<span id="cb106-3"><a href="using-tmb.html#cb106-3" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">1</span>, <span class="at">to =</span> <span class="dv">3</span>, <span class="at">length.out =</span> m)</span>
<span id="cb106-4"><a href="using-tmb.html#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.8 on the diagonal, and 0.2 split along the rest of each line, size m</span></span>
<span id="cb106-5"><a href="using-tmb.html#cb106-5" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fl">0.2</span> <span class="sc">/</span> (m <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb106-6"><a href="using-tmb.html#cb106-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">nrow =</span> m,</span>
<span id="cb106-7"><a href="using-tmb.html#cb106-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">ncol =</span> m)</span>
<span id="cb106-8"><a href="using-tmb.html#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(gamma) <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb106-9"><a href="using-tmb.html#cb106-9" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m, lambda, gamma)</span>
<span id="cb106-10"><a href="using-tmb.html#cb106-10" aria-hidden="true" tabindex="-1"></a>obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb106-11"><a href="using-tmb.html#cb106-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-12"><a href="using-tmb.html#cb106-12" aria-hidden="true" tabindex="-1"></a>mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj_tmb<span class="sc">$</span>par, <span class="at">objective =</span> obj_tmb<span class="sc">$</span>fn)</span>
<span id="cb106-13"><a href="using-tmb.html#cb106-13" aria-hidden="true" tabindex="-1"></a>mllk <span class="ot">&lt;-</span> mod_tmb<span class="sc">$</span>objective</span>
<span id="cb106-14"><a href="using-tmb.html#cb106-14" aria-hidden="true" tabindex="-1"></a>np <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unlist</span>(parameters))</span>
<span id="cb106-15"><a href="using-tmb.html#cb106-15" aria-hidden="true" tabindex="-1"></a>AIC_2 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> (mllk <span class="sc">+</span> np)</span>
<span id="cb106-16"><a href="using-tmb.html#cb106-16" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(TMB_data<span class="sc">$</span>x))</span>
<span id="cb106-17"><a href="using-tmb.html#cb106-17" aria-hidden="true" tabindex="-1"></a>BIC_2 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> mllk <span class="sc">+</span> np <span class="sc">*</span> <span class="fu">log</span>(n)</span>
<span id="cb106-18"><a href="using-tmb.html#cb106-18" aria-hidden="true" tabindex="-1"></a>mod_tmb<span class="sc">$</span>convergence <span class="sc">==</span> <span class="dv">0</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="using-tmb.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;AIC =&quot;</span>, AIC_2, <span class="st">&quot;and BIC =&quot;</span>, BIC_2)</span></code></pre></div>
<pre><code>## [1] &quot;AIC = 345.07211173897 and BIC = 354.935744213588&quot;</code></pre>
<ul>
<li>AIC and BIC for a two-state HMM</li>
</ul>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="using-tmb.html#cb110-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb110-2"><a href="using-tmb.html#cb110-2" aria-hidden="true" tabindex="-1"></a>TMB_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> tinn_data, <span class="at">m =</span> m)</span>
<span id="cb110-3"><a href="using-tmb.html#cb110-3" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">1</span>, <span class="at">to =</span> <span class="dv">3</span>, <span class="at">length.out =</span> m)</span>
<span id="cb110-4"><a href="using-tmb.html#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.8 on the diagonal, and 0.2 split along the rest of each line, size m</span></span>
<span id="cb110-5"><a href="using-tmb.html#cb110-5" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fl">0.2</span> <span class="sc">/</span> (m <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb110-6"><a href="using-tmb.html#cb110-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">nrow =</span> m,</span>
<span id="cb110-7"><a href="using-tmb.html#cb110-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">ncol =</span> m)</span>
<span id="cb110-8"><a href="using-tmb.html#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(gamma) <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb110-9"><a href="using-tmb.html#cb110-9" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m, lambda, gamma)</span>
<span id="cb110-10"><a href="using-tmb.html#cb110-10" aria-hidden="true" tabindex="-1"></a>obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb110-11"><a href="using-tmb.html#cb110-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb110-12"><a href="using-tmb.html#cb110-12" aria-hidden="true" tabindex="-1"></a>mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj_tmb<span class="sc">$</span>par, <span class="at">objective =</span> obj_tmb<span class="sc">$</span>fn)</span>
<span id="cb110-13"><a href="using-tmb.html#cb110-13" aria-hidden="true" tabindex="-1"></a>mllk <span class="ot">&lt;-</span> mod_tmb<span class="sc">$</span>objective</span>
<span id="cb110-14"><a href="using-tmb.html#cb110-14" aria-hidden="true" tabindex="-1"></a>np <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unlist</span>(parameters))</span>
<span id="cb110-15"><a href="using-tmb.html#cb110-15" aria-hidden="true" tabindex="-1"></a>AIC_3 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> (mllk <span class="sc">+</span> np)</span>
<span id="cb110-16"><a href="using-tmb.html#cb110-16" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(TMB_data<span class="sc">$</span>x))</span>
<span id="cb110-17"><a href="using-tmb.html#cb110-17" aria-hidden="true" tabindex="-1"></a>BIC_3 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> mllk <span class="sc">+</span> np <span class="sc">*</span> <span class="fu">log</span>(n)</span>
<span id="cb110-18"><a href="using-tmb.html#cb110-18" aria-hidden="true" tabindex="-1"></a>mod_tmb<span class="sc">$</span>convergence <span class="sc">==</span> <span class="dv">0</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="using-tmb.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;AIC =&quot;</span>, AIC_3, <span class="st">&quot;and BIC =&quot;</span>, BIC_3)</span></code></pre></div>
<pre><code>## [1] &quot;AIC = 353.04633752738 and BIC = 375.239510595271&quot;</code></pre>
<ul>
<li>AIC and BIC for a four-state HMM</li>
</ul>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="using-tmb.html#cb114-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb114-2"><a href="using-tmb.html#cb114-2" aria-hidden="true" tabindex="-1"></a>TMB_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> tinn_data, <span class="at">m =</span> m)</span>
<span id="cb114-3"><a href="using-tmb.html#cb114-3" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">1</span>, <span class="at">to =</span> <span class="dv">3</span>, <span class="at">length.out =</span> m)</span>
<span id="cb114-4"><a href="using-tmb.html#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.8 on the diagonal, and 0.2 split along the rest of each line, size m</span></span>
<span id="cb114-5"><a href="using-tmb.html#cb114-5" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fl">0.2</span> <span class="sc">/</span> (m <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb114-6"><a href="using-tmb.html#cb114-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">nrow =</span> m,</span>
<span id="cb114-7"><a href="using-tmb.html#cb114-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">ncol =</span> m)</span>
<span id="cb114-8"><a href="using-tmb.html#cb114-8" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(gamma) <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb114-9"><a href="using-tmb.html#cb114-9" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m, lambda, gamma)</span>
<span id="cb114-10"><a href="using-tmb.html#cb114-10" aria-hidden="true" tabindex="-1"></a>obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb114-11"><a href="using-tmb.html#cb114-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb114-12"><a href="using-tmb.html#cb114-12" aria-hidden="true" tabindex="-1"></a>mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj_tmb<span class="sc">$</span>par, <span class="at">objective =</span> obj_tmb<span class="sc">$</span>fn)</span>
<span id="cb114-13"><a href="using-tmb.html#cb114-13" aria-hidden="true" tabindex="-1"></a>mllk <span class="ot">&lt;-</span> mod_tmb<span class="sc">$</span>objective</span>
<span id="cb114-14"><a href="using-tmb.html#cb114-14" aria-hidden="true" tabindex="-1"></a>np <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unlist</span>(parameters))</span>
<span id="cb114-15"><a href="using-tmb.html#cb114-15" aria-hidden="true" tabindex="-1"></a>AIC_4 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> (mllk <span class="sc">+</span> np)</span>
<span id="cb114-16"><a href="using-tmb.html#cb114-16" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(TMB_data<span class="sc">$</span>x))</span>
<span id="cb114-17"><a href="using-tmb.html#cb114-17" aria-hidden="true" tabindex="-1"></a>BIC_4 <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> mllk <span class="sc">+</span> np <span class="sc">*</span> <span class="fu">log</span>(n)</span>
<span id="cb114-18"><a href="using-tmb.html#cb114-18" aria-hidden="true" tabindex="-1"></a>mod_tmb<span class="sc">$</span>convergence <span class="sc">==</span> <span class="dv">0</span></span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="using-tmb.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;AIC =&quot;</span>, AIC_4, <span class="st">&quot;and BIC =&quot;</span>, BIC_4)</span></code></pre></div>
<pre><code>## [1] &quot;AIC = 365.664376187601 and BIC = 405.118906086074&quot;</code></pre>
<ul>
<li>Summary</li>
</ul>
<table>
<thead>
<tr class="header">
<th>Models</th>
<th>AIC</th>
<th>BIC</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Poisson regression</td>
<td>394.1969962</td>
<td>396.6629043</td>
</tr>
<tr class="even">
<td>Two-state HMM</td>
<td>345.0721117</td>
<td>354.9357442</td>
</tr>
<tr class="odd">
<td>Three-state HMM</td>
<td>353.0463375</td>
<td>375.2395106</td>
</tr>
<tr class="even">
<td>Four-state HMM</td>
<td>365.6643762</td>
<td>405.1189061</td>
</tr>
</tbody>
</table>
<p>AIC and BIC prefer a two-state model over a Poisson regression and over three and four-state HMMs.</p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent" line-spacing="2">
<div id="ref-celeux" class="csl-entry">
Celeux, G., &amp; Durand, J.-B. (2008). Selecting hidden <span>Markov</span> model state number with cross-validated likelihood. <em>Computational Statistics</em>, <em>23</em>(4), 541–564. doi:<a href="https://doi.org/10.1007/s00180-007-0097-1">10.1007/s00180-007-0097-1</a>
</div>
<div id="ref-leroux" class="csl-entry">
Leroux, B. G., &amp; Puterman, M. L. (1992). Maximum-<span>Penalized</span>-<span>Likelihood Estimation</span> for <span>Independent</span> and <span>Markov</span>- <span>Dependent Mixture Models</span>. <em>Biometrics</em>, <em>48</em>(2), 545–558. doi:<a href="https://doi.org/10.2307/2532308">10.2307/2532308</a>
</div>
<div id="ref-pohle" class="csl-entry">
Pohle, J., Langrock, R., van Beest, F. M., &amp; Schmidt, N. M. (2017a). Selecting the <span>Number</span> of <span>States</span> in <span>Hidden Markov Models</span>: <span>Pragmatic Solutions Illustrated Using Animal Movement</span>. <em>Journal of Agricultural, Biological and Environmental Statistics</em>, <em>22</em>(3), 270–293. doi:<a href="https://doi.org/10.1007/s13253-017-0283-8">10.1007/s13253-017-0283-8</a>
</div>
<div id="ref-pohlea" class="csl-entry">
Pohle, J., Langrock, R., van Beest, F., &amp; Schmidt, N. M. (2017b). Selecting the <span>Number</span> of <span>States</span> in <span>Hidden Markov Models</span> - <span>Pitfalls</span>, <span>Practical Challenges</span> and <span>Pragmatic Solutions</span>. <em>arXiv:1701.08673 [q-Bio, Stat]</em>. Retrieved from <a href="http://arxiv.org/abs/1701.08673">http://arxiv.org/abs/1701.08673</a>
</div>
<div id="ref-probst" class="csl-entry">
Probst, T., Pryss, R., Langguth, B., &amp; Schlee, W. (2016). Emotion dynamics and tinnitus: <span>Daily</span> life data from the <span>“<span>TrackYourTinnitus</span>”</span> application. <em>Scientific Reports</em>, <em>6</em>(1), 31166. doi:<a href="https://doi.org/10.1038/srep31166">10.1038/srep31166</a>
</div>
<div id="ref-pryss" class="csl-entry">
Pryss, R., Reichert, M., Herrmann, J., Langguth, B., &amp; Schlee, W. (2015). Mobile <span>Crowd Sensing</span> in <span>Clinical</span> and <span>Psychological Trials</span> <span></span> <span>A Case Study</span>. In <em>2015 <span>IEEE</span> 28th <span>International Symposium</span> on <span>Computer</span>-<span>Based Medical Systems</span></em> (pp. 23–24). doi:<a href="https://doi.org/10.1109/CBMS.2015.26">10.1109/CBMS.2015.26</a>
</div>
<div id="ref-pryssa" class="csl-entry">
Pryss, R., Reichert, M., Langguth, B., &amp; Schlee, W. (2015). Mobile <span>Crowd Sensing Services</span> for <span>Tinnitus Assessment</span>, <span>Therapy</span>, and <span>Research</span>. In <em>2015 <span>IEEE International Conference</span> on <span>Mobile Services</span></em> (pp. 352–359). doi:<a href="https://doi.org/10.1109/MobServ.2015.55">10.1109/MobServ.2015.55</a>
</div>
<div id="ref-zucchini" class="csl-entry">
Zucchini, W., MacDonald, I. L., &amp; Langrock, R. (2016). <em>Hidden markov models for time series: An introduction using r, second edition</em>. <span>CRC Press</span>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="parameter-estimation-techniques-for-hmms.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="confidence-intervals.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
