<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Principles of using TMB for Maximum Likelihood Estimation | [ UNDER CONSTRUCTION ] A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</title>
  <meta name="description" content="This accompanies the article published at [GITHUB LINK]." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Principles of using TMB for Maximum Likelihood Estimation | [ UNDER CONSTRUCTION ] A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/timothee-bacri/HMM_with_TMB" />
  
  <meta property="og:description" content="This accompanies the article published at [GITHUB LINK]." />
  <meta name="github-repo" content="timothee-bacri/HMM_with_TMB" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Principles of using TMB for Maximum Likelihood Estimation | [ UNDER CONSTRUCTION ] A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  
  <meta name="twitter:description" content="This accompanies the article published at [GITHUB LINK]." />
  

<meta name="author" content="Timothée Bacri timothee.bacri@uib.no" />
<meta name="author" content="Jan Bulla jan.bulla@uib.no" />
<meta name="author" content="Geir Berentsen geir.berentsen@nhh.no" />
<meta name="author" content="Sondre Hølleland sondre.hoelleland@hi.no" />


<meta name="date" content="2021-07-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="state-inf.html"/>
<link rel="next" href="parameter-estimation-techniques.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Accompaniment of A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Summary</a></li>
<li class="chapter" data-level="1" data-path="state-inf.html"><a href="state-inf.html"><i class="fa fa-check"></i><b>1</b> State inference</a><ul>
<li class="chapter" data-level="1.1" data-path="state-inf.html"><a href="state-inf.html#prepare-the-model"><i class="fa fa-check"></i><b>1.1</b> Prepare the model</a></li>
<li class="chapter" data-level="1.2" data-path="state-inf.html"><a href="state-inf.html#setup"><i class="fa fa-check"></i><b>1.2</b> Setup</a><ul>
<li class="chapter" data-level="1.2.1" data-path="state-inf.html"><a href="state-inf.html#define-variables"><i class="fa fa-check"></i><b>1.2.1</b> Define variables</a></li>
<li class="chapter" data-level="1.2.2" data-path="state-inf.html"><a href="state-inf.html#emissionoutput-probabilities"><i class="fa fa-check"></i><b>1.2.2</b> Emission/output probabilities</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="state-inf.html"><a href="state-inf.html#log-forward"><i class="fa fa-check"></i><b>1.3</b> Log-forward probabilities</a></li>
<li class="chapter" data-level="1.4" data-path="state-inf.html"><a href="state-inf.html#log-backward"><i class="fa fa-check"></i><b>1.4</b> Log-backward probabilities</a></li>
<li class="chapter" data-level="1.5" data-path="state-inf.html"><a href="state-inf.html#local-decoding"><i class="fa fa-check"></i><b>1.5</b> Smoothing probabilities and local decoding</a></li>
<li class="chapter" data-level="1.6" data-path="state-inf.html"><a href="state-inf.html#forecast"><i class="fa fa-check"></i><b>1.6</b> Forecast, h-step-ahead-probabilities</a></li>
<li class="chapter" data-level="1.7" data-path="state-inf.html"><a href="state-inf.html#global-decoding"><i class="fa fa-check"></i><b>1.7</b> Global decoding using the Viterbi algorithm</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><i class="fa fa-check"></i><b>2</b> Principles of using <code>TMB</code> for Maximum Likelihood Estimation</a><ul>
<li class="chapter" data-level="2.1" data-path="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#setting-up-tmb"><i class="fa fa-check"></i><b>2.1</b> Setting up <code>TMB</code></a></li>
<li class="chapter" data-level="2.2" data-path="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#getting-started-with-a-linear-regression"><i class="fa fa-check"></i><b>2.2</b> Getting started with a linear regression</a></li>
<li class="chapter" data-level="2.3" data-path="principles-of-using-tmb-for-maximum-likelihood-estimation.html"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#extending-the-c-negative-log-likelihood"><i class="fa fa-check"></i><b>2.3</b> Extending the <code>C++</code> negative log-likelihood</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="parameter-estimation-techniques.html"><a href="parameter-estimation-techniques.html"><i class="fa fa-check"></i><b>3</b> Parameter estimation techniques</a><ul>
<li class="chapter" data-level="3.1" data-path="parameter-estimation-techniques.html"><a href="parameter-estimation-techniques.html#negative-log-likelihood-in-tmb"><i class="fa fa-check"></i><b>3.1</b> Negative log-likelihood in <code>TMB</code></a></li>
<li class="chapter" data-level="3.2" data-path="parameter-estimation-techniques.html"><a href="parameter-estimation-techniques.html#utility-functions"><i class="fa fa-check"></i><b>3.2</b> Utility functions</a><ul>
<li class="chapter" data-level="3.2.1" data-path="parameter-estimation-techniques.html"><a href="parameter-estimation-techniques.html#in-tmb"><i class="fa fa-check"></i><b>3.2.1</b> In <code>TMB</code></a></li>
<li class="chapter" data-level="3.2.2" data-path="parameter-estimation-techniques.html"><a href="parameter-estimation-techniques.html#in-r"><i class="fa fa-check"></i><b>3.2.2</b> In <code>R</code></a><ul>
<li class="chapter" data-level="3.2.2.1" data-path="parameter-estimation-techniques.html"><a href="parameter-estimation-techniques.html#parameters"><i class="fa fa-check"></i><b>3.2.2.1</b> Parameters</a></li>
<li class="chapter" data-level="3.2.2.2" data-path="parameter-estimation-techniques.html"><a href="parameter-estimation-techniques.html#label-switching"><i class="fa fa-check"></i><b>3.2.2.2</b> Label switching</a></li>
</ul></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="using-tmb.html"><a href="using-tmb.html"><i class="fa fa-check"></i><b>4</b> Using TMB</a><ul>
<li class="chapter" data-level="4.1" data-path="using-tmb.html"><a href="using-tmb.html#likelihood-function"><i class="fa fa-check"></i><b>4.1</b> Likelihood function</a></li>
<li class="chapter" data-level="4.2" data-path="using-tmb.html"><a href="using-tmb.html#preparing-data-and-functions"><i class="fa fa-check"></i><b>4.2</b> Preparing data and functions</a></li>
<li class="chapter" data-level="4.3" data-path="using-tmb.html"><a href="using-tmb.html#modeling"><i class="fa fa-check"></i><b>4.3</b> Modeling</a></li>
<li class="chapter" data-level="4.4" data-path="using-tmb.html"><a href="using-tmb.html#nested-models"><i class="fa fa-check"></i><b>4.4</b> Nested models</a><ul>
<li class="chapter" data-level="4.4.1" data-path="using-tmb.html"><a href="using-tmb.html#principle"><i class="fa fa-check"></i><b>4.4.1</b> Principle</a></li>
<li class="chapter" data-level="4.4.2" data-path="using-tmb.html"><a href="using-tmb.html#limit"><i class="fa fa-check"></i><b>4.4.2</b> Limit</a></li>
<li class="chapter" data-level="4.4.3" data-path="using-tmb.html"><a href="using-tmb.html#parameter-equality-constraints"><i class="fa fa-check"></i><b>4.4.3</b> Parameter equality constraints</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="confidence-intervals.html"><a href="confidence-intervals.html"><i class="fa fa-check"></i><b>5</b> Confidence intervals</a><ul>
<li class="chapter" data-level="5.1" data-path="confidence-intervals.html"><a href="confidence-intervals.html#wald-type"><i class="fa fa-check"></i><b>5.1</b> Wald-type</a></li>
<li class="chapter" data-level="5.2" data-path="confidence-intervals.html"><a href="confidence-intervals.html#parametric-bootstrap"><i class="fa fa-check"></i><b>5.2</b> Parametric bootstrap</a><ul>
<li class="chapter" data-level="5.2.1" data-path="confidence-intervals.html"><a href="confidence-intervals.html#generating-data"><i class="fa fa-check"></i><b>5.2.1</b> Generating data</a></li>
<li class="chapter" data-level="5.2.2" data-path="confidence-intervals.html"><a href="confidence-intervals.html#bootstrap"><i class="fa fa-check"></i><b>5.2.2</b> Bootstrap</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="confidence-intervals.html"><a href="confidence-intervals.html#profiling-the-negative-log-likelihood"><i class="fa fa-check"></i><b>5.3</b> Profiling the negative log-likelihood</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html"><i class="fa fa-check"></i><b>6</b> Application to different data sets</a><ul>
<li class="chapter" data-level="6.1" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#tyt-dataset"><i class="fa fa-check"></i><b>6.1</b> TYT dataset</a></li>
<li class="chapter" data-level="6.2" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#simulated-dataset"><i class="fa fa-check"></i><b>6.2</b> Simulated dataset</a></li>
<li class="chapter" data-level="6.3" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#lamb-data"><i class="fa fa-check"></i><b>6.3</b> Lamb data</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="github-directory-structure.html"><a href="github-directory-structure.html"><i class="fa fa-check"></i><b>7</b> GitHub directory structure</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">[ UNDER CONSTRUCTION ] A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="principles-of-using-tmb-for-maximum-likelihood-estimation" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Principles of using <code>TMB</code> for Maximum Likelihood Estimation</h1>
<div id="setting-up-tmb" class="section level2">
<h2><span class="header-section-number">2.1</span> Setting up <code>TMB</code></h2>
<p>In order to run the scripts and example code, you first need to set up TMB by going through the following steps:</p>
<ul>
<li><p>Install <a href="https://cran.r-project.org/bin/windows/Rtools/">Rtools</a></p></li>
<li><p>Install the R-package <code>TMB</code> <span class="citation">(Kristensen <a href="#ref-R-TMB" role="doc-biblioref">2021</a>)</span> by executing the following code in R:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb16-1"></a><span class="kw">install.packages</span>(<span class="st">&quot;TMB&quot;</span>)</span></code></pre></div></li>
<li><p>(Optional) Setup error debugging in <code>RStudio</code> by running the command <code>TMB::setupRstudio()</code></p></li>
</ul>
<p>Advanced use is detailed in <a href="https://kaskr.github.io/adcomp/_book/Tutorial.html" class="uri">https://kaskr.github.io/adcomp/_book/Tutorial.html</a></p>
</div>
<div id="getting-started-with-a-linear-regression" class="section level2">
<h2><span class="header-section-number">2.2</span> Getting started with a linear regression</h2>
<p>Let <span class="math inline">\({\boldsymbol x}\)</span> and <span class="math inline">\({\boldsymbol y}\)</span> denote the predictor and response vector, respectively, both of length <span class="math inline">\(n\)</span>.
For a simple linear regression model with intercept <span class="math inline">\(a\)</span> and slope <span class="math inline">\(b\)</span>, the negative log-likelihood equals
<span class="math display">\[\begin{equation*}
- \log L(a, b, \sigma^2) = - \sum_{i=1}^n \log(\phi(y_i; a + bx_i, \sigma^2)),
\end{equation*}\]</span>
where <span class="math inline">\(\phi(\cdot; \mu, \sigma^2)\)</span> corresponds to the density function of the univariate normal distribution with mean <span class="math inline">\(\mu\)</span> and variance <span class="math inline">\(\sigma^2\)</span>.</p>
<p>The use of <code>TMB</code> requires the (negative) log-likelihood function to be coded in C++ under a specific template, which is then loaded into R.
The minimization of this function and other post-processing procedures are all carried out in <code>R</code>.
Therefore, we require two files.<br />
The first file, named <a href="code/linreg.cpp"><em>linreg.cpp</em></a>, is written in C++ and defines the objective function, i.e. the negative log-likelihood (nll) function of the linear model.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-1"></a><span class="pp">#include </span><span class="im">&lt;TMB.hpp&gt;</span><span class="pp"> </span><span class="co">//import the TMB template</span></span>
<span id="cb17-2"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-2"></a></span>
<span id="cb17-3"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-3"></a><span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;</span>
<span id="cb17-4"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-4"></a>Type objective_function&lt;Type&gt;::<span class="kw">operator</span>() ()</span>
<span id="cb17-5"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-5"></a>{</span>
<span id="cb17-6"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-6"></a>  DATA_VECTOR(y); <span class="co">// Data vector y passed from R</span></span>
<span id="cb17-7"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-7"></a>  DATA_VECTOR(x); <span class="co">// Data vector x passed from R</span></span>
<span id="cb17-8"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-8"></a>  </span>
<span id="cb17-9"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-9"></a>  PARAMETER(a);         <span class="co">// Parameter a passed from R </span></span>
<span id="cb17-10"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-10"></a>  PARAMETER(b);         <span class="co">// Parameter b passed from R </span></span>
<span id="cb17-11"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-11"></a>  PARAMETER(tsigma);    <span class="co">// Parameter sigma (transformed, on log-scale) </span></span>
<span id="cb17-12"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-12"></a>                        <span class="co">// passed from R</span></span>
<span id="cb17-13"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-13"></a>  </span>
<span id="cb17-14"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-14"></a>  <span class="co">// Transform tsigma back to natural scale</span></span>
<span id="cb17-15"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-15"></a>  Type sigma = exp(tsigma);</span>
<span id="cb17-16"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-16"></a>  </span>
<span id="cb17-17"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-17"></a>  <span class="co">// Declare negative log-likelihood</span></span>
<span id="cb17-18"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-18"></a>  Type nll = - sum(dnorm(y,</span>
<span id="cb17-19"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-19"></a>                         a + b * x,</span>
<span id="cb17-20"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-20"></a>                         sigma,</span>
<span id="cb17-21"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-21"></a>                         <span class="kw">true</span>));</span>
<span id="cb17-22"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-22"></a>  </span>
<span id="cb17-23"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-23"></a>  <span class="co">// Necessary for inference on sigma, not only tsigma</span></span>
<span id="cb17-24"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-24"></a>  ADREPORT(sigma);</span>
<span id="cb17-25"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-25"></a>  </span>
<span id="cb17-26"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-26"></a>  <span class="cf">return</span> nll;</span>
<span id="cb17-27"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb17-27"></a>}</span></code></pre></div>
<p>The second file needed is written in <code>R</code> and serves for compiling the nll function defined above and carrying out the estimation procedure by numerical optimization of the nll function.
The .R file (shown below) carries out the compilation of the C++ file and minimization of the nll function:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb18-1"></a><span class="co"># Loading TMB package</span></span>
<span id="cb18-2"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb18-2"></a><span class="kw">library</span>(TMB)</span>
<span id="cb18-3"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb18-3"></a><span class="co"># Compilation. The compiler returns 0 if the compilation of</span></span>
<span id="cb18-4"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb18-4"></a><span class="co"># the cpp file was successful</span></span>
<span id="cb18-5"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb18-5"></a>TMB<span class="op">::</span><span class="kw">compile</span>(<span class="st">&quot;code/linreg.cpp&quot;</span>)</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb20-1"></a><span class="co"># Dynamic loading of the compiled cpp file</span></span>
<span id="cb20-2"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb20-2"></a><span class="kw">dyn.load</span>(<span class="kw">dynlib</span>(<span class="st">&quot;code/linreg&quot;</span>))</span></code></pre></div>
<pre><code>## Warning: 2 external pointers will be removed</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-1"></a><span class="co"># Generate the data for our test sample</span></span>
<span id="cb22-2"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-2"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb22-3"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-3"></a>data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">y =</span> <span class="kw">rnorm</span>(<span class="dv">20</span>) <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">20</span>, <span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">20</span>)</span>
<span id="cb22-4"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-4"></a>parameters &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">a =</span> <span class="dv">0</span>, <span class="dt">b =</span> <span class="dv">0</span>, <span class="dt">tsigma =</span> <span class="dv">0</span>)</span>
<span id="cb22-5"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-5"></a><span class="co"># Instruct TMB to create the likelihood function</span></span>
<span id="cb22-6"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-6"></a>obj_linreg &lt;-<span class="st"> </span><span class="kw">MakeADFun</span>(data, parameters, <span class="dt">DLL =</span> <span class="st">&quot;linreg&quot;</span>,</span>
<span id="cb22-7"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-7"></a>                        <span class="dt">silent =</span> <span class="ot">TRUE</span>)</span>
<span id="cb22-8"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-8"></a><span class="co"># Optimization of the objective function with nlminb</span></span>
<span id="cb22-9"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-9"></a>mod_linreg &lt;-<span class="st"> </span><span class="kw">nlminb</span>(obj_linreg<span class="op">$</span>par, obj_linreg<span class="op">$</span>fn,</span>
<span id="cb22-10"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-10"></a>                     obj_linreg<span class="op">$</span>gr,</span>
<span id="cb22-11"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-11"></a>                     obj_linreg<span class="op">$</span>he)</span>
<span id="cb22-12"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb22-12"></a>mod_linreg<span class="op">$</span>par</span></code></pre></div>
<pre><code>##           a           b      tsigma 
##  0.31009251  0.98395536 -0.05814649</code></pre>
<p>Now that the optimization is taken care of, we can display the estimates with standard errors using the <code>sdreport</code> function.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb24-1"></a><span class="kw">sdreport</span>(obj_linreg)</span></code></pre></div>
<pre><code>## sdreport(.) result
##           Estimate Std. Error
## a       0.31009251 0.43829087
## b       0.98395536 0.03658782
## tsigma -0.05814649 0.15811383
## Maximum gradient component: 1.300261e-10</code></pre>
<p>If we use <code>summary</code> on this object, we also get the variables we have passed to <code>ADREPORT</code> in the <a href="code/linreg.cpp"><em>linreg.cpp</em></a> file. In this example, this is only the residual standard deviation; <code>sigma</code>.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb26-1"></a><span class="kw">summary</span>(<span class="kw">sdreport</span>(obj_linreg))</span></code></pre></div>
<pre><code>##           Estimate Std. Error
## a       0.31009251 0.43829087
## b       0.98395536 0.03658782
## tsigma -0.05814649 0.15811383
## sigma   0.94351172 0.14918225</code></pre>
<p>The <code>select</code> argument restricts the output to variables passed
by <code>ADREPORT(variable_name);</code> in the cpp file.
As we will see in <a href="confidence-intervals.html#wald-type">Wald-type</a>, this lets us derive confidence intervals for these natural parameters easily.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb28-1"></a><span class="kw">summary</span>(<span class="kw">sdreport</span>(obj_linreg), <span class="dt">select =</span> <span class="st">&quot;report&quot;</span>)</span></code></pre></div>
<pre><code>##        Estimate Std. Error
## sigma 0.9435117  0.1491823</code></pre>
<p>Certainly, you would not build a TMB model to fit a linear regression. We can use standard R functions for that. Therefore, we use <code>stats::lm</code> on the same data and compare the estimates to those obtained by <code>TMB</code>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb30-1"></a><span class="kw">rbind</span>(</span>
<span id="cb30-2"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb30-2"></a>  <span class="st">&quot;lm&quot;</span>  =<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> data)<span class="op">$</span>coef, <span class="co"># linear regression using R</span></span>
<span id="cb30-3"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb30-3"></a>  <span class="st">&quot;TMB&quot;</span> =<span class="st"> </span>mod_linreg<span class="op">$</span>par[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] <span class="co"># intercept and slope from TMB fit</span></span>
<span id="cb30-4"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb30-4"></a>)</span></code></pre></div>
<pre><code>##     (Intercept)         x
## lm    0.3100925 0.9839554
## TMB   0.3100925 0.9839554</code></pre>
<p>As we can see, the parameter estimates are exactly the same.</p>
</div>
<div id="extending-the-c-negative-log-likelihood" class="section level2">
<h2><span class="header-section-number">2.3</span> Extending the <code>C++</code> negative log-likelihood</h2>
<p>Sometimes it is useful to write subroutines as a separate function that can be used within your TMB likelihood function. This can increase readability of your code and reduce the number of lines of code in your main cpp file. Writing extra files to define functions compatible with <code>TMB</code> requires some care, as these must follow <code>TMB</code>’s template.
<!-- It is noteworthy that `linreg.cpp` doesn't have to contain many lines of code, as they can be distributed in other files and loaded. --></p>
<p>To illustrate how this works, we add a separate function to the <a href="code/linreg.cpp"><em>linreg.cpp</em></a> example. The following function does not do anything meaningful, but is just meant to show you how you can add write an additional function and load it into your C++. We start by writing the subroutine function as a separate file called <a href="functions/utils_linreg.cpp"><em>functions/utils_linreg.cpp</em></a>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb32-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-1"></a><span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;</span>
<span id="cb32-2"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-2"></a>matrix&lt;Type&gt; function_example(matrix&lt;Type&gt; mat_example) {</span>
<span id="cb32-3"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-3"></a>  </span>
<span id="cb32-4"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-4"></a>  <span class="co">// This function doesn&#39;t do anything meaningful</span></span>
<span id="cb32-5"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-5"></a>  matrix&lt;Type&gt; mat(<span class="dv">2</span>, <span class="dv">3</span>);</span>
<span id="cb32-6"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-6"></a>  mat.setOnes();</span>
<span id="cb32-7"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-7"></a>  mat.row(<span class="dv">1</span>) &lt;&lt; <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>;</span>
<span id="cb32-8"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-8"></a>  mat(<span class="dv">0</span>, <span class="dv">2</span>) = mat.row(<span class="dv">1</span>).sum();</span>
<span id="cb32-9"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-9"></a>  </span>
<span id="cb32-10"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-10"></a>  <span class="cf">return</span> mat;</span>
<span id="cb32-11"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb32-11"></a>}</span></code></pre></div>
<p>We then import it into <code>linreg.cpp</code> (<a href="code/linreg_utils.cpp"><em>code/linreg_utils.cpp</em></a>).</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb33-1"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-1"></a><span class="pp">#include </span><span class="im">&lt;TMB.hpp&gt;</span><span class="pp"> </span><span class="co">//import the TMB template</span></span>
<span id="cb33-2"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-2"></a><span class="pp">#include </span><span class="im">&quot;../functions/utils_linreg.cpp&quot;</span></span>
<span id="cb33-3"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-3"></a></span>
<span id="cb33-4"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-4"></a><span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;</span>
<span id="cb33-5"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-5"></a>Type objective_function&lt;Type&gt;::<span class="kw">operator</span>() ()</span>
<span id="cb33-6"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-6"></a>{</span>
<span id="cb33-7"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-7"></a>  DATA_VECTOR(y); <span class="co">// Data vector y passed from R</span></span>
<span id="cb33-8"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-8"></a>  DATA_VECTOR(x); <span class="co">// Data vector x passed from R</span></span>
<span id="cb33-9"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-9"></a>  </span>
<span id="cb33-10"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-10"></a>  PARAMETER(a);         <span class="co">// Parameter a passed from R </span></span>
<span id="cb33-11"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-11"></a>  PARAMETER(b);         <span class="co">// Parameter b passed from R </span></span>
<span id="cb33-12"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-12"></a>  PARAMETER(tsigma);    <span class="co">// Parameter sigma (transformed, on log-scale) </span></span>
<span id="cb33-13"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-13"></a>                        <span class="co">// passed from R</span></span>
<span id="cb33-14"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-14"></a>  </span>
<span id="cb33-15"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-15"></a>  <span class="co">// Transform tsigma back to natural scale</span></span>
<span id="cb33-16"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-16"></a>  Type sigma = exp(tsigma);</span>
<span id="cb33-17"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-17"></a>  </span>
<span id="cb33-18"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-18"></a>  <span class="co">// Declare negative log-likelihood</span></span>
<span id="cb33-19"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-19"></a>  Type nll = - sum(dnorm(y,</span>
<span id="cb33-20"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-20"></a>                         a + b * x,</span>
<span id="cb33-21"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-21"></a>                         sigma,</span>
<span id="cb33-22"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-22"></a>                         <span class="kw">true</span>));</span>
<span id="cb33-23"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-23"></a>  </span>
<span id="cb33-24"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-24"></a>  <span class="co">// Necessary for inference on sigma, not only tsigma</span></span>
<span id="cb33-25"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-25"></a>  ADREPORT(sigma);</span>
<span id="cb33-26"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-26"></a>  </span>
<span id="cb33-27"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-27"></a>  <span class="co">/* This is a useless example to show how to manipulate matrices</span></span>
<span id="cb33-28"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-28"></a><span class="co">   * in C++</span></span>
<span id="cb33-29"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-29"></a><span class="co">   * This creates a matrix of 2 rows and 3 columns.</span></span>
<span id="cb33-30"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-30"></a><span class="co">   * The Eigen library is used to manipulate vectors, arrays, matrices...</span></span>
<span id="cb33-31"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-31"></a><span class="co">   */</span></span>
<span id="cb33-32"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-32"></a>  matrix&lt;Type&gt; mat_example(<span class="dv">2</span>, <span class="dv">3</span>);</span>
<span id="cb33-33"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-33"></a>  mat_example &lt;&lt; <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>,</span>
<span id="cb33-34"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-34"></a>                 <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>;</span>
<span id="cb33-35"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-35"></a>  matrix&lt;Type&gt; mat_example2 = function_example(mat_example);</span>
<span id="cb33-36"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-36"></a>  </span>
<span id="cb33-37"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-37"></a>  <span class="co">// This lets us retrieve any variables in a nice format</span></span>
<span id="cb33-38"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-38"></a>  REPORT(mat_example);</span>
<span id="cb33-39"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-39"></a>  REPORT(mat_example2);</span>
<span id="cb33-40"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-40"></a>  </span>
<span id="cb33-41"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-41"></a>  <span class="cf">return</span> nll;</span>
<span id="cb33-42"><a href="principles-of-using-tmb-for-maximum-likelihood-estimation.html#cb33-42"></a>}</span></code></pre></div>

<!-- ```{r 3import-files, echo = FALSE, cache = FALSE} -->
<!-- library(knitr) -->
<!-- setwd(dir = "../") -->
<!-- # suppressMessages(source("code/main.R")) -->
<!-- knitr::read_chunk('functions/utils.R') -->
<!-- ``` -->
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-R-TMB">
<p>Kristensen, Kasper. 2021. <em>TMB: Template Model Builder: A General Random Effect Tool Inspired by Admb</em>. <a href="https://github.com/kaskr/adcomp/wiki">https://github.com/kaskr/adcomp/wiki</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="state-inf.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="parameter-estimation-techniques.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Data supplements.pdf", "Data supplements.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
