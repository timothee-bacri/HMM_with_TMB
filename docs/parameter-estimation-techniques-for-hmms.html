<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title> 3 Parameter estimation techniquesfor HMMs | A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</title>
  <meta name="description" content="This accompanies the article published at [GITHUB LINK]." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content=" 3 Parameter estimation techniquesfor HMMs | A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/timothee-bacri/HMM_with_TMB" />
  
  <meta property="og:description" content="This accompanies the article published at [GITHUB LINK]." />
  <meta name="github-repo" content="timothee-bacri/HMM_with_TMB" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content=" 3 Parameter estimation techniquesfor HMMs | A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder" />
  
  <meta name="twitter:description" content="This accompanies the article published at [GITHUB LINK]." />
  

<meta name="author" content="Timothée Bacri timothee.bacri@uib.no" />
<meta name="author" content="Jan Bulla jan.bulla@uib.no" />
<meta name="author" content="Geir Berentsen geir.berentsen@nhh.no" />
<meta name="author" content="Sondre Hølleland sondre.hoelleland@hi.no" />


<meta name="date" content="2021-12-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="principles-of-using-tmb-for-mle.html"/>
<link rel="next" href="using-tmb.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="width.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A gentle tutorial of accelerated<br>parameter and confidence interval<br>estimation for Hidden Markov Models<BR>using Template Model Builder</a></li>
<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="principles-of-using-tmb-for-mle.html"><a href="principles-of-using-tmb-for-mle.html"><i class="fa fa-check"></i><b>2</b> Principles of using <code>TMB</code> for MLE</a>
<ul>
<li class="chapter" data-level="2.1" data-path="principles-of-using-tmb-for-mle.html"><a href="principles-of-using-tmb-for-mle.html#setup"><i class="fa fa-check"></i><b>2.1</b> Setup</a></li>
<li class="chapter" data-level="2.2" data-path="principles-of-using-tmb-for-mle.html"><a href="principles-of-using-tmb-for-mle.html#linear-regression-example"><i class="fa fa-check"></i><b>2.2</b> Linear regression example</a></li>
<li class="chapter" data-level="2.3" data-path="principles-of-using-tmb-for-mle.html"><a href="principles-of-using-tmb-for-mle.html#extending-the-c-nll"><i class="fa fa-check"></i><b>2.3</b> Extending the <code>C++</code> nll</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html"><i class="fa fa-check"></i><b>3</b> Parameter estimation techniques<br>for HMMs</a>
<ul>
<li class="chapter" data-level="3.1" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#basic-notation-and-model-setup"><i class="fa fa-check"></i><b>3.1</b> Basic notation and model setup</a></li>
<li class="chapter" data-level="3.2" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#the-likelihood-function-of-an-hmm"><i class="fa fa-check"></i><b>3.2</b> The likelihood function of an HMM</a></li>
<li class="chapter" data-level="3.3" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#forward-backward"><i class="fa fa-check"></i><b>3.3</b> Forward algorithm and<br>backward algorithm</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#setup-1"><i class="fa fa-check"></i><b>3.3.1</b> Setup</a>
<ul>
<li class="chapter" data-level="3.3.1.1" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#prepare-the-model"><i class="fa fa-check"></i><b>3.3.1.1</b> Prepare the model</a></li>
<li class="chapter" data-level="3.3.1.2" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#define-variables"><i class="fa fa-check"></i><b>3.3.1.2</b> Define variables</a></li>
<li class="chapter" data-level="3.3.1.3" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#emissionoutput-probabilities"><i class="fa fa-check"></i><b>3.3.1.3</b> Emission/output probabilities</a></li>
</ul></li>
<li class="chapter" data-level="3.3.2" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#log-forward"><i class="fa fa-check"></i><b>3.3.2</b> Log-forward probabilities</a></li>
<li class="chapter" data-level="3.3.3" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#log-backward"><i class="fa fa-check"></i><b>3.3.3</b> Log-backward probabilities</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#reparameterization-of-the-likelihood-function"><i class="fa fa-check"></i><b>3.4</b> Reparameterization of the<br>likelihood function</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#utility-functions-in-tmb"><i class="fa fa-check"></i><b>3.4.1</b> Utility functions in <code>TMB</code></a></li>
<li class="chapter" data-level="3.4.2" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#utility-functions-in-r"><i class="fa fa-check"></i><b>3.4.2</b> Utility functions in <code>R</code></a>
<ul>
<li class="chapter" data-level="3.4.2.1" data-path="parameter-estimation-techniques-for-hmms.html"><a href="parameter-estimation-techniques-for-hmms.html#label-switching"><i class="fa fa-check"></i><b>3.4.2.1</b> Label switching</a></li>
</ul></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="using-tmb.html"><a href="using-tmb.html"><i class="fa fa-check"></i><b>4</b> Using <code>TMB</code></a>
<ul>
<li class="chapter" data-level="4.1" data-path="using-tmb.html"><a href="using-tmb.html#likelihood-function"><i class="fa fa-check"></i><b>4.1</b> Likelihood function</a></li>
<li class="chapter" data-level="4.2" data-path="using-tmb.html"><a href="using-tmb.html#optimization"><i class="fa fa-check"></i><b>4.2</b> Optimization</a></li>
<li class="chapter" data-level="4.3" data-path="using-tmb.html"><a href="using-tmb.html#basic-nested-model-specification"><i class="fa fa-check"></i><b>4.3</b> Basic nested model<br>specification</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="using-tmb.html"><a href="using-tmb.html#principle"><i class="fa fa-check"></i><b>4.3.1</b> Principle</a></li>
<li class="chapter" data-level="4.3.2" data-path="using-tmb.html"><a href="using-tmb.html#limits"><i class="fa fa-check"></i><b>4.3.2</b> Limits</a></li>
<li class="chapter" data-level="4.3.3" data-path="using-tmb.html"><a href="using-tmb.html#param-eq-constraints"><i class="fa fa-check"></i><b>4.3.3</b> Parameter equality<br>constraints</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="using-tmb.html"><a href="using-tmb.html#state-inference"><i class="fa fa-check"></i><b>4.4</b> State inference and forecasting</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="using-tmb.html"><a href="using-tmb.html#local-decoding"><i class="fa fa-check"></i><b>4.4.1</b> Local decoding</a></li>
<li class="chapter" data-level="4.4.2" data-path="using-tmb.html"><a href="using-tmb.html#forecast"><i class="fa fa-check"></i><b>4.4.2</b> Forecast</a></li>
<li class="chapter" data-level="4.4.3" data-path="using-tmb.html"><a href="using-tmb.html#global-decoding"><i class="fa fa-check"></i><b>4.4.3</b> Global decoding</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="using-tmb.html"><a href="using-tmb.html#appendix"><i class="fa fa-check"></i><b>4.5</b> Appendix</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="confidence-intervals.html"><a href="confidence-intervals.html"><i class="fa fa-check"></i><b>5</b> Confidence intervals</a>
<ul>
<li class="chapter" data-level="5.1" data-path="confidence-intervals.html"><a href="confidence-intervals.html#Wald-type"><i class="fa fa-check"></i><b>5.1</b> Wald-type confidence<br>intervals based on the Hessian</a></li>
<li class="chapter" data-level="5.2" data-path="confidence-intervals.html"><a href="confidence-intervals.html#likelihood-profile-based-confidence-intervals"><i class="fa fa-check"></i><b>5.2</b> Likelihood profile based<br>confidence intervals</a></li>
<li class="chapter" data-level="5.3" data-path="confidence-intervals.html"><a href="confidence-intervals.html#bootstrap-based-confidence-intervals"><i class="fa fa-check"></i><b>5.3</b> Bootstrap-based<br>confidence intervals</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="confidence-intervals.html"><a href="confidence-intervals.html#generating-data"><i class="fa fa-check"></i><b>5.3.1</b> Generating data</a></li>
<li class="chapter" data-level="5.3.2" data-path="confidence-intervals.html"><a href="confidence-intervals.html#bootstrap"><i class="fa fa-check"></i><b>5.3.2</b> Bootstrap</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html"><i class="fa fa-check"></i><b>6</b> Application to different data sets</a>
<ul>
<li class="chapter" data-level="6.1" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#tyt-data"><i class="fa fa-check"></i><b>6.1</b> TYT data</a></li>
<li class="chapter" data-level="6.2" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#lamb-data"><i class="fa fa-check"></i><b>6.2</b> Lamb data</a></li>
<li class="chapter" data-level="6.3" data-path="application-to-different-data-sets.html"><a href="application-to-different-data-sets.html#simulated-data"><i class="fa fa-check"></i><b>6.3</b> Simulated data</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="gaussian-hmm.html"><a href="gaussian-hmm.html"><i class="fa fa-check"></i><b>7</b> Gaussian HMM</a>
<ul>
<li class="chapter" data-level="7.1" data-path="gaussian-hmm.html"><a href="gaussian-hmm.html#dataset"><i class="fa fa-check"></i><b>7.1</b> Dataset</a></li>
<li class="chapter" data-level="7.2" data-path="gaussian-hmm.html"><a href="gaussian-hmm.html#likelihood-function-1"><i class="fa fa-check"></i><b>7.2</b> Likelihood function</a></li>
<li class="chapter" data-level="7.3" data-path="gaussian-hmm.html"><a href="gaussian-hmm.html#estimation"><i class="fa fa-check"></i><b>7.3</b> Estimation</a></li>
<li class="chapter" data-level="7.4" data-path="gaussian-hmm.html"><a href="gaussian-hmm.html#results"><i class="fa fa-check"></i><b>7.4</b> Results</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="multivariate-gaussian-hmm.html"><a href="multivariate-gaussian-hmm.html"><i class="fa fa-check"></i><b>8</b> Multivariate Gaussian HMM</a>
<ul>
<li class="chapter" data-level="8.1" data-path="multivariate-gaussian-hmm.html"><a href="multivariate-gaussian-hmm.html#dataset-parameters"><i class="fa fa-check"></i><b>8.1</b> Dataset &amp; Parameters</a></li>
<li class="chapter" data-level="8.2" data-path="multivariate-gaussian-hmm.html"><a href="multivariate-gaussian-hmm.html#likelihood-function-2"><i class="fa fa-check"></i><b>8.2</b> Likelihood function</a></li>
<li class="chapter" data-level="8.3" data-path="multivariate-gaussian-hmm.html"><a href="multivariate-gaussian-hmm.html#estimation-1"><i class="fa fa-check"></i><b>8.3</b> Estimation</a></li>
<li class="chapter" data-level="8.4" data-path="multivariate-gaussian-hmm.html"><a href="multivariate-gaussian-hmm.html#results-1"><i class="fa fa-check"></i><b>8.4</b> Results</a></li>
<li class="chapter" data-level="8.5" data-path="multivariate-gaussian-hmm.html"><a href="multivariate-gaussian-hmm.html#bias"><i class="fa fa-check"></i><b>8.5</b> Bias</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="github.html"><a href="github.html"><i class="fa fa-check"></i><b>9</b> GitHub</a>
<ul>
<li class="chapter" data-level="9.1" data-path="github.html"><a href="github.html#directory-structure"><i class="fa fa-check"></i><b>9.1</b> Directory structure</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="github.html"><a href="github.html#code"><i class="fa fa-check"></i><b>9.1.1</b> code/</a></li>
<li class="chapter" data-level="9.1.2" data-path="github.html"><a href="github.html#linreg.cpp"><i class="fa fa-check"></i><b>9.1.2</b> code/linreg.cpp</a></li>
<li class="chapter" data-level="9.1.3" data-path="github.html"><a href="github.html#linreg_extended.cpp"><i class="fa fa-check"></i><b>9.1.3</b> code/linreg_extended.cpp</a></li>
<li class="chapter" data-level="9.1.4" data-path="github.html"><a href="github.html#main.R"><i class="fa fa-check"></i><b>9.1.4</b> code/main.R</a></li>
<li class="chapter" data-level="9.1.5" data-path="github.html"><a href="github.html#mvnorm_hmm.cpp"><i class="fa fa-check"></i><b>9.1.5</b> code/mvnorm_hmm.cpp</a></li>
<li class="chapter" data-level="9.1.6" data-path="github.html"><a href="github.html#norm_hmm.cpp"><i class="fa fa-check"></i><b>9.1.6</b> code/norm_hmm.cpp</a></li>
<li class="chapter" data-level="9.1.7" data-path="github.html"><a href="github.html#codepackages.r"><i class="fa fa-check"></i><b>9.1.7</b> code/packages.R</a></li>
<li class="chapter" data-level="9.1.8" data-path="github.html"><a href="github.html#poi_hmm.cpp"><i class="fa fa-check"></i><b>9.1.8</b> code/poi_hmm.cpp</a></li>
<li class="chapter" data-level="9.1.9" data-path="github.html"><a href="github.html#poi_hmm_lamb.R"><i class="fa fa-check"></i><b>9.1.9</b> code/poi_hmm_lamb.R</a></li>
<li class="chapter" data-level="9.1.10" data-path="github.html"><a href="github.html#poi_hmm_simu1.R"><i class="fa fa-check"></i><b>9.1.10</b> code/poi_hmm_simu1.R</a></li>
<li class="chapter" data-level="9.1.11" data-path="github.html"><a href="github.html#poi_hmm_simu2.R"><i class="fa fa-check"></i><b>9.1.11</b> code/poi_hmm_simu2.R</a></li>
<li class="chapter" data-level="9.1.12" data-path="github.html"><a href="github.html#poi_hmm_simu3.R"><i class="fa fa-check"></i><b>9.1.12</b> code/poi_hmm_simu3.R</a></li>
<li class="chapter" data-level="9.1.13" data-path="github.html"><a href="github.html#poi_hmm_simu4.R"><i class="fa fa-check"></i><b>9.1.13</b> code/poi_hmm_simu4.R</a></li>
<li class="chapter" data-level="9.1.14" data-path="github.html"><a href="github.html#poi_hmm_tinn.R"><i class="fa fa-check"></i><b>9.1.14</b> code/poi_hmm_tinn.R</a></li>
<li class="chapter" data-level="9.1.15" data-path="github.html"><a href="github.html#setup_parameters.R"><i class="fa fa-check"></i><b>9.1.15</b> code/setup_parameters.R</a></li>
<li class="chapter" data-level="9.1.16" data-path="github.html"><a href="github.html#data"><i class="fa fa-check"></i><b>9.1.16</b> data/</a></li>
<li class="chapter" data-level="9.1.17" data-path="github.html"><a href="github.html#fetal-lamb.RData"><i class="fa fa-check"></i><b>9.1.17</b> data/fetal-lamb.RData</a></li>
<li class="chapter" data-level="9.1.18" data-path="github.html"><a href="github.html#dataresults_lamb.rdata"><i class="fa fa-check"></i><b>9.1.18</b> data/results_lamb.RData</a></li>
<li class="chapter" data-level="9.1.19" data-path="github.html"><a href="github.html#dataresults_simu1.rdata"><i class="fa fa-check"></i><b>9.1.19</b> data/results_simu1.RData</a></li>
<li class="chapter" data-level="9.1.20" data-path="github.html"><a href="github.html#dataresults_simu2.rdata"><i class="fa fa-check"></i><b>9.1.20</b> data/results_simu2.RData</a></li>
<li class="chapter" data-level="9.1.21" data-path="github.html"><a href="github.html#dataresults_simu3.rdata"><i class="fa fa-check"></i><b>9.1.21</b> data/results_simu3.RData</a></li>
<li class="chapter" data-level="9.1.22" data-path="github.html"><a href="github.html#dataresults_simu4.rdata"><i class="fa fa-check"></i><b>9.1.22</b> data/results_simu4.RData</a></li>
<li class="chapter" data-level="9.1.23" data-path="github.html"><a href="github.html#dataresults_tinn.rdata"><i class="fa fa-check"></i><b>9.1.23</b> data/results_tinn.RData</a></li>
<li class="chapter" data-level="9.1.24" data-path="github.html"><a href="github.html#tinnitus.RData"><i class="fa fa-check"></i><b>9.1.24</b> data/tinnitus.RData</a></li>
<li class="chapter" data-level="9.1.25" data-path="github.html"><a href="github.html#functions"><i class="fa fa-check"></i><b>9.1.25</b> functions/</a></li>
<li class="chapter" data-level="9.1.26" data-path="github.html"><a href="github.html#mvnorm_utils.cpp"><i class="fa fa-check"></i><b>9.1.26</b> functions/mvnorm_utils.cpp</a></li>
<li class="chapter" data-level="9.1.27" data-path="github.html"><a href="github.html#mvnorm_utils.R"><i class="fa fa-check"></i><b>9.1.27</b> functions/mvnorm_utils.R</a></li>
<li class="chapter" data-level="9.1.28" data-path="github.html"><a href="github.html#norm_utils.cpp"><i class="fa fa-check"></i><b>9.1.28</b> functions/norm_utils.cpp</a></li>
<li class="chapter" data-level="9.1.29" data-path="github.html"><a href="github.html#norm_utils.R"><i class="fa fa-check"></i><b>9.1.29</b> functions/norm_utils.R</a></li>
<li class="chapter" data-level="9.1.30" data-path="github.html"><a href="github.html#utils.cpp"><i class="fa fa-check"></i><b>9.1.30</b> functions/utils.cpp</a></li>
<li class="chapter" data-level="9.1.31" data-path="github.html"><a href="github.html#utils.R"><i class="fa fa-check"></i><b>9.1.31</b> functions/utils.R</a></li>
<li class="chapter" data-level="9.1.32" data-path="github.html"><a href="github.html#utils.R-explanation.R"><i class="fa fa-check"></i><b>9.1.32</b> functions/utils.R-explanation.R</a></li>
<li class="chapter" data-level="9.1.33" data-path="github.html"><a href="github.html#utils_linreg_extended.cpp"><i class="fa fa-check"></i><b>9.1.33</b> functions/utils_linreg_extended.cpp</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">A gentle tutorial of accelerated parameter and confidence interval estimation for Hidden Markov Models using Template Model Builder</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="parameter-estimation-techniques-for-hmms" class="section level1" number="3">
<h1><span class="header-section-number"> 3</span> Parameter estimation techniques<br>for HMMs</h1>
<p>In this section we recall basic concepts underlying parameter estimation for HMMs via direct numerical optimization of the likelihood. In terms of notation, we stay as close as possible to <span class="citation"><a href="references.html#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, and Langrock</a> (<a href="references.html#ref-zucchini" role="doc-biblioref">2016</a>)</span>, where a more detailed presentation is available.</p>
<div id="basic-notation-and-model-setup" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Basic notation and model setup</h2>
<p>The conditional distribution densities can be called in <code>R</code> as well as in <code>C++</code> (provided that the <code>TMB</code> template is respected) via</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="parameter-estimation-techniques-for-hmms.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dpois</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">lambda =</span> <span class="dv">5</span>) <span class="co"># Poisson</span></span>
<span id="cb12-2"><a href="parameter-estimation-techniques-for-hmms.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.03368973</span></span>
<span id="cb12-3"><a href="parameter-estimation-techniques-for-hmms.html#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dnorm</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>) <span class="co"># Normal</span></span>
<span id="cb12-4"><a href="parameter-estimation-techniques-for-hmms.html#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.2419707</span></span></code></pre></div>
<p>Other distributions are available.</p>
<p>We let TPM denote the transition probability matrix, and reference it with the variable <span class="math inline">\({\boldsymbol\Gamma}\)</span>.</p>
</div>
<div id="the-likelihood-function-of-an-hmm" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> The likelihood function of an HMM</h2>
<p>The Poisson HMM negative log-likelihood function in <code>C++</code> can be written the following way using <code>TMB</code>’s template.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="parameter-estimation-techniques-for-hmms.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;TMB.hpp&gt;</span></span>
<span id="cb13-2"><a href="parameter-estimation-techniques-for-hmms.html#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;../functions/utils.cpp&quot;</span></span>
<span id="cb13-3"><a href="parameter-estimation-techniques-for-hmms.html#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="parameter-estimation-techniques-for-hmms.html#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Likelihood for a poisson hidden markov model. </span></span>
<span id="cb13-5"><a href="parameter-estimation-techniques-for-hmms.html#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">class</span> Type<span class="op">&gt;</span></span>
<span id="cb13-6"><a href="parameter-estimation-techniques-for-hmms.html#cb13-6" aria-hidden="true" tabindex="-1"></a>Type objective_function<span class="op">&lt;</span>Type<span class="op">&gt;::</span><span class="kw">operator</span><span class="op">()</span> <span class="op">()</span></span>
<span id="cb13-7"><a href="parameter-estimation-techniques-for-hmms.html#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-8"><a href="parameter-estimation-techniques-for-hmms.html#cb13-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-9"><a href="parameter-estimation-techniques-for-hmms.html#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Data</span></span>
<span id="cb13-10"><a href="parameter-estimation-techniques-for-hmms.html#cb13-10" aria-hidden="true" tabindex="-1"></a>  DATA_VECTOR<span class="op">(</span>x<span class="op">);</span>          <span class="co">// timeseries vector</span></span>
<span id="cb13-11"><a href="parameter-estimation-techniques-for-hmms.html#cb13-11" aria-hidden="true" tabindex="-1"></a>  DATA_INTEGER<span class="op">(</span>m<span class="op">);</span>         <span class="co">// Number of states m</span></span>
<span id="cb13-12"><a href="parameter-estimation-techniques-for-hmms.html#cb13-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-13"><a href="parameter-estimation-techniques-for-hmms.html#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Parameters</span></span>
<span id="cb13-14"><a href="parameter-estimation-techniques-for-hmms.html#cb13-14" aria-hidden="true" tabindex="-1"></a>  PARAMETER_VECTOR<span class="op">(</span>tlambda<span class="op">);</span>     <span class="co">// conditional log_lambdas&#39;s</span></span>
<span id="cb13-15"><a href="parameter-estimation-techniques-for-hmms.html#cb13-15" aria-hidden="true" tabindex="-1"></a>  PARAMETER_VECTOR<span class="op">(</span>tgamma<span class="op">);</span>      <span class="co">// m(m-1) working parameters of TPM</span></span>
<span id="cb13-16"><a href="parameter-estimation-techniques-for-hmms.html#cb13-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-17"><a href="parameter-estimation-techniques-for-hmms.html#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Uncomment only when using a non-stationary distribution</span></span>
<span id="cb13-18"><a href="parameter-estimation-techniques-for-hmms.html#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">//PARAMETER_VECTOR(tdelta);    // transformed stationary distribution,</span></span>
<span id="cb13-19"><a href="parameter-estimation-techniques-for-hmms.html#cb13-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-20"><a href="parameter-estimation-techniques-for-hmms.html#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Transform working parameters to natural parameters:</span></span>
<span id="cb13-21"><a href="parameter-estimation-techniques-for-hmms.html#cb13-21" aria-hidden="true" tabindex="-1"></a>  vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> lambda <span class="op">=</span> tlambda<span class="op">.</span>exp<span class="op">();</span></span>
<span id="cb13-22"><a href="parameter-estimation-techniques-for-hmms.html#cb13-22" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> gamma <span class="op">=</span> gamma_w2n<span class="op">(</span>m<span class="op">,</span> tgamma<span class="op">);</span></span>
<span id="cb13-23"><a href="parameter-estimation-techniques-for-hmms.html#cb13-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-24"><a href="parameter-estimation-techniques-for-hmms.html#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct stationary distribution</span></span>
<span id="cb13-25"><a href="parameter-estimation-techniques-for-hmms.html#cb13-25" aria-hidden="true" tabindex="-1"></a>  vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> delta <span class="op">=</span> stat_dist<span class="op">(</span>m<span class="op">,</span> gamma<span class="op">);</span></span>
<span id="cb13-26"><a href="parameter-estimation-techniques-for-hmms.html#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If using a non-stationary distribution, use this instead</span></span>
<span id="cb13-27"><a href="parameter-estimation-techniques-for-hmms.html#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">//vector&lt;Type&gt; delta = delta_w2n(m, tdelta);</span></span>
<span id="cb13-28"><a href="parameter-estimation-techniques-for-hmms.html#cb13-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-29"><a href="parameter-estimation-techniques-for-hmms.html#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get number of timesteps (n)</span></span>
<span id="cb13-30"><a href="parameter-estimation-techniques-for-hmms.html#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> x<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb13-31"><a href="parameter-estimation-techniques-for-hmms.html#cb13-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-32"><a href="parameter-estimation-techniques-for-hmms.html#cb13-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Evaluate conditional distribution: Put conditional</span></span>
<span id="cb13-33"><a href="parameter-estimation-techniques-for-hmms.html#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">// probabilities of observed x in n times m matrix</span></span>
<span id="cb13-34"><a href="parameter-estimation-techniques-for-hmms.html#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// (one column for each state, one row for each datapoint):</span></span>
<span id="cb13-35"><a href="parameter-estimation-techniques-for-hmms.html#cb13-35" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> emission_probs<span class="op">(</span>n<span class="op">,</span> m<span class="op">);</span></span>
<span id="cb13-36"><a href="parameter-estimation-techniques-for-hmms.html#cb13-36" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> row1vec<span class="op">(</span><span class="dv">1</span><span class="op">,</span> m<span class="op">);</span></span>
<span id="cb13-37"><a href="parameter-estimation-techniques-for-hmms.html#cb13-37" aria-hidden="true" tabindex="-1"></a>  row1vec<span class="op">.</span>setOnes<span class="op">();</span></span>
<span id="cb13-38"><a href="parameter-estimation-techniques-for-hmms.html#cb13-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb13-39"><a href="parameter-estimation-techniques-for-hmms.html#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>x<span class="op">[</span>i<span class="op">]</span> <span class="op">!=</span> x<span class="op">[</span>i<span class="op">])</span> <span class="op">{</span> <span class="co">// f != f returns true if and only if f is NaN. </span></span>
<span id="cb13-40"><a href="parameter-estimation-techniques-for-hmms.html#cb13-40" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Replace missing values (NA in R, NaN in C++) with 1</span></span>
<span id="cb13-41"><a href="parameter-estimation-techniques-for-hmms.html#cb13-41" aria-hidden="true" tabindex="-1"></a>      emission_probs<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> row1vec<span class="op">;</span></span>
<span id="cb13-42"><a href="parameter-estimation-techniques-for-hmms.html#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-43"><a href="parameter-estimation-techniques-for-hmms.html#cb13-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb13-44"><a href="parameter-estimation-techniques-for-hmms.html#cb13-44" aria-hidden="true" tabindex="-1"></a>      emission_probs<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> dpois<span class="op">(</span>x<span class="op">[</span>i<span class="op">],</span> lambda<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb13-45"><a href="parameter-estimation-techniques-for-hmms.html#cb13-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-46"><a href="parameter-estimation-techniques-for-hmms.html#cb13-46" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-47"><a href="parameter-estimation-techniques-for-hmms.html#cb13-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-48"><a href="parameter-estimation-techniques-for-hmms.html#cb13-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Corresponds to Zucchini&#39;s book page 333</span></span>
<span id="cb13-49"><a href="parameter-estimation-techniques-for-hmms.html#cb13-49" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> foo<span class="op">,</span> P<span class="op">;</span></span>
<span id="cb13-50"><a href="parameter-estimation-techniques-for-hmms.html#cb13-50" aria-hidden="true" tabindex="-1"></a>  Type mllk<span class="op">,</span> sumfoo<span class="op">,</span> lscale<span class="op">;</span></span>
<span id="cb13-51"><a href="parameter-estimation-techniques-for-hmms.html#cb13-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-52"><a href="parameter-estimation-techniques-for-hmms.html#cb13-52" aria-hidden="true" tabindex="-1"></a>  foo <span class="op">=</span> <span class="op">(</span>delta <span class="op">*</span> vector<span class="op">&lt;</span>Type<span class="op">&gt;(</span>emission_probs<span class="op">.</span>row<span class="op">(</span><span class="dv">0</span><span class="op">))).</span>matrix<span class="op">();</span></span>
<span id="cb13-53"><a href="parameter-estimation-techniques-for-hmms.html#cb13-53" aria-hidden="true" tabindex="-1"></a>  sumfoo <span class="op">=</span> foo<span class="op">.</span>sum<span class="op">();</span></span>
<span id="cb13-54"><a href="parameter-estimation-techniques-for-hmms.html#cb13-54" aria-hidden="true" tabindex="-1"></a>  lscale <span class="op">=</span> log<span class="op">(</span>sumfoo<span class="op">);</span></span>
<span id="cb13-55"><a href="parameter-estimation-techniques-for-hmms.html#cb13-55" aria-hidden="true" tabindex="-1"></a>  foo<span class="op">.</span>transposeInPlace<span class="op">();</span></span>
<span id="cb13-56"><a href="parameter-estimation-techniques-for-hmms.html#cb13-56" aria-hidden="true" tabindex="-1"></a>  foo <span class="op">/=</span> sumfoo<span class="op">;</span></span>
<span id="cb13-57"><a href="parameter-estimation-techniques-for-hmms.html#cb13-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">2</span><span class="op">;</span> i <span class="op">&lt;=</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb13-58"><a href="parameter-estimation-techniques-for-hmms.html#cb13-58" aria-hidden="true" tabindex="-1"></a>    P <span class="op">=</span> emission_probs<span class="op">.</span>row<span class="op">(</span>i <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-59"><a href="parameter-estimation-techniques-for-hmms.html#cb13-59" aria-hidden="true" tabindex="-1"></a>    foo <span class="op">=</span> <span class="op">((</span>foo <span class="op">*</span> gamma<span class="op">).</span>array<span class="op">()</span> <span class="op">*</span> P<span class="op">.</span>array<span class="op">()).</span>matrix<span class="op">();</span></span>
<span id="cb13-60"><a href="parameter-estimation-techniques-for-hmms.html#cb13-60" aria-hidden="true" tabindex="-1"></a>    sumfoo <span class="op">=</span> foo<span class="op">.</span>sum<span class="op">();</span></span>
<span id="cb13-61"><a href="parameter-estimation-techniques-for-hmms.html#cb13-61" aria-hidden="true" tabindex="-1"></a>    lscale <span class="op">+=</span> log<span class="op">(</span>sumfoo<span class="op">);</span></span>
<span id="cb13-62"><a href="parameter-estimation-techniques-for-hmms.html#cb13-62" aria-hidden="true" tabindex="-1"></a>    foo <span class="op">/=</span> sumfoo<span class="op">;</span></span>
<span id="cb13-63"><a href="parameter-estimation-techniques-for-hmms.html#cb13-63" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-64"><a href="parameter-estimation-techniques-for-hmms.html#cb13-64" aria-hidden="true" tabindex="-1"></a>  mllk <span class="op">=</span> <span class="op">-</span>lscale<span class="op">;</span></span>
<span id="cb13-65"><a href="parameter-estimation-techniques-for-hmms.html#cb13-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-66"><a href="parameter-estimation-techniques-for-hmms.html#cb13-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use adreport on variables for which we want standard errors</span></span>
<span id="cb13-67"><a href="parameter-estimation-techniques-for-hmms.html#cb13-67" aria-hidden="true" tabindex="-1"></a>  ADREPORT<span class="op">(</span>lambda<span class="op">);</span></span>
<span id="cb13-68"><a href="parameter-estimation-techniques-for-hmms.html#cb13-68" aria-hidden="true" tabindex="-1"></a>  ADREPORT<span class="op">(</span>gamma<span class="op">);</span></span>
<span id="cb13-69"><a href="parameter-estimation-techniques-for-hmms.html#cb13-69" aria-hidden="true" tabindex="-1"></a>  ADREPORT<span class="op">(</span>delta<span class="op">);</span></span>
<span id="cb13-70"><a href="parameter-estimation-techniques-for-hmms.html#cb13-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-71"><a href="parameter-estimation-techniques-for-hmms.html#cb13-71" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Variables we need for local decoding and in a convenient format</span></span>
<span id="cb13-72"><a href="parameter-estimation-techniques-for-hmms.html#cb13-72" aria-hidden="true" tabindex="-1"></a>  REPORT<span class="op">(</span>lambda<span class="op">);</span></span>
<span id="cb13-73"><a href="parameter-estimation-techniques-for-hmms.html#cb13-73" aria-hidden="true" tabindex="-1"></a>  REPORT<span class="op">(</span>gamma<span class="op">);</span></span>
<span id="cb13-74"><a href="parameter-estimation-techniques-for-hmms.html#cb13-74" aria-hidden="true" tabindex="-1"></a>  REPORT<span class="op">(</span>delta<span class="op">);</span></span>
<span id="cb13-75"><a href="parameter-estimation-techniques-for-hmms.html#cb13-75" aria-hidden="true" tabindex="-1"></a>  REPORT<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb13-76"><a href="parameter-estimation-techniques-for-hmms.html#cb13-76" aria-hidden="true" tabindex="-1"></a>  REPORT<span class="op">(</span>emission_probs<span class="op">);</span></span>
<span id="cb13-77"><a href="parameter-estimation-techniques-for-hmms.html#cb13-77" aria-hidden="true" tabindex="-1"></a>  REPORT<span class="op">(</span>mllk<span class="op">);</span></span>
<span id="cb13-78"><a href="parameter-estimation-techniques-for-hmms.html#cb13-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-79"><a href="parameter-estimation-techniques-for-hmms.html#cb13-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> mllk<span class="op">;</span></span>
<span id="cb13-80"><a href="parameter-estimation-techniques-for-hmms.html#cb13-80" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The case where <span class="math inline">\(m = 1\)</span> doesn’t involve a hidden state, and thus is a Poisson regression instead of a Poisson HMM.
Nonetheless, <code>TMB</code> also accelerates its estimation and may be useful to the reader.</p>
</div>
<div id="forward-backward" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Forward algorithm and<br>backward algorithm</h2>
<div id="setup-1" class="section level3" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Setup</h3>
<div id="prepare-the-model" class="section level4" number="3.3.1.1">
<h4><span class="header-section-number">3.3.1.1</span> Prepare the model</h4>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="parameter-estimation-techniques-for-hmms.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TMB)</span>
<span id="cb14-2"><a href="parameter-estimation-techniques-for-hmms.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;functions/utils.R&quot;</span>)</span>
<span id="cb14-3"><a href="parameter-estimation-techniques-for-hmms.html#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;data/fetal-lamb.RData&quot;</span>)</span>
<span id="cb14-4"><a href="parameter-estimation-techniques-for-hmms.html#cb14-4" aria-hidden="true" tabindex="-1"></a>TMB<span class="sc">::</span><span class="fu">compile</span>(<span class="st">&quot;code/poi_hmm.cpp&quot;</span>)</span>
<span id="cb14-5"><a href="parameter-estimation-techniques-for-hmms.html#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dyn.load</span>(<span class="fu">dynlib</span>(<span class="st">&quot;code/poi_hmm&quot;</span>))</span>
<span id="cb14-6"><a href="parameter-estimation-techniques-for-hmms.html#cb14-6" aria-hidden="true" tabindex="-1"></a>lamb_data <span class="ot">&lt;-</span> lamb</span>
<span id="cb14-7"><a href="parameter-estimation-techniques-for-hmms.html#cb14-7" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb14-8"><a href="parameter-estimation-techniques-for-hmms.html#cb14-8" aria-hidden="true" tabindex="-1"></a>TMB_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> lamb_data, <span class="at">m =</span> m)</span>
<span id="cb14-9"><a href="parameter-estimation-techniques-for-hmms.html#cb14-9" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb14-10"><a href="parameter-estimation-techniques-for-hmms.html#cb14-10" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>,</span>
<span id="cb14-11"><a href="parameter-estimation-techniques-for-hmms.html#cb14-11" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> m)</span>
<span id="cb14-12"><a href="parameter-estimation-techniques-for-hmms.html#cb14-12" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">pois.HMM.pn2pw</span>(m, lambda, gamma)</span>
<span id="cb14-13"><a href="parameter-estimation-techniques-for-hmms.html#cb14-13" aria-hidden="true" tabindex="-1"></a>obj_tmb <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(TMB_data, parameters,</span>
<span id="cb14-14"><a href="parameter-estimation-techniques-for-hmms.html#cb14-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">DLL =</span> <span class="st">&quot;poi_hmm&quot;</span>, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-15"><a href="parameter-estimation-techniques-for-hmms.html#cb14-15" aria-hidden="true" tabindex="-1"></a>mod_tmb <span class="ot">&lt;-</span> <span class="fu">nlminb</span>(<span class="at">start =</span> obj_tmb<span class="sc">$</span>par, <span class="at">objective =</span> obj_tmb<span class="sc">$</span>fn,</span>
<span id="cb14-16"><a href="parameter-estimation-techniques-for-hmms.html#cb14-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">gradient =</span> obj_tmb<span class="sc">$</span>gr, <span class="at">hessian =</span> obj_tmb<span class="sc">$</span>he)</span></code></pre></div>
</div>
<div id="define-variables" class="section level4" number="3.3.1.2">
<h4><span class="header-section-number">3.3.1.2</span> Define variables</h4>
<p>Given an optimized <code>MakeADFun</code> object <code>obj</code>, we need to setup some variables to compute the probabilities detailed below.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="parameter-estimation-techniques-for-hmms.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve the objects at ML value</span></span>
<span id="cb15-2"><a href="parameter-estimation-techniques-for-hmms.html#cb15-2" aria-hidden="true" tabindex="-1"></a>adrep <span class="ot">&lt;-</span> obj_tmb<span class="sc">$</span><span class="fu">report</span>(obj_tmb<span class="sc">$</span>env<span class="sc">$</span>last.par.best)</span>
<span id="cb15-3"><a href="parameter-estimation-techniques-for-hmms.html#cb15-3" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> adrep<span class="sc">$</span>delta</span>
<span id="cb15-4"><a href="parameter-estimation-techniques-for-hmms.html#cb15-4" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> adrep<span class="sc">$</span>gamma</span>
<span id="cb15-5"><a href="parameter-estimation-techniques-for-hmms.html#cb15-5" aria-hidden="true" tabindex="-1"></a>emission_probs <span class="ot">&lt;-</span> adrep<span class="sc">$</span>emission_probs</span>
<span id="cb15-6"><a href="parameter-estimation-techniques-for-hmms.html#cb15-6" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> adrep<span class="sc">$</span>n</span>
<span id="cb15-7"><a href="parameter-estimation-techniques-for-hmms.html#cb15-7" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">length</span>(delta)</span>
<span id="cb15-8"><a href="parameter-estimation-techniques-for-hmms.html#cb15-8" aria-hidden="true" tabindex="-1"></a>mllk <span class="ot">&lt;-</span> adrep<span class="sc">$</span>mllk</span></code></pre></div>
<p>Note that <span class="math inline">\({\boldsymbol\lambda}\)</span> is not needed as we already have access to the emission probabilities.</p>
</div>
<div id="emissionoutput-probabilities" class="section level4" number="3.3.1.3">
<h4><span class="header-section-number">3.3.1.3</span> Emission/output probabilities</h4>
<p>Emission probabilities (also called output probabilities) are the conditional probabilities of the data given a state.</p>
<p>Using the notation in the article Section 3.1, emission probabilities are the conditional distributions <span class="math inline">\(p_i(x) = \text{P}(X_t = x \vert C_t = i) = \frac{e^{-\lambda_i} \lambda_i^x}{x!}\)</span>.
We store all these in a data frame where each row and column represent a data and a state respectively.</p>
<p>More formally, we call
<span class="math inline">\(\begin{pmatrix} p_1(x_1) &amp; p_2(x_1) &amp; \ldots &amp; p_m(x_1)\\ p_1(x_2) &amp; p_2(x_2) &amp; \ldots &amp; p_m(x_2)\\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots\\ p_1(x_n) &amp; p_2(x_n) &amp; \ldots &amp; p_m(x_n)\\ \end{pmatrix}\)</span>
the emission probability matrix.</p>
<p>We compute these probabilities in <code>C++</code> rather than in <code>R</code> because it is faster and not more complicated to write</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="parameter-estimation-techniques-for-hmms.html#cb16-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Evaluate conditional distribution: Put conditional</span></span>
<span id="cb16-2"><a href="parameter-estimation-techniques-for-hmms.html#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// probabilities of observed x in n times m matrix</span></span>
<span id="cb16-3"><a href="parameter-estimation-techniques-for-hmms.html#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// (one column for each state, one row for each datapoint):</span></span>
<span id="cb16-4"><a href="parameter-estimation-techniques-for-hmms.html#cb16-4" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> emission_probs<span class="op">(</span>n<span class="op">,</span> m<span class="op">);</span></span>
<span id="cb16-5"><a href="parameter-estimation-techniques-for-hmms.html#cb16-5" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> row1vec<span class="op">(</span><span class="dv">1</span><span class="op">,</span> m<span class="op">);</span></span>
<span id="cb16-6"><a href="parameter-estimation-techniques-for-hmms.html#cb16-6" aria-hidden="true" tabindex="-1"></a>  row1vec<span class="op">.</span>setOnes<span class="op">();</span></span>
<span id="cb16-7"><a href="parameter-estimation-techniques-for-hmms.html#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb16-8"><a href="parameter-estimation-techniques-for-hmms.html#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>x<span class="op">[</span>i<span class="op">]</span> <span class="op">!=</span> x<span class="op">[</span>i<span class="op">])</span> <span class="op">{</span> <span class="co">// f != f returns true if and only if f is NaN. </span></span>
<span id="cb16-9"><a href="parameter-estimation-techniques-for-hmms.html#cb16-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Replace missing values (NA in R, NaN in C++) with 1</span></span>
<span id="cb16-10"><a href="parameter-estimation-techniques-for-hmms.html#cb16-10" aria-hidden="true" tabindex="-1"></a>      emission_probs<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> row1vec<span class="op">;</span></span>
<span id="cb16-11"><a href="parameter-estimation-techniques-for-hmms.html#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-12"><a href="parameter-estimation-techniques-for-hmms.html#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb16-13"><a href="parameter-estimation-techniques-for-hmms.html#cb16-13" aria-hidden="true" tabindex="-1"></a>      emission_probs<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> dpois<span class="op">(</span>x<span class="op">[</span>i<span class="op">],</span> lambda<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb16-14"><a href="parameter-estimation-techniques-for-hmms.html#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-15"><a href="parameter-estimation-techniques-for-hmms.html#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>Nevertheless, we also need to compute them in <code>R</code> to <a href="using-tmb.html#forecast">Forecast</a></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="parameter-estimation-techniques-for-hmms.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate emission probabilities</span></span>
<span id="cb17-2"><a href="parameter-estimation-techniques-for-hmms.html#cb17-2" aria-hidden="true" tabindex="-1"></a>get.emission.probs <span class="ot">&lt;-</span> <span class="cf">function</span>(data, lambda) {</span>
<span id="cb17-3"><a href="parameter-estimation-techniques-for-hmms.html#cb17-3" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(data)</span>
<span id="cb17-4"><a href="parameter-estimation-techniques-for-hmms.html#cb17-4" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">length</span>(lambda)</span>
<span id="cb17-5"><a href="parameter-estimation-techniques-for-hmms.html#cb17-5" aria-hidden="true" tabindex="-1"></a>  emission_probs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> n, <span class="at">ncol =</span> m)</span>
<span id="cb17-6"><a href="parameter-estimation-techniques-for-hmms.html#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb17-7"><a href="parameter-estimation-techniques-for-hmms.html#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(data[i])) {</span>
<span id="cb17-8"><a href="parameter-estimation-techniques-for-hmms.html#cb17-8" aria-hidden="true" tabindex="-1"></a>      emission_probs[i, ] <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, m)</span>
<span id="cb17-9"><a href="parameter-estimation-techniques-for-hmms.html#cb17-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb17-10"><a href="parameter-estimation-techniques-for-hmms.html#cb17-10" aria-hidden="true" tabindex="-1"></a>      emission_probs[i, ] <span class="ot">&lt;-</span> <span class="fu">dpois</span>(data[i], lambda)</span>
<span id="cb17-11"><a href="parameter-estimation-techniques-for-hmms.html#cb17-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-12"><a href="parameter-estimation-techniques-for-hmms.html#cb17-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-13"><a href="parameter-estimation-techniques-for-hmms.html#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(emission_probs)</span>
<span id="cb17-14"><a href="parameter-estimation-techniques-for-hmms.html#cb17-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="log-forward" class="section level3" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> Log-forward probabilities</h3>
<p>We show here a way to compute the log of the forward probabilities, using a scaling scheme defined by <span class="citation"><a href="references.html#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, and Langrock</a> (<a href="references.html#ref-zucchini" role="doc-biblioref">2016, 66</a> and p.334)</span>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="parameter-estimation-techniques-for-hmms.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute log-forward probabilities (scaling used)</span></span>
<span id="cb18-2"><a href="parameter-estimation-techniques-for-hmms.html#cb18-2" aria-hidden="true" tabindex="-1"></a>lalpha <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, m, n)</span>
<span id="cb18-3"><a href="parameter-estimation-techniques-for-hmms.html#cb18-3" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> delta <span class="sc">*</span> emission_probs[<span class="dv">1</span>, ]</span>
<span id="cb18-4"><a href="parameter-estimation-techniques-for-hmms.html#cb18-4" aria-hidden="true" tabindex="-1"></a>sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb18-5"><a href="parameter-estimation-techniques-for-hmms.html#cb18-5" aria-hidden="true" tabindex="-1"></a>lscale <span class="ot">&lt;-</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb18-6"><a href="parameter-estimation-techniques-for-hmms.html#cb18-6" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> foo <span class="sc">/</span> sumfoo</span>
<span id="cb18-7"><a href="parameter-estimation-techniques-for-hmms.html#cb18-7" aria-hidden="true" tabindex="-1"></a>lalpha[, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">log</span>(foo) <span class="sc">+</span> lscale</span>
<span id="cb18-8"><a href="parameter-estimation-techniques-for-hmms.html#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n) {</span>
<span id="cb18-9"><a href="parameter-estimation-techniques-for-hmms.html#cb18-9" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> foo <span class="sc">%*%</span> gamma <span class="sc">*</span> emission_probs[i, ]</span>
<span id="cb18-10"><a href="parameter-estimation-techniques-for-hmms.html#cb18-10" aria-hidden="true" tabindex="-1"></a>  sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb18-11"><a href="parameter-estimation-techniques-for-hmms.html#cb18-11" aria-hidden="true" tabindex="-1"></a>  lscale <span class="ot">&lt;-</span> lscale <span class="sc">+</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb18-12"><a href="parameter-estimation-techniques-for-hmms.html#cb18-12" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> foo <span class="sc">/</span> sumfoo</span>
<span id="cb18-13"><a href="parameter-estimation-techniques-for-hmms.html#cb18-13" aria-hidden="true" tabindex="-1"></a>  lalpha[, i] <span class="ot">&lt;-</span> <span class="fu">log</span>(foo) <span class="sc">+</span> lscale</span>
<span id="cb18-14"><a href="parameter-estimation-techniques-for-hmms.html#cb18-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-15"><a href="parameter-estimation-techniques-for-hmms.html#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co"># lalpha contains n=240 columns, so we only display 5 for readability</span></span>
<span id="cb18-16"><a href="parameter-estimation-techniques-for-hmms.html#cb18-16" aria-hidden="true" tabindex="-1"></a>lalpha[, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb18-17"><a href="parameter-estimation-techniques-for-hmms.html#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="do">##            [,1]       [,2]       [,3]      [,4]      [,5]</span></span>
<span id="cb18-18"><a href="parameter-estimation-techniques-for-hmms.html#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="do">## [1,] -0.2920639 -0.5591179 -0.8265948 -1.094088 -1.361583</span></span>
<span id="cb18-19"><a href="parameter-estimation-techniques-for-hmms.html#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="do">## [2,] -6.4651986 -7.7716769 -8.1146145 -8.385232 -8.652850</span></span></code></pre></div>
</div>
<div id="log-backward" class="section level3" number="3.3.3">
<h3><span class="header-section-number">3.3.3</span> Log-backward probabilities</h3>
<p>We show here a way to compute the log of the backward probabilities with a scaling scheme defined by <span class="citation"><a href="references.html#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, and Langrock</a> (<a href="references.html#ref-zucchini" role="doc-biblioref">2016, 67</a> and p.334)</span>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="parameter-estimation-techniques-for-hmms.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute log-backwards probabilities (scaling used)</span></span>
<span id="cb19-2"><a href="parameter-estimation-techniques-for-hmms.html#cb19-2" aria-hidden="true" tabindex="-1"></a>lbeta <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, m, n)</span>
<span id="cb19-3"><a href="parameter-estimation-techniques-for-hmms.html#cb19-3" aria-hidden="true" tabindex="-1"></a>lbeta[, n] <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, m)</span>
<span id="cb19-4"><a href="parameter-estimation-techniques-for-hmms.html#cb19-4" aria-hidden="true" tabindex="-1"></a>foo <span class="ot">&lt;-</span> <span class="fu">rep</span> (<span class="dv">1</span> <span class="sc">/</span> m, m)</span>
<span id="cb19-5"><a href="parameter-estimation-techniques-for-hmms.html#cb19-5" aria-hidden="true" tabindex="-1"></a>lscale <span class="ot">&lt;-</span> <span class="fu">log</span>(m)</span>
<span id="cb19-6"><a href="parameter-estimation-techniques-for-hmms.html#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> (n <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">:</span><span class="dv">1</span>) {</span>
<span id="cb19-7"><a href="parameter-estimation-techniques-for-hmms.html#cb19-7" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> gamma <span class="sc">%*%</span> (emission_probs[i <span class="sc">+</span> <span class="dv">1</span>, ] <span class="sc">*</span> foo)</span>
<span id="cb19-8"><a href="parameter-estimation-techniques-for-hmms.html#cb19-8" aria-hidden="true" tabindex="-1"></a>  lbeta[, i] <span class="ot">&lt;-</span> <span class="fu">log</span>(foo) <span class="sc">+</span> lscale</span>
<span id="cb19-9"><a href="parameter-estimation-techniques-for-hmms.html#cb19-9" aria-hidden="true" tabindex="-1"></a>  sumfoo <span class="ot">&lt;-</span> <span class="fu">sum</span>(foo)</span>
<span id="cb19-10"><a href="parameter-estimation-techniques-for-hmms.html#cb19-10" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> foo <span class="sc">/</span> sumfoo</span>
<span id="cb19-11"><a href="parameter-estimation-techniques-for-hmms.html#cb19-11" aria-hidden="true" tabindex="-1"></a>  lscale <span class="ot">&lt;-</span> lscale <span class="sc">+</span> <span class="fu">log</span>(sumfoo)</span>
<span id="cb19-12"><a href="parameter-estimation-techniques-for-hmms.html#cb19-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-13"><a href="parameter-estimation-techniques-for-hmms.html#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co"># lbeta contains n=240 columns, so we only display 4 for readability</span></span>
<span id="cb19-14"><a href="parameter-estimation-techniques-for-hmms.html#cb19-14" aria-hidden="true" tabindex="-1"></a>lbeta[, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb19-15"><a href="parameter-estimation-techniques-for-hmms.html#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="do">##           [,1]      [,2]      [,3]      [,4]</span></span>
<span id="cb19-16"><a href="parameter-estimation-techniques-for-hmms.html#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [1,] -177.2275 -176.9600 -176.6925 -176.4250</span></span>
<span id="cb19-17"><a href="parameter-estimation-techniques-for-hmms.html#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="do">## [2,] -178.3456 -178.0781 -177.8099 -177.5253</span></span></code></pre></div>
<p>We refer to the Section <a href="using-tmb.html#state-inference">State Inference</a> for an application of this code for state inference and forecasting.</p>
</div>
</div>
<div id="reparameterization-of-the-likelihood-function" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> Reparameterization of the<br>likelihood function</h2>
<div id="utility-functions-in-tmb" class="section level3" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> Utility functions in <code>TMB</code></h3>
<p>Defining the negative log-likelihood function requires transforming the working parameters into their natural form.
We define the function <code>gamma.w2n</code> to perform this transformation.</p>
<p>The function <code>stat.dist</code> handles computing the stationary distribution, while <code>delta.w2n</code> can be used if a non-stationary distribution is provided.</p>
<p>They are defined in <em><a href="functions/utils.cpp">functions/utils.cpp</a></em></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="parameter-estimation-techniques-for-hmms.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Function transforming working parameters in initial distribution</span></span>
<span id="cb20-2"><a href="parameter-estimation-techniques-for-hmms.html#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">// to natural parameters</span></span>
<span id="cb20-3"><a href="parameter-estimation-techniques-for-hmms.html#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">class</span> Type<span class="op">&gt;</span></span>
<span id="cb20-4"><a href="parameter-estimation-techniques-for-hmms.html#cb20-4" aria-hidden="true" tabindex="-1"></a>vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> delta_w2n<span class="op">(</span><span class="dt">int</span> m<span class="op">,</span> vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> tdelta<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-5"><a href="parameter-estimation-techniques-for-hmms.html#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="parameter-estimation-techniques-for-hmms.html#cb20-6" aria-hidden="true" tabindex="-1"></a>  vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> delta<span class="op">(</span>m<span class="op">);</span></span>
<span id="cb20-7"><a href="parameter-estimation-techniques-for-hmms.html#cb20-7" aria-hidden="true" tabindex="-1"></a>  vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> foo<span class="op">(</span>m<span class="op">);</span></span>
<span id="cb20-8"><a href="parameter-estimation-techniques-for-hmms.html#cb20-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-9"><a href="parameter-estimation-techniques-for-hmms.html#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>m <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb20-10"><a href="parameter-estimation-techniques-for-hmms.html#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Type<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb20-11"><a href="parameter-estimation-techniques-for-hmms.html#cb20-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-12"><a href="parameter-estimation-techniques-for-hmms.html#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// set first element to one.</span></span>
<span id="cb20-13"><a href="parameter-estimation-techniques-for-hmms.html#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fill in the last m - 1 elements with working parameters</span></span>
<span id="cb20-14"><a href="parameter-estimation-techniques-for-hmms.html#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// and take exponential</span></span>
<span id="cb20-15"><a href="parameter-estimation-techniques-for-hmms.html#cb20-15" aria-hidden="true" tabindex="-1"></a>  foo <span class="op">&lt;&lt;</span> Type<span class="op">(</span><span class="dv">1</span><span class="op">),</span> tdelta<span class="op">.</span>exp<span class="op">();</span></span>
<span id="cb20-16"><a href="parameter-estimation-techniques-for-hmms.html#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="parameter-estimation-techniques-for-hmms.html#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// normalize</span></span>
<span id="cb20-18"><a href="parameter-estimation-techniques-for-hmms.html#cb20-18" aria-hidden="true" tabindex="-1"></a>  delta <span class="op">=</span> foo <span class="op">/</span> foo<span class="op">.</span>sum<span class="op">();</span></span>
<span id="cb20-19"><a href="parameter-estimation-techniques-for-hmms.html#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="parameter-estimation-techniques-for-hmms.html#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> delta<span class="op">;</span></span>
<span id="cb20-21"><a href="parameter-estimation-techniques-for-hmms.html#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-22"><a href="parameter-estimation-techniques-for-hmms.html#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="parameter-estimation-techniques-for-hmms.html#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Function transforming the working parameters in TPM to</span></span>
<span id="cb20-24"><a href="parameter-estimation-techniques-for-hmms.html#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co">// natural parameters (w2n)</span></span>
<span id="cb20-25"><a href="parameter-estimation-techniques-for-hmms.html#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">class</span> Type<span class="op">&gt;</span></span>
<span id="cb20-26"><a href="parameter-estimation-techniques-for-hmms.html#cb20-26" aria-hidden="true" tabindex="-1"></a>matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> gamma_w2n<span class="op">(</span><span class="dt">int</span> m<span class="op">,</span> vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> tgamma<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-27"><a href="parameter-estimation-techniques-for-hmms.html#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="parameter-estimation-techniques-for-hmms.html#cb20-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct m x m identity matrix</span></span>
<span id="cb20-29"><a href="parameter-estimation-techniques-for-hmms.html#cb20-29" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> gamma<span class="op">(</span>m<span class="op">,</span> m<span class="op">);</span></span>
<span id="cb20-30"><a href="parameter-estimation-techniques-for-hmms.html#cb20-30" aria-hidden="true" tabindex="-1"></a>  gamma<span class="op">.</span>setIdentity<span class="op">();</span></span>
<span id="cb20-31"><a href="parameter-estimation-techniques-for-hmms.html#cb20-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-32"><a href="parameter-estimation-techniques-for-hmms.html#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>m <span class="op">==</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb20-33"><a href="parameter-estimation-techniques-for-hmms.html#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gamma<span class="op">;</span></span>
<span id="cb20-34"><a href="parameter-estimation-techniques-for-hmms.html#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="parameter-estimation-techniques-for-hmms.html#cb20-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fill offdiagonal elements with working parameters column-wise:</span></span>
<span id="cb20-36"><a href="parameter-estimation-techniques-for-hmms.html#cb20-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb20-37"><a href="parameter-estimation-techniques-for-hmms.html#cb20-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> m<span class="op">;</span> i<span class="op">++){</span></span>
<span id="cb20-38"><a href="parameter-estimation-techniques-for-hmms.html#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> m<span class="op">;</span> j<span class="op">++){</span></span>
<span id="cb20-39"><a href="parameter-estimation-techniques-for-hmms.html#cb20-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>j <span class="op">!=</span> i<span class="op">){</span></span>
<span id="cb20-40"><a href="parameter-estimation-techniques-for-hmms.html#cb20-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fill gamma according to mapping and take exponential</span></span>
<span id="cb20-41"><a href="parameter-estimation-techniques-for-hmms.html#cb20-41" aria-hidden="true" tabindex="-1"></a>        gamma<span class="op">(</span>j<span class="op">,</span> i<span class="op">)</span> <span class="op">=</span> tgamma<span class="op">.</span>exp<span class="op">()(</span>idx<span class="op">);</span></span>
<span id="cb20-42"><a href="parameter-estimation-techniques-for-hmms.html#cb20-42" aria-hidden="true" tabindex="-1"></a>        idx<span class="op">++;</span></span>
<span id="cb20-43"><a href="parameter-estimation-techniques-for-hmms.html#cb20-43" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb20-44"><a href="parameter-estimation-techniques-for-hmms.html#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-45"><a href="parameter-estimation-techniques-for-hmms.html#cb20-45" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb20-46"><a href="parameter-estimation-techniques-for-hmms.html#cb20-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Normalize each row:</span></span>
<span id="cb20-47"><a href="parameter-estimation-techniques-for-hmms.html#cb20-47" aria-hidden="true" tabindex="-1"></a>  vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> cs <span class="op">=</span> gamma<span class="op">.</span>rowwise<span class="op">().</span>sum<span class="op">();</span></span>
<span id="cb20-48"><a href="parameter-estimation-techniques-for-hmms.html#cb20-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> m<span class="op">;</span> i<span class="op">++)</span> gamma<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">/=</span> cs<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb20-49"><a href="parameter-estimation-techniques-for-hmms.html#cb20-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-50"><a href="parameter-estimation-techniques-for-hmms.html#cb20-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> gamma<span class="op">;</span></span>
<span id="cb20-51"><a href="parameter-estimation-techniques-for-hmms.html#cb20-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-52"><a href="parameter-estimation-techniques-for-hmms.html#cb20-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-53"><a href="parameter-estimation-techniques-for-hmms.html#cb20-53" aria-hidden="true" tabindex="-1"></a><span class="co">// Function computing the stationary distribution of a Markov chain</span></span>
<span id="cb20-54"><a href="parameter-estimation-techniques-for-hmms.html#cb20-54" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">class</span> Type<span class="op">&gt;</span></span>
<span id="cb20-55"><a href="parameter-estimation-techniques-for-hmms.html#cb20-55" aria-hidden="true" tabindex="-1"></a>vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> stat_dist<span class="op">(</span><span class="dt">int</span> m<span class="op">,</span> matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> gamma<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-56"><a href="parameter-estimation-techniques-for-hmms.html#cb20-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-57"><a href="parameter-estimation-techniques-for-hmms.html#cb20-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct stationary distribution</span></span>
<span id="cb20-58"><a href="parameter-estimation-techniques-for-hmms.html#cb20-58" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> I<span class="op">(</span>m<span class="op">,</span> m<span class="op">);</span></span>
<span id="cb20-59"><a href="parameter-estimation-techniques-for-hmms.html#cb20-59" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> U<span class="op">(</span>m<span class="op">,</span> m<span class="op">);</span></span>
<span id="cb20-60"><a href="parameter-estimation-techniques-for-hmms.html#cb20-60" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> row1vec<span class="op">(</span><span class="dv">1</span><span class="op">,</span> m<span class="op">);</span></span>
<span id="cb20-61"><a href="parameter-estimation-techniques-for-hmms.html#cb20-61" aria-hidden="true" tabindex="-1"></a>  U <span class="op">=</span> U<span class="op">.</span>setOnes<span class="op">();</span></span>
<span id="cb20-62"><a href="parameter-estimation-techniques-for-hmms.html#cb20-62" aria-hidden="true" tabindex="-1"></a>  I <span class="op">=</span> I<span class="op">.</span>setIdentity<span class="op">();</span></span>
<span id="cb20-63"><a href="parameter-estimation-techniques-for-hmms.html#cb20-63" aria-hidden="true" tabindex="-1"></a>  row1vec<span class="op">.</span>setOnes<span class="op">();</span></span>
<span id="cb20-64"><a href="parameter-estimation-techniques-for-hmms.html#cb20-64" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> A <span class="op">=</span>  I <span class="op">-</span> gamma <span class="op">+</span> U<span class="op">;</span></span>
<span id="cb20-65"><a href="parameter-estimation-techniques-for-hmms.html#cb20-65" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> Ainv <span class="op">=</span> A<span class="op">.</span>inverse<span class="op">();</span></span>
<span id="cb20-66"><a href="parameter-estimation-techniques-for-hmms.html#cb20-66" aria-hidden="true" tabindex="-1"></a>  matrix<span class="op">&lt;</span>Type<span class="op">&gt;</span> deltamat <span class="op">=</span> row1vec <span class="op">*</span> Ainv<span class="op">;</span></span>
<span id="cb20-67"><a href="parameter-estimation-techniques-for-hmms.html#cb20-67" aria-hidden="true" tabindex="-1"></a>  vector<span class="op">&lt;</span>Type<span class="op">&gt;</span> delta <span class="op">=</span> deltamat<span class="op">.</span>row<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb20-68"><a href="parameter-estimation-techniques-for-hmms.html#cb20-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-69"><a href="parameter-estimation-techniques-for-hmms.html#cb20-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> delta<span class="op">;</span></span>
<span id="cb20-70"><a href="parameter-estimation-techniques-for-hmms.html#cb20-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Transforming the Poisson means into their natural form can be done simply with the <code>exp</code> function and doesn’t require a dedicated function.</p>
</div>
<div id="utility-functions-in-r" class="section level3" number="3.4.2">
<h3><span class="header-section-number">3.4.2</span> Utility functions in <code>R</code></h3>
<p>While <code>TMB</code> requires functions to transform working parameters to their natural form, pre-processing in <code>R</code> requires the inverse transformation.</p>
<p>Functions to achieve this are available in <span class="citation"><a href="references.html#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, and Langrock</a> (<a href="references.html#ref-zucchini" role="doc-biblioref">2016, 51</a>)</span> and are displayed here with explaining comments for convenience.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="parameter-estimation-techniques-for-hmms.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform Poisson natural parameters to working parameters</span></span>
<span id="cb21-2"><a href="parameter-estimation-techniques-for-hmms.html#cb21-2" aria-hidden="true" tabindex="-1"></a>pois.HMM.pn2pw <span class="ot">&lt;-</span> <span class="cf">function</span>(m, lambda, gamma, <span class="at">delta =</span> <span class="cn">NULL</span>,</span>
<span id="cb21-3"><a href="parameter-estimation-techniques-for-hmms.html#cb21-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">stationary =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb21-4"><a href="parameter-estimation-techniques-for-hmms.html#cb21-4" aria-hidden="true" tabindex="-1"></a>  tlambda <span class="ot">&lt;-</span> <span class="fu">log</span>(lambda)</span>
<span id="cb21-5"><a href="parameter-estimation-techniques-for-hmms.html#cb21-5" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> <span class="fu">log</span>(gamma <span class="sc">/</span> <span class="fu">diag</span>(gamma))</span>
<span id="cb21-6"><a href="parameter-estimation-techniques-for-hmms.html#cb21-6" aria-hidden="true" tabindex="-1"></a>  tgamma <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(foo[<span class="sc">!</span><span class="fu">diag</span>(m)])</span>
<span id="cb21-7"><a href="parameter-estimation-techniques-for-hmms.html#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (stationary) {</span>
<span id="cb21-8"><a href="parameter-estimation-techniques-for-hmms.html#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If tdelta is set to NULL and returned in the list,</span></span>
<span id="cb21-9"><a href="parameter-estimation-techniques-for-hmms.html#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it will cause issues when optimizing with TMB</span></span>
<span id="cb21-10"><a href="parameter-estimation-techniques-for-hmms.html#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">tlambda =</span> tlambda, <span class="at">tgamma =</span> tgamma))</span>
<span id="cb21-11"><a href="parameter-estimation-techniques-for-hmms.html#cb21-11" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb21-12"><a href="parameter-estimation-techniques-for-hmms.html#cb21-12" aria-hidden="true" tabindex="-1"></a>    tdelta <span class="ot">&lt;-</span> <span class="fu">log</span>(delta[<span class="sc">-</span> <span class="dv">1</span>] <span class="sc">/</span> delta[<span class="dv">1</span>])</span>
<span id="cb21-13"><a href="parameter-estimation-techniques-for-hmms.html#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TMB requires a list</span></span>
<span id="cb21-14"><a href="parameter-estimation-techniques-for-hmms.html#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">tlambda =</span> tlambda, <span class="at">tgamma =</span> tgamma, <span class="at">tdelta =</span> tdelta))</span>
<span id="cb21-15"><a href="parameter-estimation-techniques-for-hmms.html#cb21-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-16"><a href="parameter-estimation-techniques-for-hmms.html#cb21-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This can be broken down into sub-functions if necessary. For the <span class="math inline">\({\boldsymbol\Gamma}\)</span> part, we introduce <code>gamma.n2w</code> below.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="parameter-estimation-techniques-for-hmms.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to transform natural parameters to working ones</span></span>
<span id="cb22-2"><a href="parameter-estimation-techniques-for-hmms.html#cb22-2" aria-hidden="true" tabindex="-1"></a>gamma.n2w <span class="ot">&lt;-</span> <span class="cf">function</span>(m, gamma) {</span>
<span id="cb22-3"><a href="parameter-estimation-techniques-for-hmms.html#cb22-3" aria-hidden="true" tabindex="-1"></a>  foo <span class="ot">&lt;-</span> <span class="fu">log</span>(gamma <span class="sc">/</span> <span class="fu">diag</span>(gamma))</span>
<span id="cb22-4"><a href="parameter-estimation-techniques-for-hmms.html#cb22-4" aria-hidden="true" tabindex="-1"></a>  tgamma <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(foo[<span class="sc">!</span><span class="fu">diag</span>(m)])</span>
<span id="cb22-5"><a href="parameter-estimation-techniques-for-hmms.html#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tgamma)</span>
<span id="cb22-6"><a href="parameter-estimation-techniques-for-hmms.html#cb22-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In the case where a non-stationary distribution is specified, transforming <span class="math inline">\({\boldsymbol\delta}\)</span> is necessary. For this we use the <code>delta.n2w</code> function.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="parameter-estimation-techniques-for-hmms.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to transform natural parameters to working ones</span></span>
<span id="cb23-2"><a href="parameter-estimation-techniques-for-hmms.html#cb23-2" aria-hidden="true" tabindex="-1"></a>delta.n2w <span class="ot">&lt;-</span> <span class="cf">function</span>(m, delta) {</span>
<span id="cb23-3"><a href="parameter-estimation-techniques-for-hmms.html#cb23-3" aria-hidden="true" tabindex="-1"></a>  tdelta <span class="ot">&lt;-</span> <span class="fu">log</span>(delta[<span class="sc">-</span> <span class="dv">1</span>] <span class="sc">/</span> delta[<span class="dv">1</span>])</span>
<span id="cb23-4"><a href="parameter-estimation-techniques-for-hmms.html#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tdelta) </span>
<span id="cb23-5"><a href="parameter-estimation-techniques-for-hmms.html#cb23-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>When assuming a stationary distribution, computing it can be done via the following <code>stat.dist</code> function.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="parameter-estimation-techniques-for-hmms.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the stationary distribution of a Markov chain</span></span>
<span id="cb24-2"><a href="parameter-estimation-techniques-for-hmms.html#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with transition probability gamma</span></span>
<span id="cb24-3"><a href="parameter-estimation-techniques-for-hmms.html#cb24-3" aria-hidden="true" tabindex="-1"></a>stat.dist <span class="ot">&lt;-</span> <span class="cf">function</span>(gamma) {</span>
<span id="cb24-4"><a href="parameter-estimation-techniques-for-hmms.html#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The code from Zucchini can crash when dealing with computationally small numbers.</span></span>
<span id="cb24-5"><a href="parameter-estimation-techniques-for-hmms.html#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is likely an approximation error.</span></span>
<span id="cb24-6"><a href="parameter-estimation-techniques-for-hmms.html#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For some reason, the result may be a complex number with imaginary part equal to 0.</span></span>
<span id="cb24-7"><a href="parameter-estimation-techniques-for-hmms.html#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We can just ignore the imaginary part because the eigenvectors of a real eigenvalue must be real.</span></span>
<span id="cb24-8"><a href="parameter-estimation-techniques-for-hmms.html#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># In the cases where it happened, solve(t(diag(m) - gamma + 1), rep(1, m)) produced the same result without the imaginary part.</span></span>
<span id="cb24-9"><a href="parameter-estimation-techniques-for-hmms.html#cb24-9" aria-hidden="true" tabindex="-1"></a>  first_eigen_row <span class="ot">&lt;-</span> <span class="fu">Re</span>(<span class="fu">eigen</span>(<span class="fu">t</span>(gamma))<span class="sc">$</span>vectors[, <span class="dv">1</span>])</span>
<span id="cb24-10"><a href="parameter-estimation-techniques-for-hmms.html#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(first_eigen_row <span class="sc">/</span> <span class="fu">sum</span>(first_eigen_row))</span>
<span id="cb24-11"><a href="parameter-estimation-techniques-for-hmms.html#cb24-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><span class="citation"><a href="references.html#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, and Langrock</a> (<a href="references.html#ref-zucchini" role="doc-biblioref">2016, 51</a>)</span> shows that calculating the stationary distribution can be achieved by solving the equation below for <span class="math inline">\({\boldsymbol\delta}\)</span>, where <span class="math inline">\({\boldsymbol I}_m\)</span> is the <span class="math inline">\(m*m\)</span> identity matrix, <span class="math inline">\({\boldsymbol U}\)</span> is a <span class="math inline">\(m*m\)</span> matrix of ones, and <span class="math inline">\({\boldsymbol 1}\)</span> is a row vector of ones.
<span class="math display">\[
{\boldsymbol\delta}({\boldsymbol I}_m - {\boldsymbol\Gamma} + {\boldsymbol U}) = {\boldsymbol 1}
\]</span></p>
<div id="label-switching" class="section level4" number="3.4.2.1">
<h4><span class="header-section-number">3.4.2.1</span> Label switching</h4>
<p>As the model gets estimated each time, no order is imposed on the states by default.
If one needs to aggregate estimates, this can lead to the label switching problem, where states aren’t ordered the same way in each model and are grouped incorrectly.
The issue can be relevant when comparing results of different optimizers, initial parameters, or classes of models.</p>
<p>To address this, we reorder the states by ascending Poisson means after estimation.
Sorting the means is direct, however re-ordering the TPM is not as straightforward.
To do so, we take the permutations of the states given by the sorted Poisson means, and permute each row index and column index to its new value.
The function <code>pois.HMM.label.order</code> solves the issue and is presented below.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="parameter-estimation-techniques-for-hmms.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Relabel states by increasing Poisson means</span></span>
<span id="cb25-2"><a href="parameter-estimation-techniques-for-hmms.html#cb25-2" aria-hidden="true" tabindex="-1"></a>pois.HMM.label.order <span class="ot">&lt;-</span> <span class="cf">function</span>(m,</span>
<span id="cb25-3"><a href="parameter-estimation-techniques-for-hmms.html#cb25-3" aria-hidden="true" tabindex="-1"></a>                                 lambda,</span>
<span id="cb25-4"><a href="parameter-estimation-techniques-for-hmms.html#cb25-4" aria-hidden="true" tabindex="-1"></a>                                 gamma,</span>
<span id="cb25-5"><a href="parameter-estimation-techniques-for-hmms.html#cb25-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">delta =</span> <span class="cn">NULL</span>,</span>
<span id="cb25-6"><a href="parameter-estimation-techniques-for-hmms.html#cb25-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">lambda_std_error =</span> <span class="cn">NULL</span>,</span>
<span id="cb25-7"><a href="parameter-estimation-techniques-for-hmms.html#cb25-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">gamma_std_error =</span> <span class="cn">NULL</span>,</span>
<span id="cb25-8"><a href="parameter-estimation-techniques-for-hmms.html#cb25-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">delta_std_error =</span> <span class="cn">NULL</span>) {</span>
<span id="cb25-9"><a href="parameter-estimation-techniques-for-hmms.html#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># gamma_vector_indices is used to calculate the indices of the reordered TPM gamma as</span></span>
<span id="cb25-10"><a href="parameter-estimation-techniques-for-hmms.html#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a vector for reordering the rows of the complete CI data.frame used for the article.</span></span>
<span id="cb25-11"><a href="parameter-estimation-techniques-for-hmms.html#cb25-11" aria-hidden="true" tabindex="-1"></a>  gamma_vector_indices <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>(m <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb25-12"><a href="parameter-estimation-techniques-for-hmms.html#cb25-12" aria-hidden="true" tabindex="-1"></a>  gamma_vector_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(gamma_vector_indices, <span class="at">nrow =</span> m, <span class="at">ncol =</span> m)</span>
<span id="cb25-13"><a href="parameter-estimation-techniques-for-hmms.html#cb25-13" aria-hidden="true" tabindex="-1"></a>  ordered_gamma_vector_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> m, <span class="at">ncol =</span> m)</span>
<span id="cb25-14"><a href="parameter-estimation-techniques-for-hmms.html#cb25-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-15"><a href="parameter-estimation-techniques-for-hmms.html#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the indices of the sorted states</span></span>
<span id="cb25-16"><a href="parameter-estimation-techniques-for-hmms.html#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># according to ascending lambda</span></span>
<span id="cb25-17"><a href="parameter-estimation-techniques-for-hmms.html#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sorted_lambda contains the permutations needed</span></span>
<span id="cb25-18"><a href="parameter-estimation-techniques-for-hmms.html#cb25-18" aria-hidden="true" tabindex="-1"></a>  ordered_lambda_indices <span class="ot">&lt;-</span> <span class="fu">order</span>(lambda)</span>
<span id="cb25-19"><a href="parameter-estimation-techniques-for-hmms.html#cb25-19" aria-hidden="true" tabindex="-1"></a>  ordered_lambda <span class="ot">&lt;-</span> lambda[ordered_lambda_indices]</span>
<span id="cb25-20"><a href="parameter-estimation-techniques-for-hmms.html#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(ordered_lambda) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-21"><a href="parameter-estimation-techniques-for-hmms.html#cb25-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reorder the TPM according to the switched states</span></span>
<span id="cb25-22"><a href="parameter-estimation-techniques-for-hmms.html#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># in the sorted lambda</span></span>
<span id="cb25-23"><a href="parameter-estimation-techniques-for-hmms.html#cb25-23" aria-hidden="true" tabindex="-1"></a>  ordered_gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> m, <span class="at">ncol =</span> m)</span>
<span id="cb25-24"><a href="parameter-estimation-techniques-for-hmms.html#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (col <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb25-25"><a href="parameter-estimation-techniques-for-hmms.html#cb25-25" aria-hidden="true" tabindex="-1"></a>    new_col <span class="ot">&lt;-</span> <span class="fu">which</span>(ordered_lambda_indices <span class="sc">==</span> col)</span>
<span id="cb25-26"><a href="parameter-estimation-techniques-for-hmms.html#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (row <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb25-27"><a href="parameter-estimation-techniques-for-hmms.html#cb25-27" aria-hidden="true" tabindex="-1"></a>      new_row <span class="ot">&lt;-</span> <span class="fu">which</span>(ordered_lambda_indices <span class="sc">==</span> row)</span>
<span id="cb25-28"><a href="parameter-estimation-techniques-for-hmms.html#cb25-28" aria-hidden="true" tabindex="-1"></a>      ordered_gamma[row, col] <span class="ot">&lt;-</span> gamma[new_row, new_col]</span>
<span id="cb25-29"><a href="parameter-estimation-techniques-for-hmms.html#cb25-29" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-30"><a href="parameter-estimation-techniques-for-hmms.html#cb25-30" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Reorder the vector TPM</span></span>
<span id="cb25-31"><a href="parameter-estimation-techniques-for-hmms.html#cb25-31" aria-hidden="true" tabindex="-1"></a>      ordered_gamma_vector_matrix[row, col] <span class="ot">&lt;-</span> gamma_vector_matrix[new_row, new_col]</span>
<span id="cb25-32"><a href="parameter-estimation-techniques-for-hmms.html#cb25-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-33"><a href="parameter-estimation-techniques-for-hmms.html#cb25-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-34"><a href="parameter-estimation-techniques-for-hmms.html#cb25-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Same for the TPM&#39;s standard errors</span></span>
<span id="cb25-35"><a href="parameter-estimation-techniques-for-hmms.html#cb25-35" aria-hidden="true" tabindex="-1"></a>  ordered_gamma_std_error <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-36"><a href="parameter-estimation-techniques-for-hmms.html#cb25-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(gamma_std_error)) {</span>
<span id="cb25-37"><a href="parameter-estimation-techniques-for-hmms.html#cb25-37" aria-hidden="true" tabindex="-1"></a>    ordered_gamma_std_error <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> m, <span class="at">ncol =</span> m)</span>
<span id="cb25-38"><a href="parameter-estimation-techniques-for-hmms.html#cb25-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (col <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb25-39"><a href="parameter-estimation-techniques-for-hmms.html#cb25-39" aria-hidden="true" tabindex="-1"></a>      new_col <span class="ot">&lt;-</span> <span class="fu">which</span>(ordered_lambda_indices <span class="sc">==</span> col)</span>
<span id="cb25-40"><a href="parameter-estimation-techniques-for-hmms.html#cb25-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (row <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb25-41"><a href="parameter-estimation-techniques-for-hmms.html#cb25-41" aria-hidden="true" tabindex="-1"></a>        new_row <span class="ot">&lt;-</span> <span class="fu">which</span>(ordered_lambda_indices <span class="sc">==</span> row)</span>
<span id="cb25-42"><a href="parameter-estimation-techniques-for-hmms.html#cb25-42" aria-hidden="true" tabindex="-1"></a>        ordered_gamma_std_error[row, col] <span class="ot">&lt;-</span> gamma_std_error[new_row, new_col]</span>
<span id="cb25-43"><a href="parameter-estimation-techniques-for-hmms.html#cb25-43" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-44"><a href="parameter-estimation-techniques-for-hmms.html#cb25-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-45"><a href="parameter-estimation-techniques-for-hmms.html#cb25-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-46"><a href="parameter-estimation-techniques-for-hmms.html#cb25-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-47"><a href="parameter-estimation-techniques-for-hmms.html#cb25-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reorder the stationary distribution if it is provided</span></span>
<span id="cb25-48"><a href="parameter-estimation-techniques-for-hmms.html#cb25-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate it otherwise</span></span>
<span id="cb25-49"><a href="parameter-estimation-techniques-for-hmms.html#cb25-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(delta)) {</span>
<span id="cb25-50"><a href="parameter-estimation-techniques-for-hmms.html#cb25-50" aria-hidden="true" tabindex="-1"></a>    ordered_delta <span class="ot">&lt;-</span> <span class="fu">stat.dist</span>(ordered_gamma)</span>
<span id="cb25-51"><a href="parameter-estimation-techniques-for-hmms.html#cb25-51" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb25-52"><a href="parameter-estimation-techniques-for-hmms.html#cb25-52" aria-hidden="true" tabindex="-1"></a>    ordered_delta <span class="ot">&lt;-</span> delta[ordered_lambda_indices]</span>
<span id="cb25-53"><a href="parameter-estimation-techniques-for-hmms.html#cb25-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-54"><a href="parameter-estimation-techniques-for-hmms.html#cb25-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reorder the standard errors</span></span>
<span id="cb25-55"><a href="parameter-estimation-techniques-for-hmms.html#cb25-55" aria-hidden="true" tabindex="-1"></a>  ordered_lambda_std_error <span class="ot">&lt;-</span> lambda_std_error[ordered_lambda_indices]</span>
<span id="cb25-56"><a href="parameter-estimation-techniques-for-hmms.html#cb25-56" aria-hidden="true" tabindex="-1"></a>  ordered_delta_std_error <span class="ot">&lt;-</span> delta_std_error[ordered_lambda_indices]</span>
<span id="cb25-57"><a href="parameter-estimation-techniques-for-hmms.html#cb25-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-58"><a href="parameter-estimation-techniques-for-hmms.html#cb25-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The vector is assumed filled column-wise instead of row-wise,</span></span>
<span id="cb25-59"><a href="parameter-estimation-techniques-for-hmms.html#cb25-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># because column-wise is the default way R handles matrix to vector conversion.</span></span>
<span id="cb25-60"><a href="parameter-estimation-techniques-for-hmms.html#cb25-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Change to row-wise if needed by replacing ordered_gamma_vector_matrix with</span></span>
<span id="cb25-61"><a href="parameter-estimation-techniques-for-hmms.html#cb25-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># t(ordered_gamma_vector_matrix), or add byrow=TRUE</span></span>
<span id="cb25-62"><a href="parameter-estimation-techniques-for-hmms.html#cb25-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># to &quot;ordered_gamma_vector_matrix &lt;- matrix(0, nrow = m, ncol = m)&quot;</span></span>
<span id="cb25-63"><a href="parameter-estimation-techniques-for-hmms.html#cb25-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We don&#39;t use it in case there is a bug, but it makes logical sense that it should work</span></span>
<span id="cb25-64"><a href="parameter-estimation-techniques-for-hmms.html#cb25-64" aria-hidden="true" tabindex="-1"></a>  ordered_gamma_vector_matrix <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(ordered_gamma_vector_matrix)</span>
<span id="cb25-65"><a href="parameter-estimation-techniques-for-hmms.html#cb25-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-66"><a href="parameter-estimation-techniques-for-hmms.html#cb25-66" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">lambda =</span> ordered_lambda,</span>
<span id="cb25-67"><a href="parameter-estimation-techniques-for-hmms.html#cb25-67" aria-hidden="true" tabindex="-1"></a>                 <span class="at">gamma =</span> ordered_gamma,</span>
<span id="cb25-68"><a href="parameter-estimation-techniques-for-hmms.html#cb25-68" aria-hidden="true" tabindex="-1"></a>                 <span class="at">delta =</span> ordered_delta,</span>
<span id="cb25-69"><a href="parameter-estimation-techniques-for-hmms.html#cb25-69" aria-hidden="true" tabindex="-1"></a>                 <span class="at">lambda_std_error =</span> ordered_lambda_std_error,</span>
<span id="cb25-70"><a href="parameter-estimation-techniques-for-hmms.html#cb25-70" aria-hidden="true" tabindex="-1"></a>                 <span class="at">gamma_std_error =</span> ordered_gamma_std_error,</span>
<span id="cb25-71"><a href="parameter-estimation-techniques-for-hmms.html#cb25-71" aria-hidden="true" tabindex="-1"></a>                 <span class="at">delta_std_error =</span> ordered_delta_std_error,</span>
<span id="cb25-72"><a href="parameter-estimation-techniques-for-hmms.html#cb25-72" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ordered_lambda_indices =</span> ordered_lambda_indices,</span>
<span id="cb25-73"><a href="parameter-estimation-techniques-for-hmms.html#cb25-73" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ordered_gamma_vector_indices =</span> ordered_gamma_vector_matrix,</span>
<span id="cb25-74"><a href="parameter-estimation-techniques-for-hmms.html#cb25-74" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># delta and lambda are the same size, so they are ordered the same way</span></span>
<span id="cb25-75"><a href="parameter-estimation-techniques-for-hmms.html#cb25-75" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ordered_delta_indices =</span> ordered_lambda_indices)</span>
<span id="cb25-76"><a href="parameter-estimation-techniques-for-hmms.html#cb25-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-77"><a href="parameter-estimation-techniques-for-hmms.html#cb25-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove the NULL elements</span></span>
<span id="cb25-78"><a href="parameter-estimation-techniques-for-hmms.html#cb25-78" aria-hidden="true" tabindex="-1"></a>  result[<span class="fu">sapply</span>(result, is.null)] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-79"><a href="parameter-estimation-techniques-for-hmms.html#cb25-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-80"><a href="parameter-estimation-techniques-for-hmms.html#cb25-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb25-81"><a href="parameter-estimation-techniques-for-hmms.html#cb25-81" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We will go through an example to better understand the process.
For readability, the TPM is filled with standard row and column indices instead of probabilities.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="parameter-estimation-techniques-for-hmms.html#cb26-1" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb26-2"><a href="parameter-estimation-techniques-for-hmms.html#cb26-2" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>,</span>
<span id="cb26-3"><a href="parameter-estimation-techniques-for-hmms.html#cb26-3" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">21</span>, <span class="dv">22</span>, <span class="dv">23</span>,</span>
<span id="cb26-4"><a href="parameter-estimation-techniques-for-hmms.html#cb26-4" aria-hidden="true" tabindex="-1"></a>                  <span class="dv">31</span>, <span class="dv">32</span>, <span class="dv">33</span>), <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb26-5"><a href="parameter-estimation-techniques-for-hmms.html#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">pois.HMM.label.order</span>(<span class="at">m =</span> <span class="dv">3</span>, lambda, gamma)</span>
<span id="cb26-6"><a href="parameter-estimation-techniques-for-hmms.html#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="do">## $lambda</span></span>
<span id="cb26-7"><a href="parameter-estimation-techniques-for-hmms.html#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1 2 3</span></span>
<span id="cb26-8"><a href="parameter-estimation-techniques-for-hmms.html#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb26-9"><a href="parameter-estimation-techniques-for-hmms.html#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="do">## $gamma</span></span>
<span id="cb26-10"><a href="parameter-estimation-techniques-for-hmms.html#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="do">##      [,1] [,2] [,3]</span></span>
<span id="cb26-11"><a href="parameter-estimation-techniques-for-hmms.html#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [1,]   33   31   32</span></span>
<span id="cb26-12"><a href="parameter-estimation-techniques-for-hmms.html#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="do">## [2,]   13   11   12</span></span>
<span id="cb26-13"><a href="parameter-estimation-techniques-for-hmms.html#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [3,]   23   21   22</span></span>
<span id="cb26-14"><a href="parameter-estimation-techniques-for-hmms.html#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb26-15"><a href="parameter-estimation-techniques-for-hmms.html#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="do">## $delta</span></span>
<span id="cb26-16"><a href="parameter-estimation-techniques-for-hmms.html#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.3482817 0.3183850 0.3333333</span></span>
<span id="cb26-17"><a href="parameter-estimation-techniques-for-hmms.html#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb26-18"><a href="parameter-estimation-techniques-for-hmms.html#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="do">## $ordered_lambda_indices</span></span>
<span id="cb26-19"><a href="parameter-estimation-techniques-for-hmms.html#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 2 3 1</span></span>
<span id="cb26-20"><a href="parameter-estimation-techniques-for-hmms.html#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb26-21"><a href="parameter-estimation-techniques-for-hmms.html#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="do">## $ordered_gamma_vector_indices</span></span>
<span id="cb26-22"><a href="parameter-estimation-techniques-for-hmms.html#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 9 7 8 3 1 2 6 4 5</span></span>
<span id="cb26-23"><a href="parameter-estimation-techniques-for-hmms.html#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb26-24"><a href="parameter-estimation-techniques-for-hmms.html#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="do">## $ordered_delta_indices</span></span>
<span id="cb26-25"><a href="parameter-estimation-techniques-for-hmms.html#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 2 3 1</span></span></code></pre></div>
<p>State 1 has been relabeled state 3, state 3 became state 2, and state 2 became state 1.</p>
<p>Another way to address this issue is by parameterizing in terms of non-negative increments <span class="math inline">\(\lambda_j - \lambda_{j-1}\)</span> with <span class="math inline">\(\lambda_0 \equiv 0\)</span>, as explained by <span class="citation"><a href="references.html#ref-zucchini" role="doc-biblioref">Zucchini, MacDonald, and Langrock</a> (<a href="references.html#ref-zucchini" role="doc-biblioref">2016, sec. 7.1.1</a> p. 112)</span>.
However, <span class="citation"><a href="references.html#ref-bulla" role="doc-biblioref">Bulla and Berzel</a> (<a href="references.html#ref-bulla" role="doc-biblioref">2008, sec. 3.2</a> p. 7)</span> shows this can impose optimization issues: “over all series, the simplest parameterization, i.e., the use of log-transformed state-dependent parameters, leads to the best results as regards the number of failures and the convergence to the global maximum.”</p>
<p>These utility functions or subroutines are not complicated, but as you can see, they would cloud up your main code.
Therefore, we put them in functions we can call from our main program.</p>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="principles-of-using-tmb-for-mle.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="using-tmb.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
