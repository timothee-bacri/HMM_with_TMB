# Normal HMM

Gaussian HMMs with TMB are very similar to the previous Poisson HMM.
The main changes are the distribution parameters being changed from $\bs{\lambda}$ to $\bs{\mu}$ and $\bs{\sigma}$.
In turn, these cause the density function to change from `dpois` to `dnorm` (and from `rpois` to `rnorm` for simulations).

Many functions available in *[functions/utils.R](#utils.R)* have been adapted for the Gaussian case in *[functions/norm_utils.R](#norm_utils.R)*.

We detail below an example of a Gaussian HMM with TMB.
The dataset we show in this example contains log-returns of the SP500 dataset pulled from Yahoo finances.
These log-returns are generated with the following code.
```{r eval = FALSE}
library(dplyr)
# Loading the sp500 dataset
SP500 <- read_csv("data/S&P500.csv") %>%
  mutate(lag = lag(`Adj Close`),
         lr = log(`Adj Close`/lag)) %>%
  dplyr::select(lr) %>%
  drop_na()
SP500 <- 100 * SP500$lr
save(SP500, file = "data/SP500.RData")
```

The Gaussian negative log-likelihood in TMB can be coded as
```{Rcpp 7norm_hmm.cpp, code=readLines("code/norm_hmm.cpp"), eval=FALSE}
```

and requires the following utility functions.
```{Rcpp 7norm_utils.cpp, code=readLines("functions/norm_utils.cpp"), eval=FALSE}
```

The following R code illustrates how to compute the estimates and standard errors, using the objective function written above.
```{r}
source("code/packages.R")
source("functions/norm_utils.R")

TMB::compile("code/norm_hmm.cpp")
dyn.load(dynlib("code/norm_hmm"))

# Parameters and covariates
load("data/SP500.RData")
mu <- c(-2 * mean(SP500), 2 * mean(SP500))
sigma <- c(0.5 * sd(SP500), 2 * sd(SP500))
gamma <- matrix(c(0.9, 0.1,
                  0.1, 0.9), nrow = 2, byrow = TRUE)

# Parameters & covariates for TMB ------------------
working_params <- norm.HMM.pn2pw(m = m, mu = mu, sigma = sigma, gamma = gamma)
TMB_data <- list(x = SP500, m = m)
obj <- MakeADFun(TMB_data, working_params, DLL = "norm_hmm", silent = TRUE)

# Estimation
obj_tmb <- MakeADFun(TMB_data, working_params, DLL = "norm_hmm", silent = TRUE)
mod_tmb <- nlminb(start = obj_tmb$par, objective = obj_tmb$fn,
                  gradient = obj_tmb$gr, hessian = obj_tmb$he)

summary(sdreport(obj_tmb), "report")
```

As could be expected, the low positive mean is associated with with a low variance whereas the larger mean is negative and tied to a higher variance.
Note that the TPM is displayed column-wise.

A more readable view of the estimates can be displayed with
```{r}
obj_tmb$report()
```

In order to work on the C++ objective function, it is required to unload the DLL.
This can be achieved with
```{r}
dyn.unload(dynlib("code/norm_hmm"))
```
or by restarting the R session.

The warning can be suppressed if desired via
```{r eval = FALSE}
sink(file = nullfile())
dyn.unload(dynlib("code/norm_hmm"))
sink()
```
Be careful, as the sink function will divert all messages to the `file` specified, including errors.
`nullfile()` points to a file that cannot contain anything (`/dev/null` on Linux distributions).
Make sure to end it with `sink()` when you are done!

